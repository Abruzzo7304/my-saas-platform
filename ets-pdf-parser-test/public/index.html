<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.15);
        }

        .fab:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .fab-icon {
            color: white;
            font-size: 24px;
            font-weight: bold;
            line-height: 1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform;
            -webkit-transform: translate(-50%, -50%) scale(0.9);
        }

        .modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
            -webkit-transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .modal-title {
            font-size: 2rem;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .modal-subtitle {
            font-size: 1rem;
            margin: 0;
            opacity: 0.9;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Background Content Styles */
        .background-content {
            width: 100%;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .background-content.modal-active {
            filter: blur(4px) grayscale(50%);
            pointer-events: none;
            opacity: 0.6;
        }

        .header-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* PDF History Styles */
        .pdf-history {
            padding: 32px 24px 48px;
            max-width: 960px;
            margin: 0 auto;
        }

        .pdf-history-list {
            display: flex;
            flex-direction: column;
        }

        .pdf-history-empty {
            padding: 40px;
            text-align: center;
            color: #64748b;
            background: white;
            border-radius: 12px;
            border: 1px dashed rgba(148, 163, 184, 0.5);
        }

        .pdf-filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .sort-dropdown {
            position: relative;
        }

        .sort-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-button:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }

        .sort-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .sort-dropdown-menu.show {
            display: block;
        }

        .sort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 0.9rem;
        }

        .sort-option:hover {
            background: #f8fafc;
        }

        .sort-option.active {
            background: #eef2ff;
            color: #6366f1;
            font-weight: 600;
        }

        .sort-option-check {
            color: #6366f1;
            font-weight: bold;
        }

        .filter-buttons {
            display: inline-flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(99, 102, 241, 0.35);
            background: white;
            color: #4338ca;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        .filter-button:hover {
            background: #eef2ff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .filter-button.active {
            background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35);
        }

        .filter-count-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            min-width: 28px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.15);
            color: #4338ca;
            font-size: 0.75rem;
        }

        .filter-button.active .filter-count-pill {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .filter-summary {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #475569;
        }

        .filter-summary span {
            font-weight: 600;
            color: #1f2937;
        }

        .filter-summary-divider {
            color: rgba(148, 163, 184, 0.7);
            font-weight: 400;
        }

        .pdf-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            margin-bottom: 12px;
            background: white;
            border-radius: 12px;
            border: 2px solid;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .pdf-row.urgency-standard {
            border-color: #e2e8f0;
        }

        .pdf-row.urgency-urgent {
            border-color: #fbbf24;
        }

        .pdf-row.urgency-critical {
            border-color: #ef4444;
        }

        .pdf-row:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
        }

        .pdf-row.urgency-standard:hover {
            border-color: #94a3b8;
        }

        .pdf-row.urgency-urgent:hover {
            border-color: #f59e0b;
        }

        .pdf-row.urgency-critical:hover {
            border-color: #dc2626;
        }

        .pdf-row.status-committed {
            opacity: 0.65;
        }

        .pdf-row.status-committed .pdf-name {
            color: #64748b;
            font-weight: 500;
        }

        .pdf-row.status-committed .pdf-meta {
            color: #94a3b8;
        }

        .pdf-row.status-committed:hover {
            opacity: 0.8;
        }

        .pdf-row:last-child {
            margin-bottom: 0;
        }

        .pdf-row-status {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .pdf-row-status.review {
            background: #f59e0b;
        }

        .pdf-row-status.processing {
            background: #3b82f6;
        }

        .pdf-row-status.committed {
            background: #10b981;
        }

        .pdf-row-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pdf-row-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
        }

        .pdf-title-block {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-name {
            font-size: 1.05rem;
            font-weight: 600;
            color: #0f172a;
            line-height: 1.4;
        }

        .pdf-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .pdf-meta-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .pdf-meta-divider {
            color: rgba(148, 163, 184, 0.6);
        }

        .pdf-tags {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: white;
        }


        .confidence-high {
            background: #10b981;
        }

        .confidence-medium {
            background: #f59e0b;
        }

        .confidence-low {
            background: #ef4444;
        }

        .pdf-chevron {
            color: #94a3b8;
            font-size: 1.5rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .pdf-row:hover .pdf-chevron {
            color: #6366f1;
            transform: translateX(4px);
        }

        /* PDF Viewer Modal */
        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pdf-viewer-modal.show {
            opacity: 1;
        }

        .pdf-viewer-content {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        }

        .pdf-viewer-header {
            background: #1f2937;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-viewer-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .pdf-viewer-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .pdf-viewer-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pdf-viewer-body {
            flex: 1;
            display: flex;
        }

        .pdf-panel {
            flex: 1;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .pdf-panel:last-child {
            border-right: none;
        }

        .pdf-panel-header {
            background: #f8fafc;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
        }

        .pdf-frame {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
        }

        /* Parsed Fields Panel */
        .parsed-fields-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .parsed-fields-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .field-section {
            margin-bottom: 30px;
        }

        .field-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .field-group {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .field-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-input {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            color: #1f2937;
            background: white;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .field-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .field-input.modified {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .field-input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .field-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .field-confidence {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 4px;
        }

        .confidence-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .field-actions {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .changes-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #f59e0b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .changes-indicator.show {
            display: flex;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-section, .results-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .upload-zone {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #f9fafb;
        }

        .upload-zone:hover {
            border-color: #6366f1;
            background: #f0f9ff;
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: #ecfdf5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #374151;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .processing-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .processing-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .processing-item.success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .processing-item.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .processing-item.processing {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .filename {
            font-weight: 600;
            color: #1f2937;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.success {
            background: #10b981;
            color: white;
        }

        .status.error {
            background: #ef4444;
            color: white;
        }

        .status.processing {
            background: #f59e0b;
            color: white;
        }

        .job-details {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .fab {
                bottom: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
            }

            .fab-icon {
                font-size: 20px;
            }

            .modal-content {
                width: 98%;
                max-height: 95vh;
                border-radius: 12px;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .modal-subtitle {
                font-size: 0.9rem;
            }

            .modal-body {
                padding: 20px;
                max-height: calc(95vh - 120px);
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .upload-section, .results-section {
                padding: 20px;
            }

            .upload-zone {
                padding: 40px 20px;
            }

            .upload-icon {
                font-size: 2.5rem;
            }

            .upload-text {
                font-size: 1rem;
            }

            /* Background content responsive */
            .header-bar {
                padding: 16px 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-stats {
                gap: 20px;
            }

            .main-title {
                font-size: 1.5rem;
            }

            .pdf-history {
                padding: 24px 16px 40px;
            }

            .pdf-filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .filter-buttons {
                justify-content: center;
            }

            .sort-dropdown-menu {
                right: auto;
                left: 0;
                min-width: 100%;
            }

            .pdf-row {
                gap: 12px;
                padding: 16px 18px;
            }

            .pdf-row-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .pdf-tags {
                width: 100%;
            }

            .confidence-badge {
                font-size: 0.75rem;
            }

            .pdf-chevron {
                align-self: flex-end;
                margin-top: -20px;
            }

            .pdf-viewer-content {
                top: 2%;
                left: 2%;
                width: 96%;
                height: 96%;
            }

            .pdf-viewer-body {
                flex-direction: column;
            }

            .pdf-panel {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .pdf-panel:last-child {
                border-bottom: none;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
                transform: translate(-50%, -50%) scale(1);
                -webkit-transform: translate(-50%, -50%) scale(1);
            }

            .modal.show .modal-content {
                transform: translate(-50%, -50%) scale(1);
                -webkit-transform: translate(-50%, -50%) scale(1);
            }

            .modal-body {
                padding: 16px;
                max-height: calc(100vh - 100px);
                -webkit-overflow-scrolling: touch;
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .upload-zone {
                padding: 30px 15px;
                touch-action: manipulation;
            }

            .upload-icon {
                font-size: 2rem;
            }

            .upload-text {
                font-size: 0.9rem;
            }

            .upload-subtext {
                font-size: 0.8rem;
            }
        }

        /* Additional touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .fab {
                width: 64px;
                height: 64px;
            }

            .fab-icon {
                font-size: 28px;
            }

            .modal-close {
                width: 48px;
                height: 48px;
                font-size: 32px;
            }

            .upload-zone {
                min-height: 120px;
                touch-action: manipulation;
            }
        }

        @media (max-height: 600px) {
            .modal-content {
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
            }

            .modal-body {
                max-height: calc(100vh - 80px);
            }
        }
    </style>
</head>
<body>
    <!-- Background Content -->
    <div class="background-content" id="backgroundContent">
        <div class="header-bar">
            <h1 class="main-title">Work Order Converter</h1>
            <div class="header-stats">
                <span class="stat-item">
                    <span class="stat-value" id="totalProcessedHeader">24</span>
                    <span class="stat-label">Converted today</span>
                </span>
                <span class="stat-item">
                    <span class="stat-value" id="avgConfidenceHeader">87%</span>
                    <span class="stat-label">Avg confidence</span>
                </span>
            </div>
        </div>

        <div class="pdf-history">
            <div class="pdf-filter-bar">
                <div class="filter-controls">
                    <div class="filter-buttons" id="pdfFilterButtons" role="group" aria-label="Filter files by status">
                        <button class="filter-button active" data-filter="all">All files</button>
                        <button class="filter-button" data-filter="review">Needs review</button>
                        <button class="filter-button" data-filter="processing">Converting</button>
                        <button class="filter-button" data-filter="committed">Sent to ServiceM8</button>
                    </div>
                    <div class="sort-dropdown">
                        <button class="sort-button" id="sortButton">
                            <span id="sortLabel">Sort by date</span>
                            <span>↓</span>
                        </button>
                        <div class="sort-dropdown-menu" id="sortDropdown">
                            <div class="sort-option active" data-sort="date-desc">
                                <span>Newest first</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                            <div class="sort-option" data-sort="date-asc">
                                <span>Oldest first</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                            <div class="sort-option" data-sort="confidence-desc">
                                <span>Highest confidence</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                            <div class="sort-option" data-sort="confidence-asc">
                                <span>Lowest confidence</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                            <div class="sort-option" data-sort="name-asc">
                                <span>Name A-Z</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                            <div class="sort-option" data-sort="urgency-desc">
                                <span>Most urgent</span>
                                <span class="sort-option-check">✓</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-summary" id="filterSummary" aria-live="polite">
                    Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span> work orders
                    <span class="filter-summary-divider" aria-hidden="true">•</span>
                    <span id="activeFilterLabel">All files</span>
                </div>
            </div>
            <div class="pdf-history-list" id="pdfHistory">
                <!-- PDF rows will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fabButton">
        <span class="fab-icon">+</span>
    </button>

    <!-- Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title">Upload PDFs</h1>
                <p class="modal-subtitle">Convert PDFs into ServiceM8 work orders</p>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUploaded">0</div>
                        <div class="stat-label">Uploaded</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProcessed">0</div>
                        <div class="stat-label">Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalFailed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalFiles">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="upload-section">
                        <h2 style="margin-bottom: 20px; color: #1f2937;">Upload PDFs</h2>

                        <div class="upload-zone" id="uploadZone">
                            <input type="file" class="file-input" id="fileInput" accept=".pdf" multiple>
                            <div class="upload-icon">📄</div>
                            <div class="upload-text">Drop PDF files here or click to browse</div>
                            <div class="upload-subtext">Convert PDFs to ServiceM8 work orders</div>
                        </div>

                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <div>Processing pdf...</div>
                        </div>
                    </div>

                    <div class="results-section">
                        <h2 style="margin-bottom: 20px; color: #1f2937;">Conversion results</h2>

                        <div class="processing-list" id="processingList">
                            <div style="text-align: center; color: #6b7280; padding: 40px;">
                                No work orders converted yet. Upload PDFs to get started.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-modal" id="pdfViewerModal">
        <div class="pdf-viewer-content">
            <div class="pdf-viewer-header">
                <h3 class="pdf-viewer-title" id="pdfViewerTitle">PDF Comparison</h3>
                <button class="pdf-viewer-close" id="pdfViewerClose">&times;</button>
            </div>
            <div class="pdf-viewer-body">
                <div class="pdf-panel">
                    <div class="pdf-panel-header">Original PDF</div>
                    <iframe class="pdf-frame" id="originalPdfFrame" src=""></iframe>
                </div>
                <div class="parsed-fields-panel">
                    <div class="pdf-panel-header">
                        Parsed Fields
                        <div class="changes-indicator" id="changesIndicator">
                            <span>●</span>
                            <span>Unsaved changes</span>
                        </div>
                    </div>
                    <div class="parsed-fields-content" id="parsedFieldsContent">
                        <!-- Fields will be dynamically generated here -->
                    </div>
                    <div class="field-actions">
                        <button class="btn btn-secondary" id="resetFieldsBtn">Reset</button>
                        <button class="btn btn-primary" id="saveFieldsBtn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const fabButton = document.getElementById('fabButton');
        const pdfModal = document.getElementById('pdfModal');
        const modalClose = document.getElementById('modalClose');
        const backgroundContent = document.getElementById('backgroundContent');
        const pdfHistory = document.getElementById('pdfHistory');
        const pdfViewerModal = document.getElementById('pdfViewerModal');
        const pdfViewerClose = document.getElementById('pdfViewerClose');
        const pdfViewerTitle = document.getElementById('pdfViewerTitle');
        const originalPdfFrame = document.getElementById('originalPdfFrame');
        const processedPdfFrame = document.getElementById('processedPdfFrame');

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const processingList = document.getElementById('processingList');
        const filterButtonsContainer = document.getElementById('pdfFilterButtons');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const filterSummary = document.getElementById('filterSummary');
        const activeFilterLabel = document.getElementById('activeFilterLabel');

        // Stats elements
        const totalUploaded = document.getElementById('totalUploaded');
        const totalProcessed = document.getElementById('totalProcessed');
        const totalFailed = document.getElementById('totalFailed');
        const totalFiles = document.getElementById('totalFiles');

        // Sorting and filtering elements
        const sortButton = document.getElementById('sortButton');
        const sortDropdown = document.getElementById('sortDropdown');
        const sortLabel = document.getElementById('sortLabel');

        // Mock data for PDF history
        const filterOptions = {
            all: { label: 'All files' },
            review: { label: 'Needs review' },
            processing: { label: 'Converting' },
            committed: { label: 'Sent to ServiceM8' }
        };

        const statusPresentation = {
            review: { label: 'Needs review' },
            processing: { label: 'Converting' },
            committed: { label: 'Sent to ServiceM8' }
        };

        const sortOptions = {
            'date-desc': { label: 'Newest first' },
            'date-asc': { label: 'Oldest first' },
            'confidence-desc': { label: 'Highest confidence' },
            'confidence-asc': { label: 'Lowest confidence' },
            'name-asc': { label: 'Name A-Z' },
            'urgency-desc': { label: 'Most urgent' }
        };

        let activePdfFilter = 'all';
        let activeSortOption = 'date-desc';

        const mockPdfData = [
            {
                name: "MaintenancePro_WorkOrder_001.pdf",
                pages: 3,
                confidence: 94,
                processedAt: new Date(),
                status: 'review',
                urgency: 'Critical',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "ServiceM8 Job Details": {
                        "job_description": { value: "Electrical panel upgrade and circuit installation", confidence: 95, type: "textarea" },
                        "job_priority": { value: "High", confidence: 92 },
                        "category_name": { value: "Electrical", confidence: 96 },
                        "job_type": { value: "Installation", confidence: 94 }
                    },
                    "Customer Details": {
                        "company_name": { value: "ABC Manufacturing Corp", confidence: 94 },
                        "first_name": { value: "John", confidence: 91 },
                        "last_name": { value: "Smith", confidence: 89 },
                        "mobile": { value: "+1 (555) 123-4567", confidence: 87 },
                        "email": { value: "john.smith@abcmfg.com", confidence: 91 }
                    },
                    "Site Address": {
                        "site_address": { value: "1234 Industrial Blvd, Suite 100", confidence: 93 },
                        "site_city": { value: "Denver", confidence: 97 },
                        "site_state": { value: "Colorado", confidence: 95 },
                        "site_postcode": { value: "80202", confidence: 94 }
                    },
                    "Scheduling": {
                        "job_date": { value: "2024-09-25", confidence: 88 },
                        "start_time": { value: "09:00", confidence: 85 },
                        "duration": { value: "4", confidence: 82 }
                    }
                }
            },
            {
                name: "FieldServicePro_Maintenance_002.pdf",
                pages: 7,
                confidence: 87,
                processedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                status: 'processing',
                urgency: 'Urgent',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "ServiceM8 Job Details": {
                        "job_description": { value: "Preventive maintenance and equipment inspection", confidence: 88, type: "textarea" },
                        "job_priority": { value: "Medium", confidence: 91 },
                        "category_name": { value: "Maintenance", confidence: 94 },
                        "job_type": { value: "Service", confidence: 96 }
                    },
                    "Customer Details": {
                        "company_name": { value: "PowerTech Industries", confidence: 89 },
                        "first_name": { value: "Sarah", confidence: 88 },
                        "last_name": { value: "Williams", confidence: 85 },
                        "mobile": { value: "+1 (555) 987-6543", confidence: 83 },
                        "email": { value: "sarah.williams@powertech.com", confidence: 87 }
                    },
                    "Equipment Information": {
                        "equipment_model": { value: "PowerMax 5000", confidence: 89 },
                        "serial_number": { value: "PM5K-2023-8901", confidence: 85 },
                        "last_service": { value: "2024-03-15", confidence: 79 },
                        "warranty_status": { value: "Active", confidence: 83 }
                    },
                    "Work Notes": {
                        "findings": { value: "Minor wear on contacts, oil levels adequate, all safety systems functioning normally.", confidence: 76, type: "textarea" },
                        "recommendations": { value: "Replace contact points within 90 days. Schedule oil analysis before next service.", confidence: 71, type: "textarea" }
                    }
                }
            },
            {
                name: "TechSpec_Installation_Guide_003.pdf",
                pages: 12,
                confidence: 76,
                processedAt: new Date(Date.now() - 24 * 60 * 60 * 1000),
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Technical Specifications": {
                        "productModel": { value: "ETS-Pro 3000X", confidence: 82 },
                        "voltage": { value: "480V 3-Phase", confidence: 78 },
                        "amperage": { value: "200A", confidence: 74 },
                        "frequency": { value: "60Hz", confidence: 85 }
                    },
                    "Installation Requirements": {
                        "minimumClearance": { value: "36 inches", confidence: 71 },
                        "ambientTemperature": { value: "-10°C to +40°C", confidence: 68 },
                        "enclosureRating": { value: "NEMA 4X", confidence: 79 },
                        "mountingType": { value: "Wall Mount", confidence: 76 }
                    },
                    "Compliance": {
                        "standards": { value: "UL 508A, CSA C22.2, IEC 61439", confidence: 73, type: "textarea" },
                        "certifications": { value: "CE Mark, FCC Class A", confidence: 69 }
                    }
                }
            },
            {
                name: "ServiceDeck_MaintenanceLog_004.pdf",
                pages: 5,
                confidence: 91,
                processedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Maintenance Log": {
                        "logNumber": { value: "ML-2024-3456", confidence: 95 },
                        "facilityName": { value: "North Plant Facility", confidence: 93 },
                        "maintenanceDate": { value: "2024-09-20", confidence: 91 },
                        "maintenanceType": { value: "Scheduled Inspection", confidence: 89 }
                    },
                    "Personnel": {
                        "leadTechnician": { value: "Sarah Williams", confidence: 92 },
                        "assistantTech": { value: "Tom Rodriguez", confidence: 88 },
                        "supervisor": { value: "David Chen", confidence: 94 },
                        "totalHours": { value: "4.5", confidence: 86 }
                    },
                    "Summary": {
                        "workCompleted": { value: "Completed quarterly inspection of all electrical panels, tested emergency systems, verified proper operation of safety interlocks.", confidence: 84, type: "textarea" },
                        "nextAction": { value: "Schedule replacement of Panel B breakers within 30 days", confidence: 87 }
                    }
                }
            },
            {
                name: "WorkflowMax_Install_Guide_005.pdf",
                pages: 18,
                confidence: 68,
                processedAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                status: 'processing',
                urgency: 'Urgent',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Installation Guide": {
                        "productName": { value: "Smart Grid Controller", confidence: 72 },
                        "modelNumber": { value: "SGC-2024-Pro", confidence: 69 },
                        "firmwareVersion": { value: "v2.1.4", confidence: 65 },
                        "installationDate": { value: "2024-09-19", confidence: 71 }
                    },
                    "System Requirements": {
                        "operatingSystem": { value: "Linux-based embedded", confidence: 63 },
                        "memoryRequired": { value: "8GB RAM minimum", confidence: 66 },
                        "storageSpace": { value: "128GB SSD", confidence: 68 },
                        "networkProtocol": { value: "Modbus TCP/IP", confidence: 64 }
                    },
                    "Configuration": {
                        "defaultIP": { value: "192.168.1.100", confidence: 70 },
                        "defaultLogin": { value: "admin/password123", confidence: 58 },
                        "setupInstructions": { value: "Connect Ethernet cable, power on device, access web interface using default credentials, follow setup wizard", confidence: 61, type: "textarea" }
                    }
                }
            },
            {
                name: "InspectionPro_Safety_Report_006.pdf",
                pages: 4,
                confidence: 85,
                processedAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Safety Inspection": {
                        "inspectionID": { value: "SI-2024-7890", confidence: 89 },
                        "inspectorName": { value: "Robert Martinez", confidence: 87 },
                        "inspectionDate": { value: "2024-09-18", confidence: 90 },
                        "facilityType": { value: "Manufacturing", confidence: 83 }
                    },
                    "Safety Checklist": {
                        "emergencyExits": { value: "Clear and marked", confidence: 86 },
                        "fireExtinguishers": { value: "Inspected and charged", confidence: 88 },
                        "firstAidStations": { value: "Stocked and accessible", confidence: 84 },
                        "eyewashStations": { value: "Functional and clean", confidence: 81 }
                    },
                    "Findings": {
                        "violations": { value: "None found", confidence: 92 },
                        "recommendations": { value: "Add additional lighting in stairwell B, update emergency evacuation signage in break room area", confidence: 78, type: "textarea" },
                        "nextInspection": { value: "2025-03-18", confidence: 85 }
                    }
                }
            },
            {
                name: "AuditPro_Compliance_Report_007.pdf",
                pages: 15,
                confidence: 79,
                processedAt: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000), // 12 days ago
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Compliance Audit": {
                        "auditID": { value: "CA-2024-4567", confidence: 91 },
                        "auditorName": { value: "Jennifer Lee", confidence: 88 },
                        "auditDate": { value: "2024-09-10", confidence: 93 },
                        "complianceLevel": { value: "Satisfactory", confidence: 82 }
                    },
                    "Standards Review": {
                        "isoCompliance": { value: "ISO 9001:2015", confidence: 85 },
                        "osha": { value: "29 CFR 1910", confidence: 78 },
                        "localCodes": { value: "Denver Building Code 2021", confidence: 74 },
                        "certificationStatus": { value: "Current", confidence: 87 }
                    },
                    "Recommendations": {
                        "actionItems": { value: "Update emergency procedures documentation, schedule quarterly safety training refresh", confidence: 76, type: "textarea" },
                        "nextAudit": { value: "2025-03-10", confidence: 89 }
                    }
                }
            },
            {
                name: "ReportGen_Quarterly_Summary_008.pdf",
                pages: 22,
                confidence: 88,
                processedAt: new Date(Date.now() - 52 * 24 * 60 * 60 * 1000), // ~7.5 weeks ago
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
                parsedFields: {
                    "Quarterly Report": {
                        "reportID": { value: "QR-2024-Q3", confidence: 94 },
                        "reportingPeriod": { value: "Q3 2024", confidence: 96 },
                        "preparedBy": { value: "Finance Department", confidence: 91 },
                        "reviewDate": { value: "2024-08-01", confidence: 89 }
                    },
                    "Financial Summary": {
                        "totalRevenue": { value: "$2,847,392", confidence: 87 },
                        "operatingExpenses": { value: "$1,923,485", confidence: 84 },
                        "netProfit": { value: "$923,907", confidence: 86 },
                        "growthRate": { value: "12.3%", confidence: 81 }
                    },
                    "Key Metrics": {
                        "customerSatisfaction": { value: "94.2%", confidence: 83 },
                        "projectCompletion": { value: "98.7%", confidence: 88 },
                        "safetyIncidents": { value: "0", confidence: 95 }
                    }
                }
            }
        ];

        let pdfRecords = [...mockPdfData];

        function normalizeUrgency(value) {
            if (!value) return 'standard';
            const normalized = value.toString().toLowerCase();
            if (normalized.includes('critical')) return 'critical';
            if (normalized.includes('urgent')) return 'urgent';
            return 'standard';
        }

        function getUrgencyScore(urgency) {
            const scores = { critical: 3, urgent: 2, standard: 1 };
            return scores[urgency] || 1;
        }

        function sortPdfRecords(records, sortBy) {
            const sorted = [...records];

            switch (sortBy) {
                case 'date-desc':
                    return sorted.sort((a, b) => new Date(b.processedAt) - new Date(a.processedAt));
                case 'date-asc':
                    return sorted.sort((a, b) => new Date(a.processedAt) - new Date(b.processedAt));
                case 'confidence-desc':
                    return sorted.sort((a, b) => (b.confidence || 0) - (a.confidence || 0));
                case 'confidence-asc':
                    return sorted.sort((a, b) => (a.confidence || 0) - (b.confidence || 0));
                case 'name-asc':
                    return sorted.sort((a, b) => a.name.localeCompare(b.name));
                case 'urgency-desc':
                    return sorted.sort((a, b) => {
                        const urgencyA = getUrgencyScore(normalizeUrgency(a.urgency));
                        const urgencyB = getUrgencyScore(normalizeUrgency(b.urgency));
                        return urgencyB - urgencyA;
                    });
                default:
                    return sorted;
            }
        }

        function computeStatusCounts() {
            const counts = { all: pdfRecords.length, review: 0, processing: 0, committed: 0 };

            pdfRecords.forEach(pdf => {
                const statusKey = pdf.status || 'review';
                if (counts[statusKey] === undefined) {
                    counts[statusKey] = 0;
                }
                counts[statusKey] += 1;
            });

            return counts;
        }

        function updateFilterButtons() {
            if (!filterButtonsContainer) return;

            const counts = computeStatusCounts();
            const buttons = Array.from(filterButtonsContainer.querySelectorAll('.filter-button'));

            buttons.forEach(button => {
                const filter = button.getAttribute('data-filter') || 'all';
                const option = filterOptions[filter];
                if (!option) return;

                const count = counts[filter] ?? 0;
                button.innerHTML = `${option.label}<span class="filter-count-pill" aria-hidden="true">${count}</span>`;
                button.setAttribute('aria-label', `${option.label} (${count} files)`);

                if (filter === activePdfFilter) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            if (activeFilterLabel) {
                const activeOption = filterOptions[activePdfFilter] || filterOptions.all;
                activeFilterLabel.textContent = activeOption.label;
            }

            if (totalCount) {
                totalCount.textContent = counts.all.toString();
            }
        }

        // Date formatting function
        function formatRelativeDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            const timeString = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            if (diffHours < 24) {
                return `Today ${timeString}`;
            } else if (diffDays === 1) {
                return `Yesterday ${timeString}`;
            } else if (diffDays < 7) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                return `${dayName} ${timeString}`;
            } else {
                // More than a week ago - include the full date
                const dateString = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                });
                return `${dateString} ${timeString}`;
            }
        }

        function formatAbsoluteDate(date) {
            const datePart = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const timePart = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            return `${datePart} ${timePart}`;
        }

        // Generate confidence class based on percentage
        function getConfidenceClass(confidence) {
            if (confidence >= 85) return 'confidence-high';
            if (confidence >= 70) return 'confidence-medium';
            return 'confidence-low';
        }

        // Generate PDF history rows
        function generatePdfHistory() {
            if (!pdfHistory) return;

            pdfHistory.innerHTML = '';

            const filteredRecords = activePdfFilter === 'all'
                ? pdfRecords
                : pdfRecords.filter(pdf => (pdf.status || 'review') === activePdfFilter);

            const sortedRecords = sortPdfRecords(filteredRecords, activeSortOption);

            if (visibleCount) {
                visibleCount.textContent = sortedRecords.length.toString();
            }

            if (sortedRecords.length === 0) {
                pdfHistory.innerHTML = '<div class="pdf-history-empty">No work orders in this stage yet. Choose another filter or upload a new PDF.</div>';
                return;
            }

            sortedRecords.forEach((pdf, index) => {
                const row = document.createElement('div');
                const statusKey = pdf.status || 'review';
                const urgencyKey = normalizeUrgency(pdf.urgency);

                row.className = `pdf-row urgency-${urgencyKey} status-${statusKey}`;
                row.setAttribute('data-index', index.toString());

                const statusInfo = statusPresentation[statusKey] || statusPresentation.review;
                const absoluteDate = formatAbsoluteDate(pdf.processedAt);

                const metaPieces = [`Processed ${formatRelativeDate(pdf.processedAt)}`];
                if (pdf.pages && pdf.pages > 0) {
                    metaPieces.push(`${pdf.pages} pages`);
                }

                const metaHtml = metaPieces.map((piece, idx) => {
                    const prefix = idx === 0 ? '' : '<span class="pdf-meta-divider" aria-hidden="true">•</span>';
                    return `${prefix}<span class="pdf-meta-item">${piece}</span>`;
                }).join('');

                row.innerHTML = `
                    <div class="pdf-row-status ${statusKey}" title="${statusInfo.label}"></div>
                    <div class="pdf-row-body">
                        <div class="pdf-row-header">
                            <div class="pdf-title-block">
                                <div class="pdf-name">${pdf.name}</div>
                                <div class="pdf-meta" title="Processed ${absoluteDate}">
                                    ${metaHtml}
                                </div>
                            </div>
                            <div class="pdf-tags">
                                <span class="confidence-badge ${getConfidenceClass(pdf.confidence)}">
                                    ${pdf.confidence}% confidence
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="pdf-chevron" aria-hidden="true">›</div>
                `;

                row.dataset.status = statusKey;
                row.setAttribute('role', 'button');
                row.setAttribute('tabindex', '0');
                row.setAttribute('aria-label', `View parsed details for ${pdf.name}`);

                row.addEventListener('click', () => openPdfViewer(pdf));
                row.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
                        event.preventDefault();
                        openPdfViewer(pdf);
                    }
                });

                pdfHistory.appendChild(row);
            });
        }

        function addPdfRecord(filename, result) {
            const existingIndex = pdfRecords.findIndex(record => record.name === filename);
            if (existingIndex !== -1) {
                pdfRecords.splice(existingIndex, 1);
            }

            const pages = result?.workOrder?.pdfMetadata?.pageCount
                ?? result?.workOrder?.pageCount
                ?? result?.workOrder?.pages
                ?? result?.workOrder?.page_total
                ?? result?.workOrder?.totalPages
                ?? 1;

            const confidenceRaw = result?.workOrder?.confidenceScore
                ?? result?.serviceM8Job?.confidence
                ?? result?.confidence;

            const confidence = confidenceRaw ? Math.round(confidenceRaw) : 0;

            pdfRecords.unshift({
                name: filename,
                pages,
                confidence,
                processedAt: new Date(),
                status: 'review',
                urgency: normalizeUrgency(result?.workOrder?.urgency || result?.urgency || 'standard'),
                originalUrl: `/view-pdf/${filename}`,
                parsedFields: result?.workOrder?.parsedFields || {}
            });

            updateFilterButtons();
            generatePdfHistory();
        }

        // Filter button event listener
        if (filterButtonsContainer) {
            filterButtonsContainer.addEventListener('click', (event) => {
                if (!(event.target instanceof Element)) return;
                const target = event.target.closest('.filter-button');
                if (!target) return;
                const filter = target.getAttribute('data-filter');
                if (!filter || activePdfFilter === filter) return;
                activePdfFilter = filter;
                updateFilterButtons();
                generatePdfHistory();
            });
        }

        // Sort dropdown functionality
        function updateSortLabel() {
            if (sortLabel) {
                const option = sortOptions[activeSortOption];
                sortLabel.textContent = option ? option.label : 'Sort by date';
            }
        }

        function updateSortOptions() {
            if (!sortDropdown) return;

            const options = sortDropdown.querySelectorAll('.sort-option');
            options.forEach(option => {
                const sortValue = option.getAttribute('data-sort');
                const checkElement = option.querySelector('.sort-option-check');

                if (sortValue === activeSortOption) {
                    option.classList.add('active');
                    if (checkElement) checkElement.style.display = 'inline';
                } else {
                    option.classList.remove('active');
                    if (checkElement) checkElement.style.display = 'none';
                }
            });
        }

        // Sort button event listeners
        if (sortButton && sortDropdown) {
            sortButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sortDropdown.classList.toggle('show');
            });

            sortDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                const target = e.target.closest('.sort-option');
                if (!target) return;

                const sortValue = target.getAttribute('data-sort');
                if (sortValue && sortValue !== activeSortOption) {
                    activeSortOption = sortValue;
                    updateSortLabel();
                    updateSortOptions();
                    generatePdfHistory();
                }
                sortDropdown.classList.remove('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                if (sortDropdown) {
                    sortDropdown.classList.remove('show');
                }
            });
        }

        // Modal functionality
        function openModal() {
            pdfModal.style.display = 'block';
            backgroundContent.classList.add('modal-active');
            setTimeout(() => {
                pdfModal.classList.add('show');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            pdfModal.classList.remove('show');
            backgroundContent.classList.remove('modal-active');
            setTimeout(() => {
                pdfModal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }

        // Variables for field editing
        let currentPdfData = null;
        let originalFieldValues = {};
        let hasUnsavedChanges = false;

        // PDF Viewer functionality
        function openPdfViewer(pdf) {
            currentPdfData = pdf;
            pdfViewerTitle.textContent = pdf.name;
            const pdfSource = pdf.originalUrl || `/view-pdf/${pdf.name}`;
            originalPdfFrame.src = pdfSource;

            generateParsedFields(pdf.parsedFields);
            storeOriginalValues(pdf.parsedFields);
            hasUnsavedChanges = false;
            updateChangesIndicator();

            pdfViewerModal.style.display = 'block';
            setTimeout(() => {
                pdfViewerModal.classList.add('show');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        // Store original field values for reset functionality
        function storeOriginalValues(parsedFields) {
            originalFieldValues = {};
            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                originalFieldValues[sectionName] = {};
                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    originalFieldValues[sectionName][fieldName] = fieldData.value;
                }
            }
        }

        // Generate parsed fields display
        function generateParsedFields(parsedFields) {
            const parsedFieldsContent = document.getElementById('parsedFieldsContent');
            parsedFieldsContent.innerHTML = '';

            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                const section = document.createElement('div');
                section.className = 'field-section';

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'field-section-title';
                sectionTitle.textContent = sectionName;
                section.appendChild(sectionTitle);

                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';

                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'field-item';

                    const label = document.createElement('div');
                    label.className = 'field-label';
                    label.textContent = formatFieldLabel(fieldName);

                    const inputType = fieldData.type === 'textarea' ? 'textarea' : 'input';
                    const input = document.createElement(inputType);
                    input.className = `field-input ${inputType === 'textarea' ? 'field-textarea' : ''}`;
                    input.value = fieldData.value;
                    input.setAttribute('data-section', sectionName);
                    input.setAttribute('data-field', fieldName);

                    if (inputType === 'input') {
                        input.type = 'text';
                    }

                    const confidenceSpan = document.createElement('div');
                    confidenceSpan.className = `field-confidence ${getConfidenceClass(fieldData.confidence)}`;
                    confidenceSpan.innerHTML = `
                        <span class="confidence-indicator ${getConfidenceClass(fieldData.confidence)}"></span>
                        ${fieldData.confidence}% confidence
                    `;

                    // Add event listener for field changes
                    input.addEventListener('input', (e) => handleFieldChange(e, fieldData.value));

                    fieldItem.appendChild(label);
                    fieldItem.appendChild(input);
                    fieldItem.appendChild(confidenceSpan);
                    fieldGroup.appendChild(fieldItem);
                }

                section.appendChild(fieldGroup);
                parsedFieldsContent.appendChild(section);
            }
        }

        // Format field labels for display
        function formatFieldLabel(fieldName) {
            return fieldName
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        // Handle field value changes
        function handleFieldChange(event, originalValue) {
            const input = event.target;
            const currentValue = input.value;
            const isModified = currentValue !== originalValue;

            if (isModified) {
                input.classList.add('modified');
                hasUnsavedChanges = true;
            } else {
                input.classList.remove('modified');
                // Check if any other fields are modified
                hasUnsavedChanges = document.querySelectorAll('.field-input.modified').length > 0;
            }

            updateChangesIndicator();
        }

        // Update changes indicator
        function updateChangesIndicator() {
            const changesIndicator = document.getElementById('changesIndicator');
            if (hasUnsavedChanges) {
                changesIndicator.classList.add('show');
            } else {
                changesIndicator.classList.remove('show');
            }
        }

        // Reset fields to original values
        function resetFields() {
            if (!currentPdfData) return;

            const inputs = document.querySelectorAll('.field-input');
            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');
                const originalValue = originalFieldValues[section][field];

                input.value = originalValue;
                input.classList.remove('modified');
            });

            hasUnsavedChanges = false;
            updateChangesIndicator();
        }

        // Save field changes
        function saveFields() {
            if (!currentPdfData || !hasUnsavedChanges) return;

            const inputs = document.querySelectorAll('.field-input.modified');
            const updates = {};

            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');

                if (!updates[section]) {
                    updates[section] = {};
                }
                updates[section][field] = input.value;

                // Update the original data
                currentPdfData.parsedFields[section][field].value = input.value;
                input.classList.remove('modified');
            });

            // Store new original values
            storeOriginalValues(currentPdfData.parsedFields);
            hasUnsavedChanges = false;
            updateChangesIndicator();

            // Show success message (you could replace this with a toast notification)
            alert('Changes saved successfully!');

            console.log('Saved field updates:', updates);
        }

        function closePdfViewer() {
            // Check for unsaved changes
            if (hasUnsavedChanges) {
                const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
                if (!confirmClose) {
                    return;
                }
            }

            pdfViewerModal.classList.remove('show');
            setTimeout(() => {
                pdfViewerModal.style.display = 'none';
                document.body.style.overflow = '';
                originalPdfFrame.src = '';

                // Clear field data
                currentPdfData = null;
                originalFieldValues = {};
                hasUnsavedChanges = false;
                const parsedFieldsContent = document.getElementById('parsedFieldsContent');
                parsedFieldsContent.innerHTML = '';
            }, 300);
        }

        // Event listeners for modal
        fabButton.addEventListener('click', openModal);
        modalClose.addEventListener('click', closeModal);

        // Event listeners for PDF viewer
        pdfViewerClose.addEventListener('click', closePdfViewer);

        // Event listeners for field editing
        document.getElementById('resetFieldsBtn').addEventListener('click', resetFields);
        document.getElementById('saveFieldsBtn').addEventListener('click', saveFields);

        // Close modals when clicking outside
        pdfModal.addEventListener('click', (e) => {
            if (e.target === pdfModal) {
                closeModal();
            }
        });

        pdfViewerModal.addEventListener('click', (e) => {
            if (e.target === pdfViewerModal) {
                closePdfViewer();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (pdfViewerModal.classList.contains('show')) {
                    closePdfViewer();
                } else if (pdfModal.classList.contains('show')) {
                    closeModal();
                }
            }
        });

        // Upload zone event listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            updateFilterButtons();
            updateSortLabel();
            updateSortOptions();
            generatePdfHistory();
        });

        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            if (files.length > 0) {
                processFiles(files);
            } else {
                alert('Please upload pdf files only.');
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }

        async function processFiles(files) {
            loading.style.display = 'block';
            
            for (const file of files) {
                await uploadFile(file);
            }
            
            loading.style.display = 'none';
            await updateStats();
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdfFile', file);

            // Add processing item to list
            const itemId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            addProcessingItem(itemId, file.name, 'processing');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    updateProcessingItem(itemId, 'success', result.result, file.name);
                    addPdfRecord(file.name, result.result);
                } else {
                    updateProcessingItem(itemId, 'error', { error: result.error }, file.name);
                }

            } catch (error) {
                updateProcessingItem(itemId, 'error', { error: error.message }, file.name);
            }
        }

function updateProcessingItem(id, status, result, originalFilename) {
    const item = document.getElementById(id);
    if (!item) return;

    item.className = `processing-item ${status}`;
    const statusElement = item.querySelector('.status');
    statusElement.className = `status ${status}`;
    statusElement.textContent = status.toUpperCase();

    const previewElement = item.querySelector('.job-preview');
    const buttonContainer = item.querySelector('.button-container');
    
    if (status === 'success' && result.serviceM8Job) {
        const preview = result.serviceM8Job.job_description.substring(0, 200) + '...';
        previewElement.textContent = preview;
        previewElement.style.display = 'block';
        
        // Store result data for viewer
        item.dataset.result = JSON.stringify(result);
        const fileLabel = originalFilename || result.filename || 'processed.pdf';
        item.dataset.filename = fileLabel;
        
        // Create single button container with both buttons
        buttonContainer.innerHTML = `
            <button class="view-btn" onclick="viewPDF('${id}')" style="
                background: #6366f1;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                margin-right: 8px;
            ">View details</button>
            <a href="/view-pdf/${fileLabel}" target="_blank" style="
                display: inline-block;
                background: #ef4444;
                color: white;
                text-decoration: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.8rem;
            ">View pdf</a>
        `;
        buttonContainer.style.display = 'block';
        
    } else if (status === 'error') {
        previewElement.textContent = `Error: ${result.error}`;
        previewElement.style.display = 'block';
        previewElement.style.color = '#dc2626';
    }
}
        async function updateStats() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                
                totalUploaded.textContent = stats.uploaded;
                totalProcessed.textContent = stats.processed;
                totalFailed.textContent = stats.failed;
                totalFiles.textContent = stats.total;
                
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        // Update stats on page load
        updateStats();
        
        // Auto-refresh stats every 30 seconds
        setInterval(updateStats, 30000);
    </script>
</body>
</html>
