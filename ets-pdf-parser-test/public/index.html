<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .fab-icon {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        /* PDF History Rows */
        .pdf-history {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pdf-row {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .pdf-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pdf-row.urgency-standard {
            border-color: #e2e8f0;
        }

        .pdf-row.urgency-urgent {
            border-color: #fbbf24;
        }

        .pdf-row.urgency-critical {
            border-color: #ef4444;
        }

        .pdf-row-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .pdf-row-info {
            flex: 1;
        }

        .pdf-row-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .pdf-row-meta {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 0.9rem;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.review { background-color: #f59e0b; }
        .status-dot.processing { background-color: #3b82f6; }
        .status-dot.committed { background-color: #10b981; }

        .chevron {
            color: #9ca3af;
            font-size: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        /* PDF Viewer Modal */
        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pdf-viewer-modal.show {
            opacity: 1;
        }

        .pdf-viewer-content {
            position: absolute;
            top: 3%;
            left: 3%;
            width: 94%;
            height: 94%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 100px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .pdf-viewer-modal.show .pdf-viewer-content {
            transform: scale(1);
        }

        .pdf-viewer-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pdf-viewer-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-viewer-title::before {
            content: "üìÑ";
            font-size: 1.1rem;
        }

        .pdf-viewer-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .pdf-viewer-close:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .pdf-viewer-body {
            flex: 1;
            display: flex;
            min-height: 0;
            overflow: hidden;
        }

        .pdf-panel {
            flex: 1;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .pdf-panel:last-child {
            border-right: none;
        }

        .pdf-panel-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 24px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-panel-header.original {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
        }

        .pdf-panel-header.fields {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .pdf-frame {
            border: none;
            width: 100%;
            height: 100%;
        }

        /* Parsed Fields Panel */
        .parsed-fields-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafbfc;
            min-height: 0;
            overflow: hidden;
        }

        .parsed-fields-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: white;
            margin: 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            min-height: 0;
            height: 100%;
        }

        .field-section {
            margin-bottom: 16px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }

        .field-section:last-child {
            margin-bottom: 0;
        }

        /* Quick Review Section */
        .quick-review-section {
            margin-bottom: 20px;
        }

        .quick-review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #e8f4f8;
            border: 2px solid #4a90a4;
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
            font-size: 1rem;
            font-weight: 600;
            color: #2c5aa0;
        }

        .quick-review-icon {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .quick-review-toggle {
            font-size: 0.8rem;
            color: #666;
        }

        .quick-review-cards {
            border: 2px solid #4a90a4;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: white;
        }

        .quick-review-card {
            border-bottom: 1px solid #e0e0e0;
            padding: 16px;
        }

        .quick-review-card:last-child {
            border-bottom: none;
        }

        .quick-review-card-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .quick-review-card-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .company-name, .order-number, .site-details, .job-summary, .budget-info, .time-constraints {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.4;
            flex: 1;
            margin-right: 12px;
        }

        .urgency-input-box {
            width: 200px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            margin-right: 12px;
        }

        .confidence-dots {
            color: #00b8a9;
            font-size: 0.6rem;
            letter-spacing: 1px;
            white-space: nowrap;
        }


        .urgency-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .urgency-header {
            margin-bottom: 8px;
        }

        .urgency-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .urgency-level.critical {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .urgency-level.urgent {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }

        .urgency-level.standard {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #86efac;
        }

        .urgency-details {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .urgency-response, .urgency-scheduling {
            margin-bottom: 4px;
            color: #374151;
        }

        .urgency-note {
            color: #dc2626;
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.75rem;
        }

        .time-constraints-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .time-constraints-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: #92400e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .time-constraints-content {
            font-size: 0.8rem;
            line-height: 1.4;
            color: #374151;
        }

        .field-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            padding: 8px 6px 6px 6px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .field-section-title:hover {
            background-color: #f1f5f9;
        }

        .field-section-title::after {
            content: "‚ñº";
            margin-left: auto;
            font-size: 0.7rem;
            transition: transform 0.2s ease;
            color: #64748b;
        }

        .field-section.collapsed .field-section-title::after {
            transform: rotate(-90deg);
        }

        .field-section-title::before {
            content: "‚öôÔ∏è";
            font-size: 0.8rem;
        }

        .field-section[data-section="Source Company"] .field-section-title::before {
            content: "üè¢";
        }

        .field-section[data-section="Company Details"] .field-section-title::before {
            content: "üìû";
        }

        .field-section[data-section="Work Order Details"] .field-section-title::before {
            content: "üìã";
        }


        .field-section[data-section="Site Contact"] .field-section-title::before {
            content: "üè†";
        }

        .field-section[data-section="Work Order Issuer"] .field-section-title::before {
            content: "üë®‚Äçüíº";
        }

        .field-section[data-section="Job Location"] .field-section-title::before {
            content: "üìç";
        }

        .field-section[data-section="QR Code Data"] .field-section-title::before {
            content: "üì±";
        }

        .field-section[data-section="Work Notes & Checklists"] .field-section-title::before {
            content: "üìã";
        }

        .field-section[data-section="ServiceM8 API Fields"] .field-section-title::before {
            content: "üîß";
        }

        .field-group {
            display: grid;
            gap: 8px;
            margin-bottom: 0;
            transition: all 0.3s ease;
            overflow: visible;
            position: relative;
        }

        .field-section.collapsed .field-group {
            max-height: 0;
            margin-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        .field-section:not(.collapsed) .field-group {
            max-height: 2000px;
            opacity: 1;
        }

        .field-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }

        .field-item:hover {
            border-color: #c7d2fe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .field-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .field-input {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #1e293b;
            background: #f8fafc;
            transition: all 0.2s ease;
            font-family: inherit;
            border: 1px solid transparent;
        }

        .field-input:focus {
            outline: none;
            background: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.1);
        }

        .field-input.modified {
            background: #fef3c7;
            border-color: #f59e0b;
            position: relative;
        }

        .field-input.modified::after {
            content: "‚úèÔ∏è";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
        }

        .field-input.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .field-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .field-select {
            /* Reset all appearance */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;

            /* Basic styling */
            width: 100%;
            max-width: 100%;
            padding: 6px 28px 6px 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #1e293b;
            background-color: #f8fafc;
            font-family: inherit;
            cursor: pointer;

            /* Custom dropdown arrow */
            background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzZCNzI4MCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;

            /* Ensure proper box model */
            box-sizing: border-box;
            outline: none;
        }

        .field-select:focus {
            background-color: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.1);
        }

        .field-select:hover {
            background-color: #f1f5f9;
        }

        .field-select option {
            background-color: white;
            color: #1e293b;
            padding: 8px 12px;
        }

        /* Force clean dropdown styling for document type specifically */
        select[data-field="document_type"] {
            background: #f8fafc !important;
            border: 1px solid transparent !important;
            width: 100% !important;
            max-width: 100% !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: url("data:image/svg+xml;charset=utf-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 8px center !important;
            background-repeat: no-repeat !important;
            background-size: 16px !important;
            padding: 6px 28px 6px 10px !important;
            font-size: 0.85rem !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }

        .servicem8-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            margin-left: auto;
            margin-right: 12px;
        }

        .servicem8-badge svg {
            width: 14px;
            height: 14px;
        }

        .field-confidence {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 4px;
        }

        .confidence-scale {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .confidence-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .confidence-dot.filled {
            background-color: #10b981;
        }

        .confidence-dot.empty {
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
        }

        .field-confidence.high .confidence-dot.filled { background-color: #10b981; }
        .field-confidence.medium .confidence-dot.filled { background-color: #f59e0b; }
        .field-confidence.low .confidence-dot.filled { background-color: #ef4444; }

        .field-actions {
            background: white;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-icon {
            font-size: 1rem;
        }

        .changes-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
            animation: pulse 2s infinite;
        }

        .changes-indicator.show {
            opacity: 1;
            transform: translateX(-50%);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .fab {
                bottom: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
            }

            .fab-icon {
                font-size: 20px;
            }

            .modal-content {
                width: 98%;
                max-height: 95vh;
                border-radius: 12px;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .modal-subtitle {
                font-size: 0.9rem;
            }

            .modal-body {
                padding: 20px;
                max-height: calc(95vh - 120px);
            }

            .pdf-viewer-content {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                transform: scale(1);
            }

            .pdf-viewer-modal.show .pdf-viewer-content {
                transform: scale(1);
            }

            .pdf-viewer-header {
                padding: 16px 20px;
            }

            .pdf-viewer-title {
                font-size: 1.1rem;
            }

            .pdf-viewer-body {
                flex-direction: column;
            }

            .pdf-panel {
                border-right: none;
                border-bottom: 2px solid #e5e7eb;
                height: 40%;
            }

            .parsed-fields-panel {
                height: 60%;
                border-bottom: none;
            }

            .pdf-panel-header {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .parsed-fields-content {
                padding: 16px;
                max-height: none;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .field-section {
                margin-bottom: 12px;
                padding: 10px;
            }

            .field-section-title {
                font-size: 0.9rem;
                padding: 6px 4px 4px 4px;
                margin-bottom: 6px;
            }

            .field-section-title::after {
                font-size: 0.6rem;
            }

            .field-group {
                margin-bottom: 8px;
            }

            .field-item {
                padding: 6px 8px;
                margin-bottom: 6px;
            }

            .field-label {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }

            .field-input, .field-textarea {
                font-size: 14px !important;
                padding: 6px 8px;
            }

            .field-textarea {
                min-height: 60px;
            }

            .changes-indicator {
                top: 16px;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 12px;
                font-size: 0.75rem;
                border-radius: 16px;
            }

            .changes-indicator.show {
                transform: translateX(-50%);
            }

            .field-actions {
                padding: 16px;
                gap: 12px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .btn-icon {
                margin-right: 6px;
            }

            .pdf-row {
                padding: 16px;
                margin-bottom: 12px;
            }

            .pdf-row-content {
                gap: 12px;
            }

            .pdf-row-meta {
                font-size: 0.8rem;
                gap: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .pdf-viewer-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .pdf-viewer-header {
                padding: 12px 16px;
            }

            .pdf-viewer-title {
                font-size: 1rem;
            }

            .pdf-panel {
                height: 35%;
            }

            .parsed-fields-panel {
                height: 65%;
            }

            .pdf-panel-header {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .parsed-fields-content {
                padding: 12px;
                max-height: calc(65vh - 70px);
            }

            .field-section {
                margin-bottom: 16px;
                padding: 12px;
            }

            .field-card {
                padding: 10px;
                margin-bottom: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .changes-indicator {
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
                padding: 4px 8px;
                font-size: 0.7rem;
                border-radius: 12px;
            }

            .changes-indicator.show {
                transform: translateX(-50%);
            }

            .fab {
                bottom: 12px;
                left: 12px;
                width: 44px;
                height: 44px;
            }

            .fab-icon {
                font-size: 18px;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .pdf-viewer-body {
                flex-direction: row;
            }

            .pdf-panel {
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
                height: 100%;
                width: 50%;
            }

            .parsed-fields-panel {
                height: 100%;
                width: 50%;
                border-bottom: none;
            }

            .parsed-fields-content {
                max-height: calc(100vh - 140px);
            }
        }
    </style>
</head>
<body>
    <!-- Background Content -->
    <div class="background-content" id="backgroundContent">
        <div class="page-header">
            <h1 class="main-title">Work Order Converter</h1>
            <p class="subtitle">Convert third-party PDFs to ServiceM8 work orders</p>
        </div>

        <!-- PDF History -->
        <div class="pdf-history" id="pdfHistory"></div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fabButton">
        <span class="fab-icon">+</span>
    </button>

    <!-- PDF Processing Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">üì§ Upload Work Orders</h2>
                    <p class="modal-subtitle">Convert PDFs to ServiceM8 jobs</p>
                </div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Upload modal content would go here...</p>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-modal" id="pdfViewerModal">
        <div class="pdf-viewer-content">
            <div class="pdf-viewer-header">
                <h3 class="pdf-viewer-title" id="pdfViewerTitle">Work Order Details</h3>
                <button class="pdf-viewer-close" id="pdfViewerClose">&times;</button>
            </div>
            <div class="pdf-viewer-body">
                <div class="pdf-panel">
                    <div class="pdf-panel-header original">üìÑ Original PDF</div>
                    <iframe class="pdf-frame" id="originalPdfFrame" src=""></iframe>
                </div>
                <div class="parsed-fields-panel">
                    <div class="pdf-panel-header fields">
                        üìù ServiceM8 Work Order Fields
                        <div class="servicem8-badge">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="9"/>
                            </svg>
                            Ready for ServiceM8
                        </div>
                    </div>
                    <div class="parsed-fields-content" id="parsedFieldsContent">
                        <!-- Fields will be dynamically generated here -->
                    </div>
                    <div class="field-actions">
                        <button class="btn btn-primary" id="saveFieldsBtn">
                            <span class="btn-icon">üöÄ</span>
                            Create Job in ServiceM8
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements - with null checks
        const fabButton = document.getElementById('fabButton');
        const pdfModal = document.getElementById('pdfModal');
        const modalClose = document.getElementById('modalClose');
        const backgroundContent = document.getElementById('backgroundContent');
        const pdfHistory = document.getElementById('pdfHistory');
        const pdfViewerModal = document.getElementById('pdfViewerModal');
        const pdfViewerClose = document.getElementById('pdfViewerClose');
        const pdfViewerTitle = document.getElementById('pdfViewerTitle');
        const originalPdfFrame = document.getElementById('originalPdfFrame');


        // Reference work orders for production use
        const referenceWorkOrders = [
            {
                name: "PO1540-RP01-001_2 Tarcoola Ln Uki.pdf",
                pages: 1,
                confidence: 95,
                processedAt: new Date(),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "http://localhost:8080/pdfs/PO1540-RP01-001_2%20Tarcoola%20Ln%20Uki.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO1540-RP01-001", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Assessment", confidence: 95 },
                        "job_description": { value: "Please attend site to assess x1 chest freezer and dishwasher that was damaged after an electrical storm", confidence: 94, type: "textarea" },
                        "date_issued": { value: "10 Jun 2024", confidence: 96 },
                        "assigned_to": { value: "SUSTAINE ELECTRICAL & SOLAR", confidence: 98 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Robert S", confidence: 95 },
                        "last": { value: "Mitchell", confidence: 95 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0412261044", confidence: 94 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98, type: "textarea" },
                        "site_city": { value: "Uki", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2484", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.3667", confidence: 85 },
                        "longitude": { value: "153.3167", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=PO1540-RP01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "Work Notes & Checklists": {
                        "parsing_rules_applied": { value: "ETS standard electrical assessment protocol", confidence: 99, type: "textarea" },
                        "safety_requirements": { value: "‚Ä¢ Complete risk assessment before site entry\n‚Ä¢ Verify power isolation procedures\n‚Ä¢ Use PPE as per ETS safety guidelines", confidence: 95, type: "textarea" },
                        "work_checklist": { value: "‚òê Site risk assessment completed\n‚òê Visual inspection of damaged appliances\n‚òê Electrical testing performed\n‚òê Test results documented\n‚òê Customer sign-off obtained", confidence: 90, type: "textarea" },
                        "compliance_notes": { value: "Work to be completed in accordance with AS/NZS 3760:2010 - In-service safety inspection and testing of electrical equipment", confidence: 85, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "8a8ac91d-4d8a-47b6-8935-205aa57e3beb", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98 },
                        "billing_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-06-10", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Electrical assessment of storm-damaged appliances", confidence: 92 },
                        "generated_job_id": { value: "1", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2024-06-10 15:08", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.3167", confidence: 85 },
                        "job_lat": { value: "-28.3667", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2484", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Uki", confidence: 98 },
                        "geo_street": { value: "Tarcoola Ln", confidence: 98 },
                        "geo_number": { value: "2", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "1", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "category_uuid": { value: "", confidence: 0 },
                        "queue_uuid": { value: "", confidence: 0 },
                        "quote_expiry_date": { value: "", confidence: 0 },
                        "quote_sent": { value: "false", confidence: 95, type: "select", options: ["true", "false"] },
                        "invoice_sent": { value: "false", confidence: 95, type: "select", options: ["true", "false"] },
                        "purchase_order_number": { value: "PO1540-RP01-001", confidence: 99 },
                        "job_description": { value: "Electrical Report - Storm damage assessment", confidence: 94, type: "textarea" },
                        "created_by_staff_uuid": { value: "dadb2bd3-a039-47bf-8716", confidence: 85 }
                    }
                }
            },
            {
                name: "PO8057-BU01-001_upgraded.pdf",
                pages: 3,
                confidence: 88,
                processedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                status: 'processing',
                urgency: 'Urgent',
                originalUrl: "http://localhost:8080/pdfs/PO8057-BU01-001_upgraded.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO8057-BU01-001", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Multi-Trade Services", confidence: 95 },
                        "job_description": { value: "Remove and replace damaged Clip-lok wall sheets, carpet cleaning, electrical downlights, and general repairs", confidence: 92, type: "textarea" },
                        "date_issued": { value: "3 Jul 2025", confidence: 96 },
                        "assigned_to": { value: "Sustaine Electrical & Solar", confidence: 98 },
                        "total_amount": { value: "$13,263.57", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Woollam Constructions", confidence: 98 }
                    },
                    "Site Contact": {
                        "first": { value: "Anna T", confidence: 96 },
                        "last": { value: "BOSTON", confidence: 96 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0402 254 758", confidence: 94 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98, type: "textarea" },
                        "site_city": { value: "Armidale", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2350", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-30.5128", confidence: 85 },
                        "longitude": { value: "151.6669", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=PO8057-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "7b9bc82e-5e9b-48c7-9a46-316bb68f4cec", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98 },
                        "billing_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98 },
                        "job_status": { value: "Work Order", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2025-07-03", confidence: 96 },
                        "work_order_date": { value: "2025-07-03", confidence: 96 },
                        "work_done_description": { value: "Multi-trade repairs: wall sheets, carpet cleaning, electrical, general repairs", confidence: 92 },
                        "generated_job_id": { value: "2", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "13263.57", confidence: 94 },
                        "edit_date": { value: "2025-07-03 14:22", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.6669", confidence: 85 },
                        "job_lat": { value: "-30.5128", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2350", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Armidale", confidence: 98 },
                        "geo_street": { value: "Dumaresq St", confidence: 98 },
                        "geo_number": { value: "233", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "13263.57", confidence: 94 },
                        "purchase_order_number": { value: "PO8057-BU01-001", confidence: 99 },
                        "job_description": { value: "Multi-trade repairs: wall sheets, carpet cleaning, electrical", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "QR9973-BU01-001.pdf",
                pages: 3,
                confidence: 89,
                processedAt: new Date(Date.now() - 24 * 60 * 60 * 1000),
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "http://localhost:8080/pdfs/QR9973-BU01-001.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "QR9973-BU01-001", confidence: 99 },
                        "document_type": { value: "Quote Request", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Multi-Trade Services", confidence: 95 },
                        "job_description": { value: "Carpentry, electrical, certification, general trades - roof repairs and solar panel work", confidence: 90, type: "textarea" },
                        "date_issued": { value: "16 Jul 2025", confidence: 96 },
                        "assigned_to": { value: "Sustaine Electrical & Solar", confidence: 98 },
                        "reference": { value: "9973", confidence: 97 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Woollam Constructions", confidence: 98 }
                    },
                    "Site Contact": {
                        "first": { value: "Olive", confidence: 96 },
                        "last": { value: "Boston", confidence: 96 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98, type: "textarea" },
                        "site_city": { value: "Armidale", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2350", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-30.5169", confidence: 85 },
                        "longitude": { value: "151.6747", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=QR9973-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "9c0de93f-6f0c-59d8-0b57-427cc79g5ded", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98 },
                        "billing_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2025-07-16", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Multi-trade construction: carpentry, electrical, certification, roof repairs, solar work", confidence: 90 },
                        "generated_job_id": { value: "3", confidence: 89 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2025-07-16 09:15", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.6747", confidence: 85 },
                        "job_lat": { value: "-30.5169", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2350", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Armidale", confidence: 98 },
                        "geo_street": { value: "Beardy St", confidence: 98 },
                        "geo_number": { value: "286", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "purchase_order_number": { value: "QR9973-BU01-001", confidence: 99 },
                        "job_description": { value: "Multi-trade construction: carpentry, electrical, certification, roof repairs, solar work", confidence: 90, type: "textarea" }
                    }
                }
            },
            {
                name: "PO38935_Farmcote.pdf",
                pages: 1,
                confidence: 96,
                processedAt: new Date(Date.now() - 12 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "http://localhost:8080/pdfs/PO38935_Farmcote.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Highforce Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO38935", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Installation", confidence: 95 },
                        "job_description": { value: "Supply and install 10m of 25mm¬≤ armoured cable for shed connection at Farmcote property", confidence: 94, type: "textarea" },
                        "date_issued": { value: "15 Sep 2024", confidence: 96 },
                        "assigned_to": { value: "Highforce Electrical Team", confidence: 98 },
                        "total_amount": { value: "$2,450.00", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "Sarah", confidence: 95 },
                        "last_name": { value: "Mitchell", confidence: 95 },
                        "email": { value: "sarah@highforce.com.au", confidence: 98 },
                        "phone": { value: "0420 524 997", confidence: 98 },
                        "role": { value: "Project Manager", confidence: 96 },
                        "company": { value: "Highforce Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "David", confidence: 96 },
                        "last": { value: "Farmcote", confidence: 96 },
                        "type": { value: "PROPERTY_MANAGER", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0487 621 334", confidence: 94 },
                        "email": { value: "david@farmcote.com.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98, type: "textarea" },
                        "site_city": { value: "Uki", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2484", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.3667", confidence: 85 },
                        "longitude": { value: "153.3167", confidence: 85 }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "9c0dc93f-6f0c-49d8-9b57-427cc79g5dfd", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98 },
                        "billing_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-09-15", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Electrical cable installation for shed connection", confidence: 92 },
                        "generated_job_id": { value: "5", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "2450.00", confidence: 94 },
                        "edit_date": { value: "2024-09-15 10:30", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "58g3h554-45c7-5b26-955c-316bb79h6gge", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.3167", confidence: 85 },
                        "job_lat": { value: "-28.3667", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2484", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Uki", confidence: 98 },
                        "geo_street": { value: "Kyogle Road", confidence: 98 },
                        "geo_number": { value: "1247", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "2450.00", confidence: 94 },
                        "purchase_order_number": { value: "PO38935", confidence: 99 },
                        "job_description": { value: "Supply and install armoured cable for shed connection", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "Jobcard_For_Job_No_58815.pdf",
                pages: 2,
                confidence: 94,
                processedAt: new Date(Date.now() - 6 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "http://localhost:8080/pdfs/Jobcard_For_Job_No_58815.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "O'Brien Electrical & Plumbing Lismore", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "58815", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Repair", confidence: 95 },
                        "job_description": { value: "TV screen not operating - investigate and repair electrical fault", confidence: 94, type: "textarea" },
                        "date_issued": { value: "22 Sep 2024", confidence: 96 },
                        "assigned_to": { value: "O'Brien Electrical Team", confidence: 98 },
                        "work_limit": { value: "$300", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "Lisa", confidence: 95 },
                        "last_name": { value: "O'Brien", confidence: 95 },
                        "email": { value: "lisa@obrienelectrical.com.au", confidence: 98 },
                        "phone": { value: "02 6621 3399", confidence: 98 },
                        "role": { value: "Office Manager", confidence: 96 },
                        "company": { value: "O'Brien Electrical & Plumbing Lismore", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Reception", confidence: 85 },
                        "last": { value: "Desk", confidence: 85 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "02 6620 1911", confidence: 94 },
                        "email": { value: "reception@lifeblood.com.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98, type: "textarea" },
                        "site_city": { value: "Lismore", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2480", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.8122", confidence: 85 },
                        "longitude": { value: "153.2778", confidence: 85 },
                        "venue_name": { value: "Lifeblood Lismore Donor Centre", confidence: 96 }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "ad3ef45g-7h8i-50j9-ak6l-538dd90m7nop", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98 },
                        "billing_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98 },
                        "job_status": { value: "Work Order", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-09-22", confidence: 96 },
                        "work_order_date": { value: "2024-09-22", confidence: 96 },
                        "work_done_description": { value: "Electrical repair - TV screen not operating", confidence: 92 },
                        "generated_job_id": { value: "4", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2024-09-22 14:30", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "68h4i665-56d8-6c37-a66d-427dd80i7hhf", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.2778", confidence: 85 },
                        "job_lat": { value: "-28.8122", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2480", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Lismore", confidence: 98 },
                        "geo_street": { value: "Bounty Street", confidence: 98 },
                        "geo_number": { value: "1/26", confidence: 95 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "purchase_order_number": { value: "3391", confidence: 99 },
                        "job_description": { value: "Electrical repair - TV screen not operating", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "QR11604-BU01-001_66 Wollombi Rd Cessnock NSW 2325.pdf",
                pages: 2,
                confidence: 92,
                processedAt: new Date(Date.now() - 18 * 60 * 60 * 1000),
                status: 'committed',
                urgency: 'Standard',
                originalUrl: "http://localhost:8080/pdfs/QR11604-BU01-001_66%20Wollombi%20Rd%20Cessnock%20NSW%202325.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "QR11604-BU01-001", confidence: 99 },
                        "document_type": { value: "Quote Request", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Safety Inspection", confidence: 95 },
                        "job_description": { value: "Annual fire safety inspection and testing of building safety systems", confidence: 94, type: "textarea" },
                        "date_issued": { value: "20 Aug 2024", confidence: 96 },
                        "assigned_to": { value: "Fire Safety Solutions", confidence: 98 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Margaret", confidence: 95 },
                        "last": { value: "Chen", confidence: 95 },
                        "type": { value: "BILLING", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0423 891 556", confidence: 94 },
                        "email": { value: "margaret.chen@cessnockhealth.nsw.gov.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98, type: "textarea" },
                        "site_city": { value: "Cessnock", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2325", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-32.8341", confidence: 85 },
                        "longitude": { value: "151.3561", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=QR11604-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "ad3ef45g-7h8i-50j9-ak6l-538dd90m7nop", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98 },
                        "billing_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98 },
                        "job_status": { value: "Completed", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-08-20", confidence: 96 },
                        "work_order_date": { value: "2024-08-25", confidence: 96 },
                        "work_done_description": { value: "Fire safety inspection and testing completed successfully", confidence: 92 },
                        "generated_job_id": { value: "6", confidence: 88 },
                        "completion_date": { value: "2024-08-27", confidence: 96 },
                        "payment_date": { value: "2024-09-05", confidence: 94 },
                        "payment_method": { value: "EFT", confidence: 95 },
                        "payment_amount": { value: "850.00", confidence: 94 },
                        "edit_date": { value: "2024-08-27 16:45", confidence: 96 },
                        "ready_to_invoice": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.3561", confidence: 85 },
                        "job_lat": { value: "-32.8341", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2325", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Cessnock", confidence: 98 },
                        "geo_street": { value: "Wollombi Rd", confidence: 98 },
                        "geo_number": { value: "66", confidence: 98 },
                        "payment_processed": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "850.00", confidence: 94 },
                        "purchase_order_number": { value: "QR11604-BU01-001", confidence: 99 },
                        "job_description": { value: "Annual fire safety inspection - Cessnock Health Centre", confidence: 92, type: "textarea" }
                    }
                }
            }
        ];

        // Mini Client Table for Company Identification and Parsing Rules
        const clientCompanies = {
            'Emergency Trade Services Pty Ltd': {
                id: 'ets',
                name: 'Emergency Trade Services Pty Ltd',
                abn: '73 805 498 934',
                phone: '1300 755 455',
                email: 'admin@etsaus.com.au',
                website: 'www.etsaus.com.au',
                servicem8_company_uuid: '47f2f443-34b6-4a15-944b-205aa4d9f06b',
                parsing_rules: {
                    document_types: ['Work Order', 'Quote Request'],
                    order_number_pattern: /^(PO|QR)\d{4}-[A-Z]{2}\d{2}-\d{3}$/,
                    standard_work_types: ['Electrical Report', 'Electrical assessment', 'Fire Safety Inspection'],
                    qr_code_base_url: 'https://etsaus.com.au/risk-assessment?job=',
                    urgency_keywords: {
                        critical: ['emergency', 'safety', 'power outage', 'failure'],
                        urgent: ['same day', 'next day', 'repair', 'not working'],
                        standard: ['assessment', 'inspection', 'quote']
                    }
                }
            },
            'Highforce Pty Ltd': {
                id: 'highforce',
                name: 'Highforce Pty Ltd',
                abn: '12 345 678 901',
                phone: '0420 524 997',
                email: 'admin@highforce.com.au',
                website: 'https://www.highforce.com.au/',
                servicem8_company_uuid: '58g3g554-45c7-5b26-055c-316bb79h6fed',
                parsing_rules: {
                    document_types: ['Purchase Order', 'Work Request'],
                    order_number_pattern: /^PO\d{5}$/,
                    standard_work_types: ['Construction', 'Civil Works', 'Site Preparation'],
                    urgency_keywords: {
                        critical: ['urgent', 'emergency', 'safety'],
                        urgent: ['asap', 'priority', 'immediate'],
                        standard: ['standard', 'routine', 'planned']
                    }
                }
            },
            "O'Brien Electrical & Plumbing": {
                id: 'obrien',
                name: "O'Brien Electrical & Plumbing",
                abn: '98 765 432 109',
                phone: '1300 6273436',
                email: 'jobs@obrien.com.au',
                website: 'https://www.obrien.com.au/',
                servicem8_company_uuid: '69h4h665-56d8-6c37-166d-427cc89i7gfe',
                parsing_rules: {
                    document_types: ['Job Card', 'Service Request'],
                    order_number_pattern: /^Job No\.?\s*\d+$/,
                    standard_work_types: ['Electrical Service', 'Plumbing Service', 'Maintenance'],
                    urgency_keywords: {
                        critical: ['emergency', 'urgent', 'no power', 'flooding'],
                        urgent: ['same day', 'asap', 'priority'],
                        standard: ['service', 'maintenance', 'routine']
                    }
                }
            }
        };

        // Function to identify company from parsed data
        function identifyCompany(parsedFields) {
            const sourceCompany = parsedFields["Source Company"]?.company_name?.value;
            const companyDetails = parsedFields["Company Details"];

            if (sourceCompany) {
                return clientCompanies[sourceCompany] || null;
            }

            // Fallback: try to match by phone, email, or ABN
            for (const [companyName, company] of Object.entries(clientCompanies)) {
                if (companyDetails?.phone?.value === company.phone ||
                    companyDetails?.email?.value === company.email ||
                    companyDetails?.abn?.value === company.abn) {
                    return company;
                }
            }

            return null;
        }

        let pdfRecords = [...referenceWorkOrders];
        let currentPdfData = null;
        let originalFieldValues = {};
        let hasUnsavedChanges = false;

        function normalizeUrgency(value) {
            if (!value) return 'standard';
            const normalized = value.toLowerCase();
            if (normalized.includes('critical') || normalized.includes('emergency')) return 'critical';
            if (normalized.includes('urgent')) return 'urgent';
            return 'standard';
        }

        function formatRelativeDate(date) {
            const now = new Date();
            const diffInHours = Math.round((now - date) / (1000 * 60 * 60));

            if (diffInHours < 1) return 'just now';
            if (diffInHours === 1) return '1 hour ago';
            if (diffInHours < 24) return `${diffInHours} hours ago`;

            const diffInDays = Math.round(diffInHours / 24);
            if (diffInDays === 1) return '1 day ago';
            if (diffInDays < 7) return `${diffInDays} days ago`;

            const diffInWeeks = Math.round(diffInDays / 7);
            if (diffInWeeks === 1) return '1 week ago';
            if (diffInWeeks < 4) return `${diffInWeeks} weeks ago`;

            const diffInMonths = Math.round(diffInDays / 30);
            if (diffInMonths === 1) return '1 month ago';
            return `${diffInMonths} months ago`;
        }

        function generatePdfHistory() {
            const container = document.getElementById('pdfHistory');
            if (!container) {
                console.error('pdfHistory container not found!');
                return;
            }

            container.innerHTML = '<div style="padding: 20px;">Loading PDF records...</div>';

            if (!referenceWorkOrders || referenceWorkOrders.length === 0) {
                container.innerHTML = '<div style="padding: 20px; color: red;">No PDF records found!</div>';
                return;
            }

            container.innerHTML = '';

            referenceWorkOrders.forEach((pdf, index) => {
                const row = document.createElement('div');
                const urgencyKey = normalizeUrgency(pdf.urgency);

                row.className = `pdf-row urgency-${urgencyKey}`;
                row.setAttribute('data-index', index.toString());

                const statusLabels = {
                    'review': 'Needs review',
                    'processing': 'Converting',
                    'committed': 'Sent to ServiceM8'
                };

                const statusLabel = statusLabels[pdf.status] || 'Processing';

                row.innerHTML = `
                    <div class="pdf-row-content">
                        <div class="pdf-row-info">
                            <div class="pdf-row-title">${pdf.name}</div>
                            <div class="pdf-row-meta">
                                <span><span class="status-dot ${pdf.status}"></span>${statusLabel}</span>
                                <span>${pdf.pages} pages</span>
                                <div class="confidence-scale">
                                    ${generateConfidenceScale(pdf.confidence)}
                                </div>
                                <span>Processed ${formatRelativeDate(pdf.processedAt)}</span>
                            </div>
                        </div>
                        <div class="chevron">‚Ä∫</div>
                    </div>
                `;

                row.style.cursor = 'pointer';
                row.onclick = function() {
                    console.log('Card clicked for:', pdf.name);
                    openPdfViewer(pdf);
                };
                container.appendChild(row);
            });
        }

        function openModal() {
            pdfModal.style.display = 'block';
            setTimeout(() => pdfModal.classList.add('show'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            pdfModal.classList.remove('show');
            setTimeout(() => {
                pdfModal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }

        function openPdfViewer(pdf) {
            currentPdfData = pdf;

            // Set the title
            if (pdfViewerTitle) {
                pdfViewerTitle.textContent = pdf.name;
            }

            // Set the PDF source
            if (originalPdfFrame) {
                const pdfSource = pdf.originalUrl || `https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf`;
                originalPdfFrame.src = pdfSource;
            }

            // Generate the parsed fields content
            if (pdf.parsedFields) {
                generateParsedFields(pdf.parsedFields);
                storeOriginalValues(pdf.parsedFields);
            }

            hasUnsavedChanges = false;
            updateChangesIndicator();

            // Show the modal
            if (pdfViewerModal) {
                pdfViewerModal.style.display = 'block';
                setTimeout(() => {
                    if (pdfViewerModal) {
                        pdfViewerModal.classList.add('show');
                    }
                }, 10);
                document.body.style.overflow = 'hidden';
            }
        }

        function generateQuickReview(parsedFields) {
            const parsedFieldsContent = document.getElementById('parsedFieldsContent');

            // Extract key information for quick review
            const workOrder = parsedFields["Work Order Details"] || {};
            const sourceCompany = parsedFields["Source Company"] || {};
            const location = parsedFields["Job Location"] || {};
            const contact = parsedFields["Site Contact"] || {};
            const serviceM8 = parsedFields["ServiceM8 API Fields"] || {};

            // Derive company details from client table
            const identifiedCompany = identifyCompany(parsedFields);
            const company = identifiedCompany || {
                name: sourceCompany.company_name?.value || 'Unknown Company',
                phone: 'Contact not available',
                email: 'Contact not available',
                abn: 'Not available'
            };

            // Create Quick Review section
            const quickReviewSection = document.createElement('div');
            quickReviewSection.className = 'quick-review-section';

            // Determine urgency level and response requirements
            const urgency = getCurrentUrgency(workOrder, parsedFields);
            const urgencyInfo = getUrgencyInfo(urgency);

            // Generate time constraints summary
            const timeConstraints = generateTimeConstraints(workOrder, parsedFields);

            let quickReviewHTML = `
                <div class="quick-review-header">
                    <span class="quick-review-icon">‚ö°</span>
                    Quick Review
                    <span class="quick-review-toggle">‚ñº</span>
                </div>
                <div class="quick-review-cards">
                    <div class="quick-review-card">
                        <div class="quick-review-card-header">COMPANY</div>
                        <div class="quick-review-card-content">
                            <div class="company-name">${company.name || 'Not specified'}</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">ORDER NUMBER</div>
                        <div class="quick-review-card-content">
                            <div class="order-number">${workOrder.order_number?.value || 'Not specified'}</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">URGENCY</div>
                        <div class="quick-review-card-content">
                            <div class="urgency-input-box"></div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">SITE DETAILS</div>
                        <div class="quick-review-card-content">
                            <div class="site-details">${contact.first?.value && contact.last?.value ? `${contact.first.value} ${contact.last.value}` : 'Not specified'} ‚Ä¢ ${contact.mobile?.value || 'No phone'} ‚Ä¢ ${location.site_address?.value || 'No address'}</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">JOB SUMMARY</div>
                        <div class="quick-review-card-content">
                            <div class="job-summary">WORK ORDER: ${workOrder.job_description?.value || 'No description available'}</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">BUDGET INVOICING</div>
                        <div class="quick-review-card-content">
                            <div class="budget-info">Approved work order ${workOrder.total_amount?.value || '$0.00'} ‚Ä¢ Invoice via link in email ‚Ä¢ Pre-approved amount</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>

                    <div class="quick-review-card">
                        <div class="quick-review-card-header">TIME CONSTRAINTS</div>
                        <div class="quick-review-card-content">
                            <div class="time-constraints">${timeConstraints}</div>
                            <div class="confidence-dots">‚óè‚óè‚óè‚óè‚óè</div>
                        </div>
                    </div>
                </div>
            `;

            quickReviewSection.innerHTML = quickReviewHTML;
            parsedFieldsContent.appendChild(quickReviewSection);
        }

        function getCurrentUrgency(workOrder, parsedFields) {
            // AI logic to determine urgency based on keywords and context
            const description = (workOrder.job_description?.value || '').toLowerCase();
            const workType = (workOrder.work_type?.value || '').toLowerCase();

            // Critical keywords
            if (description.includes('emergency') || description.includes('safety') ||
                description.includes('power outage') || description.includes('failure') ||
                description.includes('urgent') || description.includes('asap')) {
                return 'CRITICAL';
            }

            // Urgent keywords
            if (description.includes('same day') || description.includes('next day') ||
                workType.includes('repair') || description.includes('not working')) {
                return 'URGENT';
            }

            return 'STANDARD';
        }

        function getUrgencyInfo(urgency) {
            const urgencyMap = {
                'CRITICAL': {
                    response: 'Within 2 hours (24/7)',
                    scheduling: 'ASAP'
                },
                'URGENT': {
                    response: 'Within 4 hours (business hours)',
                    scheduling: '24-48 hours'
                },
                'STANDARD': {
                    response: 'Next business day',
                    scheduling: '5-10 business days'
                }
            };
            return urgencyMap[urgency] || urgencyMap['STANDARD'];
        }

        function generateTimeConstraints(workOrder, parsedFields) {
            const dateIssued = workOrder.date_issued?.value;
            const description = workOrder.job_description?.value || '';

            let constraints = [];

            if (dateIssued) {
                constraints.push(`Issued: ${dateIssued}`);
            }

            // Enhanced AI extraction of time-related information
            const timePatterns = [
                { pattern: /(?:within|by|before|deadline|due)\s+(\d+\s*(?:hours?|days?|weeks?))/gi, type: 'deadline' },
                { pattern: /(?:asap|urgent|emergency|immediately|same\s+day)/gi, type: 'urgent' },
                { pattern: /(?:next\s+(?:business\s+)?day|tomorrow)/gi, type: 'next_day' },
                { pattern: /(?:business\s+hours?|9\s*-?\s*5|working\s+hours?)/gi, type: 'business_hours' }
            ];

            let urgencyFactors = [];
            timePatterns.forEach(({pattern, type}) => {
                const matches = description.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        switch(type) {
                            case 'deadline':
                                constraints.push(`‚è∞ ${match}`);
                                break;
                            case 'urgent':
                                urgencyFactors.push(`üö® ${match.toUpperCase()}`);
                                break;
                            case 'next_day':
                                constraints.push(`üìÜ ${match}`);
                                break;
                            case 'business_hours':
                                constraints.push(`üïò ${match}`);
                                break;
                        }
                    });
                }
            });

            // Work type analysis
            const workType = workOrder.work_type?.value || '';
            if (workType.toLowerCase().includes('emergency')) {
                urgencyFactors.push('üö® Emergency response required');
            } else if (workType.toLowerCase().includes('assessment')) {
                constraints.push('üìã Assessment - flexible scheduling');
            }

            // Combine all factors
            const allConstraints = [...constraints, ...urgencyFactors];
            return allConstraints.length > 0 ? allConstraints.join('<br>') : 'üìã Standard scheduling - no urgent constraints';
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function generateParsedFields(parsedFields) {
            const parsedFieldsContent = document.getElementById('parsedFieldsContent');
            parsedFieldsContent.innerHTML = '';

            // Generate Quick Review section first
            generateQuickReview(parsedFields);

            const sectionNames = Object.keys(parsedFields);
            let sectionIndex = 0;

            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                const section = document.createElement('div');
                section.className = 'field-section';

                // Auto-expand first 3 sections, but keep Company Details collapsed
                if (sectionIndex >= 3 || sectionName === "Company Details") {
                    section.classList.add('collapsed');
                }

                section.setAttribute('data-section', sectionName);

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'field-section-title';
                sectionTitle.textContent = sectionName;

                // Add click handler for collapsible functionality
                sectionTitle.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                });

                section.appendChild(sectionTitle);
                sectionIndex++;

                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';

                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'field-item';

                    const label = document.createElement('div');
                    label.className = 'field-label';
                    label.textContent = formatFieldLabel(fieldName);

                    let input;
                    if (fieldData.type === 'select') {
                        input = document.createElement('select');
                        input.className = 'field-input field-select';

                        fieldData.options.forEach(optionValue => {
                            const option = document.createElement('option');
                            option.value = optionValue;
                            option.textContent = optionValue;
                            option.selected = optionValue === fieldData.value;
                            input.appendChild(option);
                        });

                        // Make ServiceM8 API Fields read-only
                        if (sectionName === 'ServiceM8 API Fields') {
                            input.disabled = true;
                            input.style.backgroundColor = '#f8f9fa';
                            input.style.cursor = 'not-allowed';
                            input.title = 'This field is automatically derived from other fields above';
                        }
                    } else if (fieldData.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.className = 'field-input field-textarea';
                        input.value = fieldData.value;
                    } else {
                        input = document.createElement('input');
                        input.className = 'field-input';
                        input.type = 'text';
                        input.value = fieldData.value;
                    }

                    // Make ServiceM8 API Fields read-only as they are derived from other fields
                    if (sectionName === 'ServiceM8 API Fields') {
                        input.readOnly = true;
                        input.style.backgroundColor = '#f8f9fa';
                        input.style.cursor = 'not-allowed';
                        input.title = 'This field is automatically derived from other fields above';
                    }

                    input.setAttribute('data-section', sectionName);
                    input.setAttribute('data-field', fieldName);

                    const confidenceSpan = document.createElement('div');
                    confidenceSpan.className = `field-confidence ${getConfidenceClass(fieldData.confidence)}`;
                    confidenceSpan.innerHTML = `
                        <div class="confidence-scale">
                            ${generateConfidenceScale(fieldData.confidence)}
                        </div>
                    `;

                    input.addEventListener('input', (e) => handleFieldChange(e, fieldData.value));

                    fieldItem.appendChild(label);
                    fieldItem.appendChild(input);
                    fieldItem.appendChild(confidenceSpan);
                    fieldGroup.appendChild(fieldItem);
                }

                section.appendChild(fieldGroup);
                parsedFieldsContent.appendChild(section);
            }
        }

        function formatFieldLabel(fieldName) {
            return fieldName
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 85) return 'high';
            if (confidence >= 70) return 'medium';
            return 'low';
        }

        function generateConfidenceScale(confidence) {
            const totalDots = 5;
            const filledDots = Math.round((confidence / 100) * totalDots);

            let dots = '';
            for (let i = 0; i < totalDots; i++) {
                const isFilled = i < filledDots;
                dots += `<span class="confidence-dot ${isFilled ? 'filled' : 'empty'}"></span>`;
            }

            return dots;
        }

        function handleFieldChange(event, originalValue) {
            const input = event.target;
            const currentValue = input.value;

            if (currentValue !== originalValue) {
                input.classList.add('modified');
                hasUnsavedChanges = document.querySelectorAll('.field-input.modified').length > 0;
            } else {
                input.classList.remove('modified');
                hasUnsavedChanges = document.querySelectorAll('.field-input.modified').length > 0;
            }

            updateChangesIndicator();
        }

        function updateChangesIndicator() {
            const changesIndicator = document.getElementById('changesIndicator');
            if (changesIndicator) {
                if (hasUnsavedChanges) {
                    changesIndicator.classList.add('show');
                } else {
                    changesIndicator.classList.remove('show');
                }
            }
        }

        function storeOriginalValues(parsedFields) {
            originalFieldValues = {};
            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                originalFieldValues[sectionName] = {};
                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    originalFieldValues[sectionName][fieldName] = fieldData.value;
                }
            }
        }

        function resetFields() {
            if (!currentPdfData) return;

            const inputs = document.querySelectorAll('.field-input');
            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');
                const originalValue = originalFieldValues[section][field];

                input.value = originalValue;
                input.classList.remove('modified');
            });

            hasUnsavedChanges = false;
            updateChangesIndicator();
        }

        function saveFields() {
            if (!currentPdfData || !hasUnsavedChanges) return;

            const inputs = document.querySelectorAll('.field-input.modified');
            const updates = {};

            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');

                if (!updates[section]) {
                    updates[section] = {};
                }
                updates[section][field] = input.value;

                currentPdfData.parsedFields[section][field].value = input.value;
                input.classList.remove('modified');
            });

            storeOriginalValues(currentPdfData.parsedFields);
            hasUnsavedChanges = false;
            updateChangesIndicator();

            const jobId = currentPdfData.parsedFields['ServiceM8 API Fields']?.generated_job_id?.value ||
                         currentPdfData.parsedFields['Work Order Details']?.order_number?.value || 'New Job';
            const jobType = currentPdfData.parsedFields['Work Order Details']?.document_type?.value || 'Work Order';

            alert(`üöÄ ${jobType} "${jobId}" ready for ServiceM8!\n\nFields updated and ready to submit to ServiceM8 API.`);

            console.log('ServiceM8 Job Fields Updated:', updates);
        }

        function closePdfViewer() {
            if (hasUnsavedChanges) {
                const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
                if (!confirmClose) {
                    return;
                }
            }

            pdfViewerModal.classList.remove('show');
            setTimeout(() => {
                pdfViewerModal.style.display = 'none';
                document.body.style.overflow = '';
                originalPdfFrame.src = '';

                currentPdfData = null;
                originalFieldValues = {};
                hasUnsavedChanges = false;
                const parsedFieldsContent = document.getElementById('parsedFieldsContent');
                parsedFieldsContent.innerHTML = '';
            }, 300);
        }

        // Event listeners
        fabButton.addEventListener('click', openModal);
        modalClose.addEventListener('click', closeModal);
        pdfViewerClose.addEventListener('click', closePdfViewer);
        document.getElementById('saveFieldsBtn').addEventListener('click', saveFields);

        // Close modals when clicking outside
        pdfModal.addEventListener('click', (e) => {
            if (e.target === pdfModal) {
                closeModal();
            }
        });

        pdfViewerModal.addEventListener('click', (e) => {
            if (e.target === pdfViewerModal) {
                closePdfViewer();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (pdfViewerModal.classList.contains('show')) {
                    closePdfViewer();
                } else if (pdfModal.classList.contains('show')) {
                    closeModal();
                }
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            generatePdfHistory();
        });
    </script>
</body>
</html>