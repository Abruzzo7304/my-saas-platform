<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Converter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f6f7f9;
            color: #1b1f24;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .background-content {
            padding: 48px 32px 96px;
            max-width: 1080px;
            margin: 0 auto;
        }

        .page-header {
            text-align: left;
            margin-bottom: 48px;
            color: inherit;
        }

        .page-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .page-header-heading {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1b1f24;
            border: 1px solid #dfe3e8;
            border-radius: 999px;
            background: #ffffff;
            cursor: pointer;
            text-decoration: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .back-link:hover {
            border-color: #c5cad1;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
        }

        .back-link:focus {
            outline: none;
            border-color: #1b1f24;
            box-shadow: 0 0 0 3px rgba(27, 31, 36, 0.2);
        }

        .main-title {
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-shadow: none;
            letter-spacing: -0.01em;
        }

        .subtitle {
            font-size: 1rem;
            color: #5e6470;
            font-weight: 400;
        }

        .fab {
            position: fixed;
            bottom: 32px;
            left: 32px;
            width: 52px;
            height: 52px;
            background: #1b1f24;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(17, 24, 39, 0.12);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(17, 24, 39, 0.16);
        }

        .fab-icon {
            color: white;
            font-size: 22px;
            font-weight: 600;
        }

        /* PDF History Rows */

        .pdf-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 16px 0 8px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .control-label {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
        }

        .control-options {
            display: inline-flex;
            gap: 0.5rem;
        }

        .control-option {
            border: 1px solid #dfe3e8;
            background: #ffffff;
            color: #1f2937;
            font-size: 0.82rem;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 999px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease, background 0.2s ease;
        }

        .control-option:hover {
            border-color: #c5cad1;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
        }

        .control-option.is-active {
            background: #0f172a;
            border-color: #0f172a;
            color: #ffffff;
        }

        .control-select {
            border: 1px solid #dfe3e8;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.82rem;
            color: #1f2937;
            background: #ffffff;
        }

        .pdf-history {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pdf-row {
            position: relative;
            background: #ffffff;
            border-radius: 16px;
            padding: 20px 24px;
            border: 1px solid #dfe3e8;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .pdf-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 18px;
            bottom: 18px;
            width: 4px;
            border-radius: 999px;
            background: #dfe3e8;
            transition: background 0.2s ease;
        }

        .pdf-row:hover {
            border-color: #c5cad1;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .pdf-row.urgency-standard::before {
            background: #3f674b;
        }

        .pdf-row.urgency-urgent::before {
            background: #b35a09;
        }

        .pdf-row.urgency-critical::before {
            background: #b42318;
        }

        .pdf-row.status-review::before {
            background: #eb6f47;
        }

        .pdf-row.status-created {
            background: #f6f7f9;
            border-color: #d0d6dd;
        }

        .pdf-row.status-created::before {
            background: #2563eb;
        }

        .pdf-row.status-declined {
            background: #fdf4ff;
            border-color: #f5d0fe;
        }

        .pdf-row.status-declined::before {
            background: #c026d3;
        }

        .pdf-row.status-info-requested::before {
            background: #f59e0b;
        }

        .pdf-row.overdue {
            border-color: #f87171;
            box-shadow: 0 6px 18px rgba(248, 113, 113, 0.2);
        }

        .pdf-card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .pdf-card-top-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .pdf-card-heading {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .doc-type-label {
            font-size: 0.78rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #0f172a;
        }

        .doc-type-work-order { color: #1f2a37; }
        .doc-type-quote { color: #1d4ed8; }
        .doc-type-general { color: #374151; }

        .heading-company {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
        }

        .company-ref {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4b5563;
        }

        .job-summary {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 600;
            margin-top: 4px;
        }

        .urgency-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.82rem;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .urgency-indicator.critical { color: #b42318; }
        .urgency-indicator.urgent { color: #b35a09; }
        .urgency-indicator.standard { color: #3f674b; }

        .urgency-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.75;
        }

        .status-chip {
            background: transparent;
            padding: 0;
            font-size: 0.78rem;
            font-weight: 600;
            color: #6b7280;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .pdf-card-body {
            display: grid;
            gap: 12px;
        }

        .pdf-card-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pdf-file-name {
            font-size: 0.92rem;
            font-weight: 500;
            color: #4b5563;
            letter-spacing: 0.01em;
            word-break: break-word;
        }

        .pdf-card-scope {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 500;
        }

        .pdf-file-meta {
            font-size: 0.82rem;
            color: #6b7280;
            display: inline-flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .meta-overdue {
            color: #b91c1c;
            font-weight: 600;
        }

        .pdf-company {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .job-location {
            font-size: 0.82rem;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Quick Review refresh */
        .quick-review-card {
            background: #ffffff;
            border: 1px solid #dfe3e8;
            border-radius: 18px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .quick-review-section {
            margin-bottom: 20px;
        }

        .quick-review-actions-stick {
            position: sticky;
            top: 0;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,1) 70%, rgba(255,255,255,0) 100%);
            padding-bottom: 12px;
        }

        .quick-review-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .quick-review-heading {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-review-type {
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .quick-review-type.work-order { color: #1f2a37; }
        .quick-review-type.quote { color: #1d4ed8; }
        .quick-review-type.general { color: #374151; }

        .quick-review-title {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            color: #0f172a;
        }

        .quick-review-ref {
            font-size: 0.85rem;
            font-weight: 600;
            color: #475569;
        }

        .quick-review-urgency {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            text-align: right;
            min-width: 200px;
        }

        .quick-review-urgency-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #6b7280;
        }

        .quick-review-scope {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1f2937;
            line-height: 1.5;
        }

        .quick-review-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.82rem;
            color: #64748b;
        }

        .quick-review-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .quick-metric {
            background: #f6f7f9;
            border: 1px solid #e3e7ed;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .quick-metric .metric-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #6b7280;
        }

        .quick-metric .metric-value {
            font-size: 1.05rem;
            font-weight: 600;
            color: #0f172a;
        }

        .quick-metric .metric-hint {
            font-size: 0.78rem;
            color: #94a3b8;
        }

        .quick-review-note {
            padding: 14px 16px;
            border-radius: 12px;
            font-size: 0.82rem;
            line-height: 1.5;
        }

        .quick-review-note.critical { background: #fef2f2; color: #7f1d1d; }
        .quick-review-note.urgent { background: #fff6e6; color: #8b3b11; }
        .quick-review-note.standard { background: #eef6f1; color: #25603a; }
        .quick-review-note.info-requested { background: #fff6e6; color: #b45309; }

        .quick-review-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .quick-action.decline {
            background: #fef2f2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        .quick-action.decline:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(185, 28, 28, 0.15);
        }

        .quick-action.create {
            background: #0f172a;
            color: #ffffff;
        }

        .quick-action.create:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.2);
        }

        .quick-action.info {
            background: #fff6e6;
            color: #b45309;
            border-color: #fed7aa;
        }

        .quick-action.info:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(236, 153, 46, 0.18);
        }

        .quick-edit-toggle {
            background: transparent;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            padding: 6px 10px;
        }

        .quick-edit-toggle[disabled] {
            cursor: not-allowed;
            color: #94a3b8;
        }

        .quick-action.info {
            background: #fff6e6;
            color: #b45309;
            border-color: #fed7aa;
        }

        .quick-action.info:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(236, 153, 46, 0.18);
        }

        .quick-edit-toggle {
            background: transparent;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            padding: 6px 10px;
        }

        .quick-edit-toggle[disabled] {
            cursor: not-allowed;
            color: #94a3b8;
        }

        .info-divider {
            height: 1px;
            width: 55%;
            max-width: 260px;
            background: #e5e7eb;
            margin: 8px 0 4px;
        }

        .company-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2937;
        }

        .company-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .pdf-row-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .pdf-row-footer-left {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .meta-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #6b7280;
        }

        .confidence-scale {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .confidence-score {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1f2937;
        }

        .more-link {
            margin-left: auto;
            color: #0f172a;
            font-size: 0.82rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            text-decoration: underline;
            cursor: pointer;
        }

        .more-link::after {
            content: '‚Üí';
            font-size: 0.9rem;
        }


        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.review { background-color: #eb6f47; }
        .status-dot.created { background-color: #2563eb; }
        .status-dot.declined { background-color: #c026d3; }
        .status-dot.info-requested { background-color: #f59e0b; }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(4px);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.94);
            background: #ffffff;
            border-radius: 16px;
            width: min(560px, 92vw);
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.14);
            transition: transform 0.25s ease;
        }

        .modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            background: #ffffff;
            color: #1b1f24;
            padding: 28px 32px 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #e8ebf0;
        }

        .modal-title {
            font-size: 1.35rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-subtitle {
            font-size: 0.95rem;
            color: #6c7280;
            margin-top: 6px;
        }

        .modal-close {
            background: transparent;
            border: 1px solid #d4d8de;
            color: #374151;
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .modal-close:hover {
            background: #f2f4f7;
            border-color: #c2c8d0;
        }

        .modal-body {
            padding: 28px 32px;
            max-height: calc(85vh - 120px);
            overflow-y: auto;
        }

        /* PDF Viewer Modal */
        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(2px);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .pdf-viewer-modal.show {
            opacity: 1;
        }

        .pdf-viewer-content {
            position: absolute;
            top: 4%;
            left: 4%;
            width: 92%;
            height: 92%;
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 56px rgba(15, 23, 42, 0.18);
            transform: scale(0.96);
            transition: transform 0.25s ease;
        }

        .pdf-viewer-modal.show .pdf-viewer-content {
            transform: scale(1);
        }

        .pdf-viewer-header {
            background: #ffffff;
            color: #1b1f24;
            padding: 20px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e8ebf0;
        }

        .pdf-viewer-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-viewer-title::before {
            content: "üìÑ";
            font-size: 1.1rem;
        }

        .pdf-viewer-close {
            background: transparent;
            border: 1px solid #d4d8de;
            color: #374151;
            font-size: 20px;
            cursor: pointer;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .pdf-viewer-close:hover {
            background: #f2f4f7;
            border-color: #c2c8d0;
        }

        .pdf-viewer-body {
            flex: 1;
            display: flex;
            min-height: 0;
            overflow: hidden;
            background: #f6f7f9;
        }

        .pdf-panel {
            flex: 1;
            border-right: 1px solid #e3e7ed;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .pdf-panel:last-child {
            border-right: none;
        }

        .pdf-panel-header {
            background: #fbfcfd;
            padding: 18px 24px;
            border-bottom: 1px solid #e8ebf0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2733;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-panel-header.original {
            background: #fbfcfd;
            color: #1f2733;
        }

        .pdf-panel-header.fields {
            background: #fbfcfd;
            color: #1f2733;
        }

        .pdf-frame {
            border: none;
            width: 100%;
            height: 100%;
        }

        /* Parsed Fields Panel */
        .parsed-fields-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            min-height: 0;
            overflow: hidden;
        }

        .parsed-fields-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: #ffffff;
        }

        .field-section {
            margin-bottom: 16px;
            background: #f6f7f9;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #e3e7ed;
        }

        .field-section:last-child {
            margin-bottom: 0;
        }

        /* Tradesperson Quick Review Section */
        .tradesperson-quick-review {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e3e7ed;
            margin-bottom: 24px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.05);
        }

        .job-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 24px;
            border-bottom: 1px solid #e8ebf0;
            background: transparent;
            color: inherit;
            border-radius: 16px 16px 0 0;
        }

        .job-header .job-title {
            font-size: 1.35rem;
            font-weight: 600;
            text-shadow: none;
            color: #1b1f24;
        }

        .job-header .job-reference {
            background: #f2f4f7;
            color: #1b1f24;
            border: 1px solid #e3e7ed;
        }

        .job-header .job-description-summary {
            color: #5e6470;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .urgency-badge {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            background: #f2f4f7;
            color: #3b4251;
        }

        .urgency-badge.urgency-critical {
            background: #fbeaea;
            color: #c03a2b;
            animation: none;
        }

        .urgency-badge.urgency-urgent {
            background: #fff2db;
            color: #b25612;
        }

        .urgency-badge.urgency-standard {
            background: #e6f4ea;
            color: #2f6b3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .urgency-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .urgency-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: #5e6470;
        }

        .urgency-select {
            padding: 8px 12px;
            border: 1px solid #d7dbe1;
            border-radius: 8px;
            background: #ffffff;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2937;
            cursor: pointer;
            min-width: 120px;
        }

        .urgency-select:focus {
            outline: none;
            border-color: #9aa0aa;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.25);
        }

        .urgency-details {
            margin-top: 8px;
        }

        .urgency-explanation {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.82rem;
            line-height: 1.5;
            border-left: 3px solid;
            transition: background 0.2s ease;
        }

        .urgency-explanation.critical {
            background: #fceeee;
            border-left-color: #e14c3d;
            color: #7f1d1d;
        }

        .urgency-explanation.urgent {
            background: #fff5e6;
            border-left-color: #f3a347;
            color: #8b3b11;
        }

        .urgency-explanation.standard {
            background: #edf7f0;
            border-left-color: #3e8b56;
            color: #25603a;
        }

        .job-summary {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .job-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }

        .job-reference {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6366f1;
            background: #eef2ff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
        }

        .job-description-summary {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.4;
            margin-top: 4px;
        }

        .decision-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 24px;
        }

        .decision-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #e3e7ed;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .decision-card:hover {
            border-color: #c5cad1;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }

        .decision-card.money {
            border-left: 3px solid #2f855a;
        }

        .decision-card.money.confirmed {
            background: #f0f7f2;
        }

        .decision-card.money.estimated {
            border-left-color: #d08928;
            background: #fff6e7;
        }

        .decision-card.money.unscoped {
            border-left-color: #8e95a3;
            background: #f6f7f9;
        }

        .decision-card.money.unscoped .decision-value {
            color: #6b7280;
        }

        .decision-card.location {
            border-left: 4px solid #3b82f6;
        }

        .decision-card.timing {
            border-left: 4px solid #f59e0b;
        }
        .decision-card.timing.on-time {
            border-left: 4px solid #10b981;
        }
        .decision-card.timing.warning {
            border-left: 4px solid #f59e0b;
        }
        .decision-card.timing.overdue {
            border-left: 4px solid #ef4444;
        }

        .decision-card.client {
            border-left: 4px solid #8b5cf6;
        }

        .decision-icon {
            font-size: 1.8rem;
            opacity: 0.8;
        }

        .decision-content {
            flex: 1;
        }

        .decision-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .decision-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .decision-subtext {
            font-size: 0.8rem;
            color: #9ca3af;
            line-height: 1.2;
        }

        .job-description-preview {
            padding: 18px 24px;
            border-top: 1px solid #e8ebf0;
            background: #fbfcfd;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #4b5563;
        }

        .decision-actions {
            display: none;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .decision-actions button {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reject-btn {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .reject-btn:hover {
            background: #fee2e2;
            transform: translateY(-1px);
        }

        .accept-btn {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .accept-btn:hover {
            background: #dcfce7;
            transform: translateY(-1px);
        }

        .details-btn {
            background: #fefbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        .details-btn:hover {
            background: #fef3c7;
            transform: translateY(-1px);
        }


        .urgency-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .urgency-header {
            margin-bottom: 8px;
        }

        .urgency-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .urgency-level.critical {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .urgency-level.urgent {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }

        .urgency-level.standard {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #86efac;
        }

        .urgency-details {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .urgency-response, .urgency-scheduling {
            margin-bottom: 4px;
            color: #374151;
        }

        .urgency-note {
            color: #dc2626;
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.75rem;
        }

        .time-constraints-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .time-constraints-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: #92400e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .time-constraints-content {
            font-size: 0.8rem;
            line-height: 1.4;
            color: #374151;
        }

        .field-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            padding: 8px 6px 6px 6px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .field-section-title:hover {
            background-color: #f1f5f9;
        }

        .field-section-title::after {
            content: "‚ñº";
            margin-left: auto;
            font-size: 0.7rem;
            transition: transform 0.2s ease;
            color: #64748b;
        }

        .field-section.collapsed .field-section-title::after {
            transform: rotate(-90deg);
        }

        .field-section-title::before {
            content: "‚öôÔ∏è";
            font-size: 0.8rem;
        }

        .field-section[data-section="Source Company"] .field-section-title::before {
            content: "üè¢";
        }

        .field-section[data-section="Company Details"] .field-section-title::before {
            content: "üìû";
        }

        .field-section[data-section="Work Order Details"] .field-section-title::before {
            content: "üìã";
        }


        .field-section[data-section="Site Contact"] .field-section-title::before {
            content: "üè†";
        }

        .field-section[data-section="Work Order Issuer"] .field-section-title::before {
            content: "üë®‚Äçüíº";
        }

        .field-section[data-section="Job Location"] .field-section-title::before {
            content: "üìç";
        }

        .field-section[data-section="QR Code Data"] .field-section-title::before {
            content: "üì±";
        }

        .field-section[data-section="Work Notes & Checklists"] .field-section-title::before {
            content: "üìã";
        }

        .field-section[data-section="ServiceM8 API Fields"] .field-section-title::before {
            content: "üîß";
        }

        .field-group {
            display: grid;
            gap: 8px;
            margin-bottom: 0;
            transition: all 0.3s ease;
            overflow: visible;
            position: relative;
        }

        .field-section.collapsed .field-group {
            max-height: 0;
            margin-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        .field-section:not(.collapsed) .field-group {
            max-height: 2000px;
            opacity: 1;
        }

        .field-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }

        .field-item:hover {
            border-color: #c7d2fe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .field-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }

        .field-input {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #1e293b;
            background: #f8fafc;
            transition: all 0.2s ease;
            font-family: inherit;
            border: 1px solid transparent;
        }

        .field-input:focus {
            outline: none;
            background: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.1);
        }

        .field-input.modified {
            background: #fef3c7;
            border-color: #f59e0b;
            position: relative;
        }

        .field-input.modified::after {
            content: "‚úèÔ∏è";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
        }

        .field-input.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .field-input.read-only,
        .field-input.read-only:focus {
            background: #f8fafc;
            border-color: transparent;
            color: #6b7280;
            cursor: not-allowed;
        }

        .field-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .field-select {
            /* Reset all appearance */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;

            /* Basic styling */
            width: 100%;
            max-width: 100%;
            padding: 6px 28px 6px 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #1e293b;
            background-color: #f8fafc;
            font-family: inherit;
            cursor: pointer;

            /* Custom dropdown arrow */
            background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzZCNzI4MCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;

            /* Ensure proper box model */
            box-sizing: border-box;
            outline: none;
        }

        .field-select:focus {
            background-color: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.1);
        }

        .field-select:hover {
            background-color: #f1f5f9;
        }

        .field-select option {
            background-color: white;
            color: #1e293b;
            padding: 8px 12px;
        }

        /* Force clean dropdown styling for document type specifically */
        select[data-field="document_type"] {
            background: #f8fafc !important;
            border: 1px solid transparent !important;
            width: 100% !important;
            max-width: 100% !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: url("data:image/svg+xml;charset=utf-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 8px center !important;
            background-repeat: no-repeat !important;
            background-size: 16px !important;
            padding: 6px 28px 6px 10px !important;
            font-size: 0.85rem !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }

        .panel-status {
            margin-left: auto;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
        }

        .field-confidence {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 4px;
        }

        .confidence-scale {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .confidence-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .confidence-dot.filled {
            background-color: #10b981;
        }

        .confidence-dot.empty {
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
        }

        .field-confidence.high .confidence-dot.filled { background-color: #10b981; }
        .field-confidence.medium .confidence-dot.filled { background-color: #f59e0b; }
        .field-confidence.low .confidence-dot.filled { background-color: #ef4444; }

        .field-actions {
            background: white;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .btn-primary {
            background: #1b1f24;
            color: white;
            border: 1px solid #1b1f24;
            box-shadow: none;
        }

        .btn-primary:hover {
            background: #2c3137;
            border-color: #2c3137;
            transform: none;
        }

        .btn-icon {
            font-size: 1rem;
        }

        .changes-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1b1f24;
            color: white;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(17, 24, 39, 0.16);
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1001;
        }

        .changes-indicator.show {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .fab {
                bottom: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
            }

            .fab-icon {
                font-size: 20px;
            }

            .modal-content {
                width: 98%;
                max-height: 95vh;
                border-radius: 12px;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .modal-subtitle {
                font-size: 0.9rem;
            }

            .modal-body {
                padding: 20px;
                max-height: calc(95vh - 120px);
            }

            .pdf-viewer-content {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                transform: scale(1);
            }

            .pdf-viewer-modal.show .pdf-viewer-content {
                transform: scale(1);
            }

            .pdf-viewer-header {
                padding: 16px 20px;
            }

            .pdf-viewer-title {
                font-size: 1.1rem;
            }

            .pdf-viewer-body {
                flex-direction: column;
            }

            .pdf-panel {
                border-right: none;
                border-bottom: 2px solid #e5e7eb;
                height: 40%;
            }

            .parsed-fields-panel {
                height: 60%;
                border-bottom: none;
            }

            .pdf-panel-header {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .parsed-fields-content {
                padding: 16px;
                max-height: none;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .field-section {
                margin-bottom: 12px;
                padding: 10px;
            }

            .field-section-title {
                font-size: 0.9rem;
                padding: 6px 4px 4px 4px;
                margin-bottom: 6px;
            }

            .field-section-title::after {
                font-size: 0.6rem;
            }

            .field-group {
                margin-bottom: 8px;
            }

            .field-item {
                padding: 6px 8px;
                margin-bottom: 6px;
            }

            .field-label {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }

            .field-input, .field-textarea {
                font-size: 14px !important;
                padding: 6px 8px;
            }

            .field-textarea {
                min-height: 60px;
            }

            .changes-indicator {
                top: 16px;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 12px;
                font-size: 0.75rem;
                border-radius: 16px;
            }

            .changes-indicator.show {
                transform: translateX(-50%);
            }

            .field-actions {
                padding: 16px;
                gap: 12px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .btn-icon {
                margin-right: 6px;
            }

            .pdf-row {
                padding: 16px;
                margin-bottom: 12px;
            }

            .pdf-row-content {
                gap: 12px;
            }

            .pdf-row-meta {
                font-size: 0.8rem;
                gap: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .pdf-viewer-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .pdf-viewer-header {
                padding: 12px 16px;
            }

            .pdf-viewer-title {
                font-size: 1rem;
            }

            .pdf-panel {
                height: 35%;
            }

            .parsed-fields-panel {
                height: 65%;
            }

            .pdf-panel-header {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .parsed-fields-content {
                padding: 12px;
                max-height: calc(65vh - 70px);
            }

            .field-section {
                margin-bottom: 16px;
                padding: 12px;
            }

            .field-card {
                padding: 10px;
                margin-bottom: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .changes-indicator {
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
                padding: 4px 8px;
                font-size: 0.7rem;
                border-radius: 12px;
            }

            .changes-indicator.show {
                transform: translateX(-50%);
            }

            .fab {
                bottom: 12px;
                left: 12px;
                width: 44px;
                height: 44px;
            }

            .fab-icon {
                font-size: 18px;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .pdf-viewer-body {
                flex-direction: row;
            }

            .pdf-panel {
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
                height: 100%;
                width: 50%;
            }

            .parsed-fields-panel {
                height: 100%;
                width: 50%;
                border-bottom: none;
            }

            .parsed-fields-content {
                max-height: calc(100vh - 140px);
            }
        }
    </style>
</head>
<body>
    <!-- Background Content -->
    <div class="background-content" id="backgroundContent">
        <div class="page-header">
            <div class="page-header-top">
                <div class="page-header-heading">
                    <h1 class="main-title" style="margin: 0;">Work Order Converter</h1>
                    <span style="
                        background: #1b1f24;
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 999px;
                        font-size: 0.72rem;
                        font-weight: 600;
                        letter-spacing: 0.4px;
                    ">Admin Only</span>
                </div>
                <div class="header-actions">
                    <button class="back-link" id="backToAdminBtn" type="button">‚Üê Back to admin</button>
                </div>
            </div>
            <p class="subtitle">Convert third-party PDFs to ServiceM8 work orders</p>
        </div>

        <div class="pdf-controls">
            <div class="control-group">
                <span class="control-label">Urgency</span>
                <div class="control-options" data-filter="urgency">
                    <button type="button" class="control-option is-active" data-value="all">All</button>
                    <button type="button" class="control-option" data-value="critical">Critical</button>
                    <button type="button" class="control-option" data-value="urgent">Urgent</button>
                    <button type="button" class="control-option" data-value="standard">Standard</button>
                </div>
            </div>
            <div class="control-group">
                <span class="control-label">Type</span>
                <div class="control-options" data-filter="type">
                    <button type="button" class="control-option is-active" data-value="all">All</button>
                    <button type="button" class="control-option" data-value="work-order">Work Orders</button>
                    <button type="button" class="control-option" data-value="quote">Quote Requests</button>
                </div>
            </div>
            <div class="control-group">
                <span class="control-label">Status</span>
                <div class="control-options" data-filter="status">
                    <button type="button" class="control-option is-active" data-value="all">All</button>
                    <button type="button" class="control-option" data-value="review">Needs review</button>
                    <button type="button" class="control-option" data-value="created">Job created</button>
                    <button type="button" class="control-option" data-value="info-requested">Info requested</button>
                    <button type="button" class="control-option" data-value="declined">Request declined</button>
                </div>
            </div>
            <div class="control-group">
                <span class="control-label">Sort</span>
                <select id="pdfSortSelect" class="control-select">
                    <option value="priority">Priority (urgency ‚Üí newest)</option>
                    <option value="newest">Newest first</option>
                    <option value="oldest">Oldest first</option>
                </select>
            </div>
        </div>


        <!-- PDF History -->
        <div class="pdf-history" id="pdfHistory"></div>
    </div>

    <!-- Changes Indicator (Hidden) -->
    <div class="changes-indicator" id="changesIndicator" style="display: none;">
        ‚úèÔ∏è You have unsaved changes
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fabButton">
        <span class="fab-icon">+</span>
    </button>

    <!-- PDF Processing Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">üì§ Upload Work Orders</h2>
                    <p class="modal-subtitle">Convert PDFs to ServiceM8 jobs</p>
                </div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Upload modal content would go here...</p>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-modal" id="pdfViewerModal">
        <div class="pdf-viewer-content">
            <div class="pdf-viewer-header">
                <h3 class="pdf-viewer-title" id="pdfViewerTitle">Work Order Details</h3>
                <button class="pdf-viewer-close" id="pdfViewerClose">&times;</button>
            </div>
            <div class="pdf-viewer-body">
                <div class="pdf-panel">
                    <div class="pdf-panel-header original">üìÑ Original PDF</div>
                    <iframe class="pdf-frame" id="originalPdfFrame" src=""></iframe>
                </div>
                <div class="parsed-fields-panel">
                    <div class="pdf-panel-header fields">
                        üìù Work Order Fields
                        <span class="panel-status" id="panelStatusBadge"></span>
                    </div>
                    <div class="parsed-fields-content" id="parsedFieldsContent">
                        <!-- Fields will be dynamically generated here -->
                    </div>
                    <div class="field-actions">
                        <button class="btn btn-primary" id="saveFieldsBtn">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements - with null checks
        const fabButton = document.getElementById('fabButton');
        const pdfModal = document.getElementById('pdfModal');
        const modalClose = document.getElementById('modalClose');
        const backgroundContent = document.getElementById('backgroundContent');
        const pdfHistory = document.getElementById('pdfHistory');
        const pdfViewerModal = document.getElementById('pdfViewerModal');
        const pdfViewerClose = document.getElementById('pdfViewerClose');
        const pdfViewerTitle = document.getElementById('pdfViewerTitle');
        const originalPdfFrame = document.getElementById('originalPdfFrame');
        const backToAdminBtn = document.getElementById('backToAdminBtn');
        const filterGroups = document.querySelectorAll('.control-options');
        const sortSelect = document.getElementById('pdfSortSelect');

        const STATUS_STORAGE_KEY = 'worksight-statuses-v1';
        let statusState = loadStatusState();
        let currentEditMode = true;
        let fieldInputs = [];

        const filters = {
            urgency: 'all',
            type: 'all',
            status: 'all'
        };

        const STATUS_LABELS = {
            review: 'Needs review',
            created: 'Job created',
            'info-requested': 'Info requested',
            declined: 'Request declined'
        };

        let currentSort = 'priority';

        function resolveAdminDashboardUrl() {
            const { origin, pathname } = window.location;
            const segments = pathname.split('/');
            if (segments.length) {
                segments.pop();
            }

            let basePath = segments.join('/');

            if (!basePath || basePath === '') {
                basePath = '/';
            }

            if (!basePath.startsWith('/')) {
                basePath = `/${basePath}`;
            }

            if (!basePath.endsWith('/')) {
                basePath = `${basePath}/`;
            }

            return `${origin}${basePath}#/admin/dashboard`;
        }

        function redirectToAdminDashboard() {
            const adminUrl = resolveAdminDashboardUrl();
            window.location.href = adminUrl;
        }

        if (backToAdminBtn) {
            backToAdminBtn.addEventListener('click', redirectToAdminDashboard);
        }

        filterGroups.forEach(group => {
            group.addEventListener('click', (event) => {
                const button = event.target.closest('.control-option');
                if (!button) {
                    return;
                }

                const filterType = group.getAttribute('data-filter');
                const value = button.getAttribute('data-value');

                if (!filterType || !value) {
                    return;
                }

                if (filters[filterType] === value) {
                    return;
                }

                filters[filterType] = value;
                renderFilterState();
                generatePdfHistory();
            });
        });

        if (sortSelect) {
            sortSelect.addEventListener('change', (event) => {
                const value = event.target.value;
                currentSort = value;
                generatePdfHistory();
            });
        }


        // Reference work orders for production use
        const referenceWorkOrders = [
            {
                name: "PO1540-RP01-001_2 Tarcoola Ln Uki.pdf",
                pages: 1,
                confidence: 95,
                processedAt: new Date(Date.now() - 3 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Critical',
                originalUrl: "./pdfs/PO1540-RP01-001_2 Tarcoola Ln Uki.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO1540-RP01-001", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Assessment", confidence: 95 },
                        "job_description": { value: "Please attend site to assess x1 chest freezer and dishwasher that was damaged after an electrical storm", confidence: 94, type: "textarea" },
                        "date_issued": { value: "10 Jun 2024", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Robert S", confidence: 95 },
                        "last": { value: "Mitchell", confidence: 95 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0412261044", confidence: 94 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98, type: "textarea" },
                        "site_city": { value: "Uki", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2484", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.3667", confidence: 85 },
                        "longitude": { value: "153.3167", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=PO1540-RP01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "Work Notes & Checklists": {
                        "parsing_rules_applied": { value: "ETS standard electrical assessment protocol", confidence: 99, type: "textarea" },
                        "safety_requirements": { value: "‚Ä¢ Complete risk assessment before site entry\n‚Ä¢ Verify power isolation procedures\n‚Ä¢ Use PPE as per ETS safety guidelines", confidence: 95, type: "textarea" },
                        "work_checklist": { value: "‚òê Site risk assessment completed\n‚òê Visual inspection of damaged appliances\n‚òê Electrical testing performed\n‚òê Test results documented\n‚òê Customer sign-off obtained", confidence: 90, type: "textarea" },
                        "compliance_notes": { value: "Work to be completed in accordance with AS/NZS 3760:2010 - In-service safety inspection and testing of electrical equipment", confidence: 85, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "8a8ac91d-4d8a-47b6-8935-205aa57e3beb", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98 },
                        "billing_address": { value: "2 Tarcoola Ln, Uki NSW 2484", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-06-10", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Electrical assessment of storm-damaged appliances", confidence: 92 },
                        "generated_job_id": { value: "1", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2024-06-10 15:08", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.3167", confidence: 85 },
                        "job_lat": { value: "-28.3667", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2484", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Uki", confidence: 98 },
                        "geo_street": { value: "Tarcoola Ln", confidence: 98 },
                        "geo_number": { value: "2", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "1", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "category_uuid": { value: "", confidence: 0 },
                        "queue_uuid": { value: "", confidence: 0 },
                        "quote_expiry_date": { value: "", confidence: 0 },
                        "quote_sent": { value: "false", confidence: 95, type: "select", options: ["true", "false"] },
                        "invoice_sent": { value: "false", confidence: 95, type: "select", options: ["true", "false"] },
                        "purchase_order_number": { value: "PO1540-RP01-001", confidence: 99 },
                        "job_description": { value: "Electrical Report - Storm damage assessment", confidence: 94, type: "textarea" },
                        "created_by_staff_uuid": { value: "dadb2bd3-a039-47bf-8716", confidence: 85 }
                    }
                }
            },
            {
                name: "PO8057-BU01-001_upgraded.pdf",
                pages: 3,
                confidence: 88,
                processedAt: new Date(Date.now() - 5 * 60 * 60 * 1000),
                status: 'created',
                urgency: 'Urgent',
                originalUrl: "./pdfs/PO8057-BU01-001_upgraded.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO8057-BU01-001", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Multi-Trade Services", confidence: 95 },
                        "job_description": { value: "Carpentry\nGarage Shed\nRemove and replace damaged Clip-lok wall sheets> Remove and reinstate window to allow replacement of wall sheeting\nMaterials: Clip-lok sheets, fixings, sealing materials, protective gear, consumables\nAll amounts shown are exclusive of GST.\nCarpet\nBedroom 1\nCarry out carpet cleaning to room, applying anti-microbial agents\nStore Room\nCarry out carpet cleaning to room, applying anti-microbial agents\nAll amounts shown are exclusive of GST.\nElectrical\nHall\nRemove and replace 2x downlights\nAll amounts shown are exclusive of GST.\nGeneral\nWaste Removal\nSkip Bin 4m3\nAll amounts shown are exclusive of GST.\nGeneral Note\nRemovalist\nCover belongings for duration of works\nRemove and reinstate furnishings\nAll amounts shown are exclusive of GST.\nGeneral Works\nRoof\nProvisional Sum - Remove and replace damaged TV antenna\nRemove and replace solar light\nAll amounts shown are exclusive of GST.\nPainting\nHall\nPrepare and paint ceilings 8m2\nPrepare and paint walls 30m2\nAll amounts shown are exclusive of GST.\nPlumber\nExternal\nRemove and replace airconditioner shroud cover to split system\nAll amounts shown are exclusive of GST.\nRoofer\nMain Roof\nRemove and replace damage polycarbonate sheeting\nMaterials: polycarbonate sheets, fixings, consumables\nAll amounts shown are exclusive of GST.\nScaffolding/Access Equipment\nScaffolding\nMobile Scaffold\nAll amounts shown are exclusive of GST.\nTotal\nSub Total $12,057.78\nGST $1,205.79\nTotal AUD $13,263.57", confidence: 92, type: "textarea" },
                        "date_issued": { value: "3 Jul 2025", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 },
                        "total_amount": { value: "$13,263.57", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Woollam Constructions", confidence: 98 }
                    },
                    "Site Contact": {
                        "first": { value: "Anna T", confidence: 96 },
                        "last": { value: "BOSTON", confidence: 96 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0402 254 758", confidence: 94 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98, type: "textarea" },
                        "site_city": { value: "Armidale", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2350", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-30.5128", confidence: 85 },
                        "longitude": { value: "151.6669", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=PO8057-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "7b9bc82e-5e9b-48c7-9a46-316bb68f4cec", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98 },
                        "billing_address": { value: "233 Dumaresq St, Armidale NSW 2350", confidence: 98 },
                        "job_status": { value: "Work Order", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2025-07-03", confidence: 96 },
                        "work_order_date": { value: "2025-07-03", confidence: 96 },
                        "work_done_description": { value: "Multi-trade repairs: wall sheets, carpet cleaning, electrical, general repairs", confidence: 92 },
                        "generated_job_id": { value: "2", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "13263.57", confidence: 94 },
                        "edit_date": { value: "2025-07-03 14:22", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.6669", confidence: 85 },
                        "job_lat": { value: "-30.5128", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2350", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Armidale", confidence: 98 },
                        "geo_street": { value: "Dumaresq St", confidence: 98 },
                        "geo_number": { value: "233", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "13263.57", confidence: 94 },
                        "purchase_order_number": { value: "PO8057-BU01-001", confidence: 99 },
                        "job_description": { value: "Multi-trade repairs: wall sheets, carpet cleaning, electrical", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "QR9973-BU01-001.pdf",
                pages: 3,
                confidence: 89,
                processedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "./pdfs/QR9973-BU01-001.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "QR9973-BU01-001", confidence: 99 },
                        "document_type": { value: "Quote Request", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Multi-Trade Services", confidence: 95 },
                        "job_description": { value: "Multi-trade construction project requiring carpentry, electrical installation and certification, roofing repairs including replacement of damaged sections, solar panel maintenance and electrical connection work. Scope includes structural repairs to roof framework, installation of new electrical circuits to meet current Australian standards, certification of electrical work by licensed electrician, and solar panel system inspection and repairs as required. Work to be completed in stages with electrical certification provided upon completion of each phase.", confidence: 90, type: "textarea" },
                        "date_issued": { value: "16 Jul 2025", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 },
                        "reference": { value: "9973", confidence: 97 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Woollam Constructions", confidence: 98 }
                    },
                    "Site Contact": {
                        "first": { value: "Olive", confidence: 96 },
                        "last": { value: "Boston", confidence: 96 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 }
                    },
                    "Job Location": {
                        "site_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98, type: "textarea" },
                        "site_city": { value: "Armidale", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2350", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-30.5169", confidence: 85 },
                        "longitude": { value: "151.6747", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=QR9973-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "9c0de93f-6f0c-59d8-0b57-427cc79g5ded", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98 },
                        "billing_address": { value: "286 Beardy St, Armidale NSW 2350", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2025-07-16", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Multi-trade construction project requiring carpentry, electrical installation and certification, roofing repairs including replacement of damaged sections, solar panel maintenance and electrical connection work. Scope includes structural repairs to roof framework, installation of new electrical circuits to meet current Australian standards, certification of electrical work by licensed electrician, and solar panel system inspection and repairs as required. Work to be completed in stages with electrical certification provided upon completion of each phase.", confidence: 90 },
                        "generated_job_id": { value: "3", confidence: 89 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2025-07-16 09:15", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.6747", confidence: 85 },
                        "job_lat": { value: "-30.5169", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2350", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Armidale", confidence: 98 },
                        "geo_street": { value: "Beardy St", confidence: 98 },
                        "geo_number": { value: "286", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "purchase_order_number": { value: "QR9973-BU01-001", confidence: 99 },
                        "job_description": { value: "Multi-trade construction project requiring carpentry, electrical installation and certification, roofing repairs including replacement of damaged sections, solar panel maintenance and electrical connection work. Scope includes structural repairs to roof framework, installation of new electrical circuits to meet current Australian standards, certification of electrical work by licensed electrician, and solar panel system inspection and repairs as required. Work to be completed in stages with electrical certification provided upon completion of each phase.", confidence: 90, type: "textarea" }
                    }
                }
            },
            {
                name: "PO38935_Farmcote.pdf",
                pages: 1,
                confidence: 96,
                processedAt: new Date(Date.now() - 30 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "./pdfs/PO38935_Farmcote.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Highforce Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "PO38935", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Installation", confidence: 95 },
                        "job_description": { value: "Supply and install 10 metres of 25mm¬≤ armoured cable for electrical connection from main house to shed at Farmcote property. Work includes excavation of cable route to appropriate depth as per AS/NZS 3000, installation of underground cable protection, connection of cable to switchboard in main house and installation of sub-board in shed. All work to be carried out in accordance with Australian Standard AS/NZS 3000 and local electricity authority requirements. Electrical testing and certification to be provided upon completion. Site safety assessment and appropriate safety measures to be implemented during excavation and installation works.", confidence: 94, type: "textarea" },
                        "date_issued": { value: "15 Sep 2024", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 },
                        "total_amount": { value: "$2,450.00", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "Sarah", confidence: 95 },
                        "last_name": { value: "Mitchell", confidence: 95 },
                        "email": { value: "sarah@highforce.com.au", confidence: 98 },
                        "phone": { value: "0420 524 997", confidence: 98 },
                        "role": { value: "Project Manager", confidence: 96 },
                        "company": { value: "Highforce Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "David", confidence: 96 },
                        "last": { value: "Farmcote", confidence: 96 },
                        "type": { value: "PROPERTY_MANAGER", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0487 621 334", confidence: 94 },
                        "email": { value: "david@farmcote.com.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98, type: "textarea" },
                        "site_city": { value: "Uki", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2484", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.3667", confidence: 85 },
                        "longitude": { value: "153.3167", confidence: 85 }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "9c0dc93f-6f0c-49d8-9b57-427cc79g5dfd", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98 },
                        "billing_address": { value: "1247 Kyogle Road, Uki NSW 2484", confidence: 98 },
                        "job_status": { value: "Quote", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-09-15", confidence: 96 },
                        "work_order_date": { value: "", confidence: 0 },
                        "work_done_description": { value: "Electrical cable installation for shed connection", confidence: 92 },
                        "generated_job_id": { value: "5", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "2450.00", confidence: 94 },
                        "edit_date": { value: "2024-09-15 10:30", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "58g3h554-45c7-5b26-955c-316bb79h6gge", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.3167", confidence: 85 },
                        "job_lat": { value: "-28.3667", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2484", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Uki", confidence: 98 },
                        "geo_street": { value: "Kyogle Road", confidence: 98 },
                        "geo_number": { value: "1247", confidence: 98 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "2450.00", confidence: 94 },
                        "purchase_order_number": { value: "PO38935", confidence: 99 },
                        "job_description": { value: "Supply and install 10 metres of 25mm¬≤ armoured cable for electrical connection from main house to shed at Farmcote property. Work includes excavation of cable route to appropriate depth as per AS/NZS 3000, installation of underground cable protection, connection of cable to switchboard in main house and installation of sub-board in shed. All work to be carried out in accordance with Australian Standard AS/NZS 3000 and local electricity authority requirements. Electrical testing and certification to be provided upon completion. Site safety assessment and appropriate safety measures to be implemented during excavation and installation works.", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "Jobcard_For_Job_No_58815.pdf",
                pages: 2,
                confidence: 94,
                processedAt: new Date(Date.now() - 6 * 60 * 60 * 1000),
                status: 'review',
                urgency: 'Standard',
                originalUrl: "./pdfs/Jobcard_For_Job_No_58815.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "O'Brien Electrical & Plumbing Lismore", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "58815", confidence: 99 },
                        "document_type": { value: "Work Order", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Electrical Repair", confidence: 95 },
                        "job_description": { value: "Located in refreshments. Please attend to investigate and repair the television (refreshment screen number 3) screen that is not operating. The screen is black.", confidence: 94, type: "textarea" },
                        "date_issued": { value: "22 Sep 2024", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 },
                        "work_limit": { value: "$300", confidence: 94 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "Lisa", confidence: 95 },
                        "last_name": { value: "O'Brien", confidence: 95 },
                        "email": { value: "lisa@obrienelectrical.com.au", confidence: 98 },
                        "phone": { value: "02 6621 3399", confidence: 98 },
                        "role": { value: "Office Manager", confidence: 96 },
                        "company": { value: "O'Brien Electrical & Plumbing Lismore", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Reception", confidence: 85 },
                        "last": { value: "Desk", confidence: 85 },
                        "type": { value: "JOB", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "02 6620 1911", confidence: 94 },
                        "email": { value: "reception@lifeblood.com.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98, type: "textarea" },
                        "site_city": { value: "Lismore", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2480", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-28.8122", confidence: 85 },
                        "longitude": { value: "153.2778", confidence: 85 },
                        "venue_name": { value: "Lifeblood Lismore Donor Centre", confidence: 96 }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "ad3ef45g-7h8i-50j9-ak6l-538dd90m7nop", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98 },
                        "billing_address": { value: "1/26 Bounty Street, Lismore NSW 2480", confidence: 98 },
                        "job_status": { value: "Work Order", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-09-22", confidence: 96 },
                        "work_order_date": { value: "2024-09-22", confidence: 96 },
                        "work_done_description": { value: "Electrical repair - TV screen not operating", confidence: 92 },
                        "generated_job_id": { value: "4", confidence: 88 },
                        "completion_date": { value: "", confidence: 0 },
                        "payment_date": { value: "", confidence: 0 },
                        "payment_method": { value: "", confidence: 0 },
                        "payment_amount": { value: "0", confidence: 0 },
                        "edit_date": { value: "2024-09-22 14:30", confidence: 96 },
                        "ready_to_invoice": { value: "0", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "68h4i665-56d8-6c37-a66d-427dd80i7hhf", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "153.2778", confidence: 85 },
                        "job_lat": { value: "-28.8122", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2480", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Lismore", confidence: 98 },
                        "geo_street": { value: "Bounty Street", confidence: 98 },
                        "geo_number": { value: "1/26", confidence: 95 },
                        "payment_processed": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "0", confidence: 0, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "0.0000", confidence: 0 },
                        "purchase_order_number": { value: "3391", confidence: 99 },
                        "job_description": { value: "Electrical repair - TV screen not operating", confidence: 92, type: "textarea" }
                    }
                }
            },
            {
                name: "QR11604-BU01-001_66 Wollombi Rd Cessnock NSW 2325.pdf",
                pages: 2,
                confidence: 92,
                processedAt: new Date(Date.now() - 18 * 60 * 60 * 1000),
                status: 'created',
                urgency: 'Standard',
                originalUrl: "./pdfs/QR11604-BU01-001_66 Wollombi Rd Cessnock NSW 2325.pdf",
                parsedFields: {
                    "Source Company": {
                        "company_name": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Work Order Details": {
                        "order_number": { value: "QR11604-BU01-001", confidence: 99 },
                        "document_type": { value: "Quote Request", confidence: 99, type: "select", options: ["Work Order", "Quote Request"] },
                        "work_type": { value: "Asbestos Removal & Roofing", confidence: 95 },
                        "job_description": { value: "Asbestos Removal\nMain Roof\nRemove & Dispose - Provide : clearance certificate for asbestos related activities\nRemove & Dispose - Provide : LAB TESTING for ACM (Asbestos containing material) by taking samples from the following Each\nAttend site to inspect and report on the roof cavity, provide a scope of works based on your findings for the remediation of the roof cavity thereafter.- 1 item\nCladding\nMain Roof\nCladding - Other total\nCleaning\nBuilders Clean\nProvide - Labour for cleaning Remove and dispose of trade waste and debris\nProvide - Allowance for residential builders cleaning to affected areas - single room\nElectrical\nMain Roof\nRemove & Refit - Tv antenna - includes up to 30 mins tuning - includes fall protection as required\nElectrical total\nExternal Works\nScaffolding\nSupply & Install - Allowance for scaffold- mobile tower highset - delivery/setup, removal - to extend min 1000mm above the roof - jsa/swms to be provided to claim central prior to works starting\nMain Roof: Supply & Install - Allowance for scaffold- Edge protection - delivery/setup, removal - to extend to under the roof - jsa/swms to be provided to claim central prior to works starting\nGeneral Works\nContents Removalist\nProvide - Remove and reinstate : furniture - per room rate - store onsite in secure facility and reinstate upon completion of works\nMake Safe Roof\nMain Roof\nSupply & Install - Roof tarping single story up to 120m2 secured\nMetal Fascias And Gutters total\nPainting\nSunroom\nPrepare and Paint - Prepare and paint - eaves lining - inc trims/cover strips - seal/paint/finish to match existing as close as possible - inc dropsheets\nRoofing Metal\nMain Roof\nRemove & Dispose - Remove from site all super 6 asbestos roof sheeting to the property- 104m2\nRemove, Supply & Install - 40mm metal top hat roof battens inc screws\nRemove, Supply & Install - R1.3 - roof sarking\nSupply & Install - Dry pan flashing- zinc finish\nSupply & Install - Penetrations - rubber/dektite - complete\nSupply & Install - Coloured steel corrugated roofing including clip, fixings and all associated flashings , barge, ridge & hip capping's up to 250mm-check pitch for compliance prior to commencing repairs - to match existing as close as possible\nSkip Bin\nRubbish Removal\nAllowance - Allowance for up to 9 m3 waste bin\nPlease submit quote online using submission link in email sent.", confidence: 94, type: "textarea" },
                        "date_issued": { value: "20 Aug 2024", confidence: 96 },
                        "assigned_to": { value: "", confidence: 0 }
                    },
                    "Work Order Issuer": {
                        "first_name": { value: "", confidence: 0 },
                        "last_name": { value: "", confidence: 0 },
                        "email": { value: "", confidence: 0 },
                        "phone": { value: "", confidence: 0 },
                        "role": { value: "", confidence: 0 },
                        "company": { value: "Emergency Trade Services Pty Ltd", confidence: 99 }
                    },
                    "Site Contact": {
                        "first": { value: "Margaret", confidence: 95 },
                        "last": { value: "Chen", confidence: 95 },
                        "type": { value: "BILLING", confidence: 99, type: "select", options: ["JOB", "BILLING", "PROPERTY_MANAGER"] },
                        "is_primary_contact": { value: "true", confidence: 95, type: "select", options: ["true", "false"] },
                        "mobile": { value: "0423 891 556", confidence: 94 },
                        "email": { value: "margaret.chen@cessnockhealth.nsw.gov.au", confidence: 96 }
                    },
                    "Job Location": {
                        "site_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98, type: "textarea" },
                        "site_city": { value: "Cessnock", confidence: 98 },
                        "site_state": { value: "NSW", confidence: 99 },
                        "site_postcode": { value: "2325", confidence: 99 },
                        "country": { value: "Australia", confidence: 99 },
                        "latitude": { value: "-32.8341", confidence: 85 },
                        "longitude": { value: "151.3561", confidence: 85 }
                    },
                    "QR Code Data": {
                        "qr_content": { value: "https://etsaus.com.au/risk-assessment?job=QR11604-BU01-001", confidence: 85, type: "textarea" },
                        "qr_type": { value: "Risk Assessment Link", confidence: 90 },
                        "qr_instructions": { value: "Please scan & complete site risk assessment before proceeding with works", confidence: 95, type: "textarea" }
                    },
                    "ServiceM8 API Fields": {
                        "job_uuid": { value: "ad3ef45g-7h8i-50j9-ak6l-538dd90m7nop", confidence: 85 },
                        "job_active": { value: "1", confidence: 99, type: "select", options: ["0", "1"] },
                        "job_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98 },
                        "billing_address": { value: "66 Wollombi Rd, Cessnock NSW 2325", confidence: 98 },
                        "job_status": { value: "Completed", confidence: 95, type: "select", options: ["Quote", "Pending", "Work Order", "Completed"] },
                        "quote_date": { value: "2024-08-20", confidence: 96 },
                        "work_order_date": { value: "2024-08-25", confidence: 96 },
                        "work_done_description": { value: "Fire safety inspection and testing completed successfully", confidence: 92 },
                        "generated_job_id": { value: "6", confidence: 88 },
                        "completion_date": { value: "2024-08-27", confidence: 96 },
                        "payment_date": { value: "2024-09-05", confidence: 94 },
                        "payment_method": { value: "EFT", confidence: 95 },
                        "payment_amount": { value: "850.00", confidence: 94 },
                        "edit_date": { value: "2024-08-27 16:45", confidence: 96 },
                        "ready_to_invoice": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "company_uuid": { value: "47f2f443-34b6-4a15-944b-205aa4d9f06b", confidence: 85 },
                        "geo_is_valid": { value: "1", confidence: 85, type: "select", options: ["0", "1"] },
                        "job_lng": { value: "151.3561", confidence: 85 },
                        "job_lat": { value: "-32.8341", confidence: 85 },
                        "geo_country": { value: "Australia", confidence: 99 },
                        "geo_postcode": { value: "2325", confidence: 99 },
                        "geo_state": { value: "NSW", confidence: 99 },
                        "geo_city": { value: "Cessnock", confidence: 98 },
                        "geo_street": { value: "Wollombi Rd", confidence: 98 },
                        "geo_number": { value: "66", confidence: 98 },
                        "payment_processed": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "payment_received": { value: "1", confidence: 95, type: "select", options: ["0", "1"] },
                        "total_invoice_amount": { value: "850.00", confidence: 94 },
                        "purchase_order_number": { value: "QR11604-BU01-001", confidence: 99 },
                        "job_description": { value: "Annual fire safety inspection - Cessnock Health Centre", confidence: 92, type: "textarea" }
                    }
                }
            }
        ];
        referenceWorkOrders.forEach(applyStoredStatus);

        function loadStatusState() {
            if (typeof localStorage === 'undefined') {
                return {};
            }
            try {
                const raw = localStorage.getItem(STATUS_STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (error) {
                console.warn('Failed to load stored work order statuses.', error);
                return {};
            }
        }

        function saveStatusState() {
            if (typeof localStorage === 'undefined') {
                return;
            }
            try {
                localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(statusState));
            } catch (error) {
                console.warn('Failed to persist work order statuses.', error);
            }
        }

        function getCurrentUserName() {
            const user = window.currentUser?.name || window.currentUser?.email;
            return user || 'Reviewer';
        }

        function getWorkOrderKey(pdf) {
            const orderNumber = pdf?.parsedFields?.['Work Order Details']?.order_number?.value;
            return orderNumber || pdf?.name || `pdf-${Math.random().toString(36).slice(2)}`;
        }

        function applyStoredStatus(pdf) {
            const key = getWorkOrderKey(pdf);
            const stored = statusState[key];
            if (!stored) {
                return pdf;
            }

            if (stored.status) {
                pdf.status = stored.status;
            }

            if (stored.jobNumber && pdf?.parsedFields?.['ServiceM8 API Fields']?.generated_job_id) {
                pdf.parsedFields['ServiceM8 API Fields'].generated_job_id.value = stored.jobNumber;
            }

            pdf.statusMeta = stored;
            return pdf;
        }

        function applyStoredStatusToAll() {
            referenceWorkOrders.forEach(applyStoredStatus);
        }

        // Mini Client Table for Company Identification and Parsing Rules
        const clientCompanies = {
            'Emergency Trade Services Pty Ltd': {
                id: 'ets',
                name: 'Emergency Trade Services Pty Ltd',
                abn: '73 805 498 934',
                phone: '1300 755 455',
                email: 'admin@etsaus.com.au',
                website: 'www.etsaus.com.au',
                servicem8_company_uuid: '47f2f443-34b6-4a15-944b-205aa4d9f06b',
                parsing_rules: {
                    document_types: ['Work Order', 'Quote Request'],
                    order_number_pattern: /^(PO|QR)\d{4}-[A-Z]{2}\d{2}-\d{3}$/,
                    standard_work_types: ['Electrical Report', 'Electrical assessment', 'Fire Safety Inspection'],
                    qr_code_base_url: 'https://etsaus.com.au/risk-assessment?job=',
                    urgency_keywords: {
                        critical: ['emergency', 'safety', 'power outage', 'failure'],
                        urgent: ['same day', 'next day', 'repair', 'not working'],
                        standard: ['assessment', 'inspection', 'quote']
                    }
                }
            },
            'Highforce Pty Ltd': {
                id: 'highforce',
                name: 'Highforce Pty Ltd',
                abn: '12 345 678 901',
                phone: '0420 524 997',
                email: 'admin@highforce.com.au',
                website: 'https://www.highforce.com.au/',
                servicem8_company_uuid: '58g3g554-45c7-5b26-055c-316bb79h6fed',
                parsing_rules: {
                    document_types: ['Purchase Order', 'Work Request'],
                    order_number_pattern: /^PO\d{5}$/,
                    standard_work_types: ['Construction', 'Civil Works', 'Site Preparation'],
                    urgency_keywords: {
                        critical: ['urgent', 'emergency', 'safety'],
                        urgent: ['asap', 'priority', 'immediate'],
                        standard: ['standard', 'routine', 'planned']
                    }
                }
            },
            "O'Brien Electrical & Plumbing": {
                id: 'obrien',
                name: "O'Brien Electrical & Plumbing",
                abn: '98 765 432 109',
                phone: '1300 6273436',
                email: 'jobs@obrien.com.au',
                website: 'https://www.obrien.com.au/',
                servicem8_company_uuid: '69h4h665-56d8-6c37-166d-427cc89i7gfe',
                parsing_rules: {
                    document_types: ['Job Card', 'Service Request'],
                    order_number_pattern: /^Job No\.?\s*\d+$/,
                    standard_work_types: ['Electrical Service', 'Plumbing Service', 'Maintenance'],
                    urgency_keywords: {
                        critical: ['emergency', 'urgent', 'no power', 'flooding'],
                        urgent: ['same day', 'asap', 'priority'],
                        standard: ['service', 'maintenance', 'routine']
                    }
                }
            }
        };

        // Function to identify company from parsed data
        function identifyCompany(parsedFields) {
            const sourceCompany = parsedFields["Source Company"]?.company_name?.value;
            const companyDetails = parsedFields["Company Details"];

            if (sourceCompany) {
                return clientCompanies[sourceCompany] || null;
            }

            // Fallback: try to match by phone, email, or ABN
            for (const [companyName, company] of Object.entries(clientCompanies)) {
                if (companyDetails?.phone?.value === company.phone ||
                    companyDetails?.email?.value === company.email ||
                    companyDetails?.abn?.value === company.abn) {
                    return company;
                }
            }

            return null;
        }

        let pdfRecords = [...referenceWorkOrders];
        let currentPdfData = null;
        let originalFieldValues = {};
        let hasUnsavedChanges = false;

        function normalizeUrgency(value) {
            if (!value) return 'standard';
            const normalized = value.toLowerCase();
            if (normalized.includes('critical') || normalized.includes('emergency')) return 'critical';
            if (normalized.includes('urgent')) return 'urgent';
            return 'standard';
        }

        function tidyText(value) {
            if (typeof value !== 'string') {
                return value;
            }
            return value.replace(/\s+/g, ' ').trim();
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function shortenText(value, limit = 140) {
            if (typeof value !== 'string') {
                return value;
            }
            const trimmed = value.trim();
            if (trimmed.length <= limit) {
                return trimmed;
            }
            return `${trimmed.slice(0, limit - 1).trim()}‚Ä¶`;
        }

        function formatRelativeDate(date) {
            const now = new Date();
            const diffInHours = Math.round((now - date) / (1000 * 60 * 60));

            if (diffInHours < 1) return 'just now';
            if (diffInHours === 1) return '1 hour ago';
            if (diffInHours < 24) return `${diffInHours} hours ago`;

            const diffInDays = Math.round(diffInHours / 24);
            if (diffInDays === 1) return '1 day ago';
            if (diffInDays < 7) return `${diffInDays} days ago`;

            const diffInWeeks = Math.round(diffInDays / 7);
            if (diffInWeeks === 1) return '1 week ago';
            if (diffInWeeks < 4) return `${diffInWeeks} weeks ago`;

            const diffInMonths = Math.round(diffInDays / 30);
            if (diffInMonths === 1) return '1 month ago';
            return `${diffInMonths} months ago`;
        }

        function renderFilterState() {
            filterGroups.forEach(group => {
                const filterType = group.getAttribute('data-filter');
                const activeValue = filters[filterType];

                group.querySelectorAll('.control-option').forEach(button => {
                    if (button.getAttribute('data-value') === activeValue) {
                        button.classList.add('is-active');
                    } else {
                        button.classList.remove('is-active');
                    }
                });
            });

            if (sortSelect) {
                sortSelect.value = currentSort;
            }
        }

        function getDocTypeKey(pdf) {
            const documentType = pdf.parsedFields?.["Work Order Details"]?.document_type?.value || '';
            const normalized = documentType.toLowerCase();
            if (normalized.includes('quote')) {
                return 'quote';
            }
            if (normalized.includes('work')) {
                return 'work-order';
            }
            return 'general';
        }

        function getProcessedTimestamp(pdf) {
            if (!pdf.processedAt) {
                return 0;
            }

            const date = pdf.processedAt instanceof Date ? pdf.processedAt : new Date(pdf.processedAt);
            const time = date.getTime();
            return Number.isFinite(time) ? time : 0;
        }

        function normalizeStatus(value) {
            const raw = (value || 'review').toLowerCase();
            if (raw === 'processing' || raw === 'committed' || raw === 'sent' || raw === 'created') {
                return 'created';
            }
            if (raw === 'info-requested' || raw === 'info requested' || raw === 'information requested') {
                return 'info-requested';
            }
            if (raw === 'declined' || raw === 'request declined' || raw === 'rejected') {
                return 'declined';
            }
            return 'review';
        }

        function applyFilters(pdfs) {
            return pdfs.filter(pdf => {
                const urgency = normalizeUrgency(pdf.urgency);
                const docType = getDocTypeKey(pdf);
                const normalizedStatus = normalizeStatus(pdf.status);

                if (filters.urgency !== 'all' && urgency !== filters.urgency) {
                    return false;
                }

                if (filters.type !== 'all' && docType !== filters.type) {
                    return false;
                }

                if (filters.status !== 'all' && normalizedStatus !== filters.status) {
                    return false;
                }

                return true;
            });
        }

        function sortPdfs(pdfs) {
            const urgencyOrder = { critical: 3, urgent: 2, standard: 1 };
            const copies = [...pdfs];

            return copies.sort((a, b) => {
                const urgencyA = normalizeUrgency(a.urgency);
                const urgencyB = normalizeUrgency(b.urgency);
                const timeA = getProcessedTimestamp(a);
                const timeB = getProcessedTimestamp(b);

                switch (currentSort) {
                    case 'newest':
                        return timeB - timeA;
                    case 'oldest':
                        return timeA - timeB;
                    case 'priority':
                    default: {
                        const urgencyDiff = (urgencyOrder[urgencyB] || 0) - (urgencyOrder[urgencyA] || 0);
                        if (urgencyDiff !== 0) {
                            return urgencyDiff;
                        }
                        return timeB - timeA;
                    }
                }
            });
        }

        function generatePdfHistory() {
            const container = document.getElementById('pdfHistory');
            if (!container) {
                console.error('pdfHistory container not found!');
                return;
            }

            container.innerHTML = '<div style="padding: 20px;">Loading PDF records...</div>';

            if (!referenceWorkOrders || referenceWorkOrders.length === 0) {
                container.innerHTML = '<div style="padding: 20px; color: red;">No PDF records found!</div>';
                return;
            }

            // Get sorted PDFs (Critical > Urgent > Standard, then by time)
        const pdfsToShow = sortPdfs(applyFilters(referenceWorkOrders));

            container.innerHTML = '';

            if (pdfsToShow.length === 0) {
                container.innerHTML = '<div style="padding: 32px; text-align: center; color: #6b7280; border: 1px dashed #dfe3e8; border-radius: 12px;">No documents match the current filters.</div>';
                return;
            }

            pdfsToShow.forEach((pdf, index) => {
                const row = document.createElement('div');
                const urgencyKey = normalizeUrgency(pdf.urgency);
                const normalizedStatusKey = normalizeStatus(pdf.status);

                row.className = `pdf-row urgency-${urgencyKey} status-${normalizedStatusKey}`;
                row.setAttribute('data-index', index.toString());

                const statusLabel = STATUS_LABELS[normalizedStatusKey] || STATUS_LABELS.review;
                const statusMeta = pdf.statusMeta || statusState[getWorkOrderKey(pdf)];
                if (statusMeta?.status === 'overdue') {
                    row.classList.add('overdue');
                }

                const parsedFields = pdf.parsedFields || {};
                const workOrder = parsedFields["Work Order Details"] || {};
                const sourceCompanyFields = parsedFields["Source Company"] || {};
                const jobLocation = parsedFields["Job Location"] || {};

                const documentTypeRaw = workOrder.document_type?.value || '';
                let docTypeKey = 'general';
                if (documentTypeRaw) {
                    const lowered = documentTypeRaw.toLowerCase();
                    if (lowered.includes('quote')) {
                        docTypeKey = 'quote';
                    } else if (lowered.includes('work')) {
                        docTypeKey = 'work-order';
                    }
                }

                const docTypeRaw = documentTypeRaw || (docTypeKey === 'quote' ? 'Quote Request' : docTypeKey === 'work-order' ? 'Work Order' : 'Document');
                const docTypeDisplay = tidyText(docTypeRaw)?.toUpperCase() || 'DOCUMENT';
                const docTypeClass = `doc-type-${docTypeKey}`;

                const urgencyLabel = urgencyKey.charAt(0).toUpperCase() + urgencyKey.slice(1);
                const urgencyIndicator = `<span class="urgency-indicator ${urgencyKey}"><span class="urgency-dot"></span>${escapeHtml(urgencyLabel)}</span>`;

                const identifiedCompany = parsedFields ? identifyCompany(parsedFields) : null;
                const companyNameRaw = tidyText(identifiedCompany?.name || sourceCompanyFields.company_name?.value || '');
                const displayCompanyName = companyNameRaw || 'Unassigned company';

                const reference = tidyText(workOrder.order_number?.value || workOrder.reference?.value || '');
                const referenceLine = reference ? `<div class="company-ref">Ref: ${escapeHtml(reference)}</div>` : '';

                const summary = generateJobSummary(workOrder, sourceCompanyFields, parsedFields);
                const jobScope = tidyText(summary?.description || '') || '';
                const jobSummaryLine = jobScope ? `<div class="pdf-card-scope">${escapeHtml(jobScope)}</div>` : '';

                const processedAt = pdf.processedAt ? new Date(pdf.processedAt) : null;
                const pagesLabel = Number.isFinite(pdf.pages) ? `${pdf.pages} ${pdf.pages === 1 ? 'page' : 'pages'}` : '';
                const uploadedRelative = processedAt ? `uploaded ${formatRelativeDate(processedAt)}` : '';
                const uploadedAbsolute = processedAt ? formatDateTime(processedAt) : '';
                const metaSegments = [];
                if (pagesLabel) {
                    metaSegments.push(pagesLabel);
                }
                const uploadedSegments = [];
                if (uploadedRelative) {
                    uploadedSegments.push(uploadedRelative);
                }
                if (uploadedAbsolute) {
                    uploadedSegments.push(uploadedAbsolute);
                }
                if (uploadedSegments.length) {
                    metaSegments.push(uploadedSegments.join(' ‚Ä¢ '));
                }
                const fileMetaLine = metaSegments.join(' ‚Ä¢ ');

                const locationAddress = tidyText(jobLocation.site_address?.value || '');
                const locationFallback = tidyText([
                    jobLocation.site_city?.value,
                    jobLocation.site_state?.value
                ].filter(Boolean).join(', '));
                const locationLabel = locationAddress || locationFallback || '';
                const locationLine = locationLabel ? `<div class="job-location">${escapeHtml(locationLabel)}</div>` : '';
                const shouldShowDivider = Boolean(jobSummaryLine || locationLine);

                const confidenceScore = Number.isFinite(pdf.confidence) ? `${Math.round(pdf.confidence)}%` : '‚Äì';

                const docTypeHeading = `
                    <div class="pdf-card-heading">
                        <span class="doc-type-label ${docTypeClass}">${escapeHtml(docTypeDisplay)}${displayCompanyName ? ': ' : ''}</span>
                        ${displayCompanyName ? `<span class="heading-company">${escapeHtml(displayCompanyName)}</span>` : ''}
                    </div>
                `;

                row.innerHTML = `
                    <div class="pdf-card-top">
                        <div class="pdf-card-top-left">
                            ${urgencyIndicator}
                        </div>
                        <span class="status-chip"><span class="status-dot ${normalizedStatusKey}"></span>${escapeHtml(statusLabel)}${summary?.jobNumber ? ` ‚Ä¢ <strong>${escapeHtml(summary.jobNumber)}</strong>` : ''}</span>
                    </div>
                    <div class="pdf-card-body">
                        <div class="pdf-card-main">
                            ${docTypeHeading}
                            ${referenceLine}
                            ${jobSummaryLine}
                            ${locationLine}
                            ${shouldShowDivider ? '<div class="info-divider"></div>' : ''}
                            <div class="pdf-file-name">${escapeHtml(pdf.name || 'Untitled document')}</div>
                            ${fileMetaLine ? `<div class="pdf-file-meta">${escapeHtml(fileMetaLine)}</div>` : ''}
                        </div>
                    </div>
                    <div class="pdf-row-footer">
                        <div class="pdf-row-footer-left">
                            <span class="meta-label">Confidence</span>
                            <div class="confidence-scale">${generateConfidenceScale(pdf.confidence)}</div>
                            <span class="confidence-score">${escapeHtml(confidenceScore)}</span>
                        </div>
                        <span class="more-link">Open details</span>
                    </div>
                `;

                row.style.cursor = 'pointer';
                row.onclick = function() {
                    console.log('Card clicked for:', pdf.name);
                    openPdfViewer(pdf);
                };
                container.appendChild(row);
            });
        }

        function openModal() {
            pdfModal.style.display = 'block';
            setTimeout(() => pdfModal.classList.add('show'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            pdfModal.classList.remove('show');
            setTimeout(() => {
                pdfModal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }

        function openPdfViewer(pdf) {
            currentPdfData = pdf;

            // Set the title with document context
            if (pdfViewerTitle) {
                const parsedFields = pdf.parsedFields || {};
                const workOrderFields = parsedFields["Work Order Details"] || {};
                const sourceCompanyFields = parsedFields["Source Company"] || {};
                const summary = generateJobSummary(workOrderFields, sourceCompanyFields, parsedFields);
                const companyName = identifyCompany(parsedFields)?.name || sourceCompanyFields.company_name?.value;

                if (summary && companyName) {
                    pdfViewerTitle.textContent = `${summary.type || 'Document'} ‚Ä¢ ${companyName}`;
                } else if (summary) {
                    pdfViewerTitle.textContent = summary.type || pdf.name;
                } else {
                    pdfViewerTitle.textContent = pdf.name;
                }
            }

            // Set the PDF source
            if (originalPdfFrame) {
                const pdfSource = pdf.originalUrl || `https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf`;
                originalPdfFrame.src = pdfSource;
            }

            // Generate the parsed fields content
            if (pdf.parsedFields) {
                generateParsedFields(pdf.parsedFields, pdf);
                storeOriginalValues(pdf.parsedFields);
            }

            hasUnsavedChanges = false;
            updateChangesIndicator();

            // Show the modal
            if (pdfViewerModal) {
                pdfViewerModal.style.display = 'block';
                setTimeout(() => {
                    if (pdfViewerModal) {
                        pdfViewerModal.classList.add('show');
                    }
                }, 10);
                document.body.style.overflow = 'hidden';
            }
        }

        function generateQuickReview(parsedFields, pdf) {
            const parsedFieldsContent = document.getElementById('parsedFieldsContent');

            // Extract key information for quick review
            const workOrder = parsedFields["Work Order Details"] || {};
            const sourceCompany = parsedFields["Source Company"] || {};
            const location = parsedFields["Job Location"] || {};
            const contact = parsedFields["Site Contact"] || {};
            const serviceM8 = parsedFields["ServiceM8 API Fields"] || {};

            // Derive company details from client table
            const identifiedCompany = identifyCompany(parsedFields);
            const company = identifiedCompany || {
                name: sourceCompany.company_name?.value || 'Unknown Company',
                phone: 'Contact not available',
                email: 'Contact not available',
                abn: 'Not available'
            };

            // Create Quick Review section
            const quickReviewSection = document.createElement('div');
            quickReviewSection.className = 'quick-review-section';

            const urgencyRaw = (pdf.urgency || getCurrentUrgency(workOrder, parsedFields) || 'STANDARD').toUpperCase();
            const urgencyKey = urgencyRaw.toLowerCase();

            const jobValueInfo = assessJobValue(workOrder);
            const explicitHours = extractExplicitHours(workOrder.job_description?.value);
            const jobEfficiency = calculateJobEfficiency(jobValueInfo, explicitHours);
            const travelDistance = estimateTravelDistance(location.site_address?.value);
            const responseTimeInfo = calculateResponseTime(urgencyRaw, workOrder.date_issued?.value, pdf.processedAt);
            const summary = generateJobSummary(workOrder, sourceCompany, parsedFields);

            const docTypeLabel = (summary.type || 'Document').toUpperCase();
            const docTypeKey = docTypeLabel.toLowerCase().includes('quote') ? 'quote' : (docTypeLabel.toLowerCase().includes('work') ? 'work-order' : 'general');

            const displayCompanyName = summary.title?.replace(/^.*?:\s*/, '') || company.name || 'Unknown Company';
            const refValue = summary.reference || workOrder.order_number?.value || 'N/A';
            const jobScope = summary.description ? shortenText(summary.description, 200) : '';

            const locationAddress = tidyText(location.site_address?.value || '');
            const locationFallback = tidyText([
                location.site_city?.value,
                location.site_state?.value
            ].filter(Boolean).join(', '));
            const locationLabel = locationAddress || locationFallback || '';

            const contactName = tidyText([
                contact.first?.value,
                contact.last?.value
            ].filter(Boolean).join(' '));

            const statusDetail = statusMeta ? formatStatusMeta(statusMeta) : '';
            const metaItems = [];
            metaItems.push(`üìå ${escapeHtml(statusLabel)}${statusDetail ? ` ‚Ä¢ ${escapeHtml(statusDetail)}` : ''}`);
            if (summary.jobSummary && summary.jobSummary !== jobScope) {
                metaItems.push(`üõ† ${escapeHtml(summary.jobSummary)}`);
            }
            if (contactName) {
                metaItems.push(`üë§ ${escapeHtml(contactName)}`);
            }
            if (locationLabel) {
                metaItems.push(`üìç ${escapeHtml(locationLabel)}`);
            }

            const metaHtml = metaItems.length ? `<div class="quick-review-meta">${metaItems.map(item => `<span>${item}</span>`).join('')}</div>` : '';

            const quickReviewHTML = `
                <div class="quick-review-card">
                    <div class="quick-review-actions-stick">
                        <div class="quick-review-actions">
                            <button class="quick-action decline" onclick="rejectJob('${workOrder.order_number?.value || ''}')">Decline request</button>
                            <button class="quick-action info" onclick="requestInfo('${workOrder.order_number?.value || ''}')">Request info</button>
                            <button class="quick-action create" onclick="createJob('${workOrder.order_number?.value || ''}')">Create job</button>
                        </div>
                        <button class="quick-edit-toggle" id="editModeToggle">Lock fields</button>
                    </div>
                    <div class="quick-review-top">
                        <div class="quick-review-heading">
                            <span class="quick-review-type ${docTypeKey}">${escapeHtml(docTypeLabel)}</span>
                            <h2 class="quick-review-title">${escapeHtml(displayCompanyName)}</h2>
                            <span class="quick-review-ref">Ref: ${escapeHtml(refValue)}</span>
                        </div>
                        <div class="quick-review-urgency">
                            <span class="urgency-indicator ${urgencyKey}"><span class="urgency-dot"></span>${escapeHtml(urgencyRaw)}</span>
                            <label class="quick-review-urgency-label" for="urgencySelect">Set urgency</label>
                            <select class="urgency-select field-input" data-section="Quick Review" data-field="urgency" id="urgencySelect">
                                <option value="CRITICAL" ${urgencyRaw === 'CRITICAL' ? 'selected' : ''}>Critical</option>
                                <option value="URGENT" ${urgencyRaw === 'URGENT' ? 'selected' : ''}>Urgent</option>
                                <option value="STANDARD" ${urgencyRaw === 'STANDARD' ? 'selected' : ''}>Standard</option>
                            </select>
                        </div>
                    </div>
                    ${jobScope ? `<div class="quick-review-scope">${escapeHtml(jobScope)}</div>` : ''}
                    ${metaHtml}
                    <div class="quick-review-metrics">
                        <div class="quick-metric">
                            <span class="metric-label">Job value</span>
                            <span class="metric-value">${escapeHtml(jobValueInfo.display)}</span>
                            <span class="metric-hint">${escapeHtml(jobValueInfo.subtitle || '')}${jobEfficiency ? ` ‚Ä¢ ${escapeHtml(jobEfficiency)}` : ''}</span>
                        </div>
                        <div class="quick-metric">
                            <span class="metric-label">Response time</span>
                            <span class="metric-value" id="responseTimeValue">${escapeHtml(responseTimeInfo.display)}</span>
                            <span class="metric-hint" id="responseTimeHint">${escapeHtml(responseTimeInfo.subtitle)}</span>
                        </div>
                        <div class="quick-metric">
                            <span class="metric-label">Travel</span>
                            <span class="metric-value">${escapeHtml(travelDistance)}</span>
                            <span class="metric-hint">${escapeHtml(locationLabel || 'Address pending')}</span>
                        </div>
                    </div>
                    <div class="quick-review-note ${urgencyKey}" id="urgencyExplanation">
                        ${renderUrgencyNote(urgencyRaw, responseTimeInfo)}
                    </div>
                </div>
            `;

            quickReviewSection.innerHTML = quickReviewHTML;
            parsedFieldsContent.appendChild(quickReviewSection);

            // Add event listener for urgency field changes
            const urgencySelect = document.getElementById('urgencySelect');
            if (urgencySelect) {
                urgencySelect.addEventListener('change', function(event) {
                    handleFieldChange(event);
                    updateResponseTimeCard(event.target.value);
                    updateUrgencyExplanation(event.target.value);
                });
            }
        }

        function getCurrentUrgency(workOrder, parsedFields) {
            // AI logic to determine urgency based on keywords and context
            const description = (workOrder.job_description?.value || '').toLowerCase();
            const workType = (workOrder.work_type?.value || '').toLowerCase();

            // Critical keywords
            if (description.includes('emergency') || description.includes('safety') ||
                description.includes('power outage') || description.includes('failure') ||
                description.includes('urgent') || description.includes('asap')) {
                return 'CRITICAL';
            }

            // Urgent keywords
            if (description.includes('same day') || description.includes('next day') ||
                workType.includes('repair') || description.includes('not working')) {
                return 'URGENT';
            }

            return 'STANDARD';
        }

        function getUrgencyInfo(urgency) {
            const urgencyMap = {
                'CRITICAL': {
                    response: 'Within 2 hours (24/7)',
                    scheduling: 'ASAP'
                },
                'URGENT': {
                    response: 'Within 4 hours (business hours)',
                    scheduling: '24-48 hours'
                },
                'STANDARD': {
                    response: 'Next business day',
                    scheduling: '5-10 business days'
                }
            };
            return urgencyMap[urgency] || urgencyMap['STANDARD'];
        }

        function getUrgencyExplanation(urgency) {
            const explanations = {
                'CRITICAL': 'üö® Emergency response (24/7) - Safety hazards, active leaks, electrical faults. May incur additional out-of-hours charges.',
                'URGENT': '‚ö° Fast track response (business hours) - Significant disruption to operations requiring quick resolution.',
                'STANDARD': 'üìÖ Normal scheduling - Routine work that can be planned within regular business hours.'
            };
            return explanations[urgency] || explanations['STANDARD'];
        }

        function getCurrentPdf() {
            return currentPdfData;
        }

        function updateResponseTimeCard(newUrgency) {
            const currentPdf = getCurrentPdf();
            if (!currentPdf) return;

            const responseTimeInfo = calculateResponseTime(newUrgency, null, currentPdf.processedAt);

            const responseTimeValue = document.getElementById('responseTimeValue');
            const responseTimeHint = document.getElementById('responseTimeHint');

            if (responseTimeValue) {
                responseTimeValue.textContent = responseTimeInfo.display;
            }
            if (responseTimeHint) {
                responseTimeHint.textContent = responseTimeInfo.subtitle;
            }
        }

        function updateUrgencyExplanation(newUrgency) {
            const urgencyExplanation = document.getElementById('urgencyExplanation');
            if (urgencyExplanation) {
                const normalizedUrgency = newUrgency.toUpperCase();
                urgencyExplanation.className = `quick-review-note ${newUrgency.toLowerCase()}`;
                const currentPdf = getCurrentPdf();
                const responseInfo = currentPdf ? calculateResponseTime(newUrgency, currentPdf.parsedFields?.["Work Order Details"]?.date_issued?.value, currentPdf.processedAt) : null;
                urgencyExplanation.innerHTML = renderUrgencyNote(normalizedUrgency, responseInfo);
            }

            const urgencyIndicatorEl = document.querySelector('.quick-review-urgency .urgency-indicator');
            if (urgencyIndicatorEl) {
                urgencyIndicatorEl.classList.remove('critical', 'urgent', 'standard');
                urgencyIndicatorEl.classList.add(newUrgency.toLowerCase());
                urgencyIndicatorEl.innerHTML = `<span class="urgency-dot"></span>${newUrgency.toUpperCase()}`;
            }
        }

        function formatStatusMeta(meta) {
            if (!meta) return '';
            const parts = [];
            if (meta.user) {
                parts.push(meta.user);
            }
            if (meta.timestamp) {
                const date = new Date(meta.timestamp);
                if (!isNaN(date.getTime())) {
                    parts.push(date.toLocaleString());
                }
            }
            return parts.join(' ‚Ä¢ ');
        }
        function renderUrgencyNote(urgency, responseInfo) {
            const baseMessage = getUrgencyExplanation(urgency);
            if (!responseInfo) {
                return baseMessage;
            }

            const status = responseInfo.status || 'on-time';
            if (status === 'overdue') {
                return `<em>${baseMessage}</em><br/><strong>‚ö† Overdue:</strong> escalate immediately; coordinate with the site contact for out-of-hours access.`;
            }

            if (status === 'warning') {
                return `<em>${baseMessage}</em><br/><strong>‚è≥ Limited window:</strong> schedule within the remaining time or renegotiate.`;
            }

            return `<em>${baseMessage}</em><br/>On track; confirm scheduling before the target window closes.`;
        }

        function classifyDocumentType(workOrder) {
            const documentType = workOrder.document_type?.value?.toLowerCase() || '';
            const orderNumber = workOrder.order_number?.value || '';

            // Map different business terminology to standard types
            const quoteKeywords = [
                'quote request', 'quote', 'quotation', 'estimate', 'proposal', 'pricing request'
            ];

            const workOrderKeywords = [
                'work order', 'purchase order', 'job card', 'service request', 'work request'
            ];

            // Check document type field first
            if (quoteKeywords.some(keyword => documentType.includes(keyword))) {
                return 'QUOTE';
            }

            if (workOrderKeywords.some(keyword => documentType.includes(keyword))) {
                return 'WORK ORDER';
            }

            // Fallback: check order number patterns
            if (orderNumber.toLowerCase().startsWith('qr')) {
                return 'QUOTE';
            } else if (orderNumber.toLowerCase().startsWith('po') || orderNumber.toLowerCase().startsWith('job')) {
                return 'WORK ORDER';
            }

            // Default fallback
            return 'WORK ORDER';
        }

        function extractTradesAndScope(description) {
            const desc = description.toLowerCase();
            const trades = [];
            const scope = [];

            // Common trades mapping
            const tradeKeywords = {
                'electrical': ['electrical', 'electric', 'power', 'lighting', 'wiring', 'switchboard', 'cable'],
                'plumbing': ['plumbing', 'plumber', 'pipe', 'water', 'drainage', 'leak', 'tap', 'toilet'],
                'carpentry': ['carpentry', 'carpenter', 'timber', 'wood', 'framing', 'deck', 'cabinet'],
                'roofing': ['roof', 'roofing', 'guttering', 'tiles', 'iron', 'flashing'],
                'painting': ['paint', 'painting', 'primer', 'coating'],
                'flooring': ['floor', 'flooring', 'carpet', 'tiles', 'vinyl', 'timber floor'],
                'glazing': ['glass', 'window', 'glazing', 'mirror'],
                'HVAC': ['air conditioning', 'heating', 'cooling', 'ventilation', 'hvac'],
                'solar': ['solar', 'panel', 'inverter', 'battery'],
                'security': ['security', 'alarm', 'camera', 'access control'],
                'fire safety': ['fire', 'smoke detector', 'sprinkler', 'fire safety', 'extinguisher']
            };

            // Scope keywords (order matters - more specific first)
            const scopeKeywords = {
                'assessment': ['assess', 'assessment', 'inspect', 'inspection', 'investigate', 'attend site to assess'],
                'install': ['install', 'installation', 'fit', 'mount', 'supply and install'],
                'repair': ['repair', 'fix', 'restore', 'mend'],
                'replace': ['replace', 'replacement', 'substitute'],
                'maintenance': ['maintain', 'maintenance', 'service', 'check'],
                'upgrade': ['upgrade', 'improve', 'modernize'],
                'removal': ['remove', 'removal', 'demolish', 'take out'],
                'cleaning': ['cleaning', 'clean ', 'wash', ' clean', 'carpet cleaning'],
                'testing': ['test', 'testing', 'certification', 'compliance']
            };

            // Find trades
            for (const [trade, keywords] of Object.entries(tradeKeywords)) {
                if (keywords.some(keyword => desc.includes(keyword))) {
                    trades.push(trade);
                }
            }

            // Find scope (avoid duplicates and false positives)
            for (const [scopeType, keywords] of Object.entries(scopeKeywords)) {
                const found = keywords.some(keyword => {
                    // Use more precise matching to avoid false positives
                    if (keyword.includes(' ')) {
                        return desc.includes(keyword);
                    } else {
                        // For single words, check word boundaries
                        const regex = new RegExp(`\\b${keyword}\\b`, 'i');
                        return regex.test(desc);
                    }
                });
                if (found && !scope.includes(scopeType)) {
                    scope.push(scopeType);
                }
            }

            return { trades, scope };
        }

        function generateWorkScope(workOrder, parsedFields) {
            const description = workOrder.job_description?.value || '';
            const location = parsedFields["Job Location"] || {};

            // Extract trades and scope
            const { trades, scope } = extractTradesAndScope(description);

            // Determine location type
            const address = location.site_address?.value || '';
            const desc = description.toLowerCase();
            let locationType = '';

            if (desc.includes('health centre') || desc.includes('hospital') || desc.includes('medical')) {
                locationType = 'Healthcare facility';
            } else if (desc.includes('farm') || desc.includes('rural') || desc.includes('shed')) {
                locationType = 'Rural/Farm property';
            } else if (desc.includes('office') || desc.includes('commercial') || desc.includes('business')) {
                locationType = 'Commercial property';
            } else if (desc.includes('school') || desc.includes('education')) {
                locationType = 'Educational facility';
            } else if (address.includes('st') || address.includes('street') || address.includes('ave')) {
                locationType = 'Residential property';
            }

            // Generate brief work scope
            let workScope = '';

            // Check if this is an assessment/inspection vs actual work
            const isAssessment = desc.includes('assess') || desc.includes('inspection') || desc.includes('report') || desc.includes('investigate');

            if (trades.length > 2) {
                workScope = `Multiple trades including ${trades.slice(0, 2).join(', ')}`;
            } else if (trades.length > 1) {
                if (isAssessment) {
                    workScope = `${trades.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(' & ')} assessment`;
                } else {
                    workScope = `${trades.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(' & ')} work`;
                }
            } else if (trades.length === 1) {
                if (isAssessment) {
                    workScope = `${trades[0].charAt(0).toUpperCase() + trades[0].slice(1)} assessment`;
                } else {
                    workScope = `${trades[0].charAt(0).toUpperCase() + trades[0].slice(1)} work`;
                }
            } else {
                // Use work type but modify if it's an assessment
                const workType = workOrder.work_type?.value || 'General trade work';
                if (isAssessment && !workType.toLowerCase().includes('assessment')) {
                    workScope = workType.replace(/work$/i, 'assessment').replace(/repair$/i, 'assessment');
                } else {
                    workScope = workType;
                }
            }

            if (locationType) {
                workScope += ` ‚Ä¢ ${locationType}`;
            }

            return workScope;
        }

        function generateJobSummaryFromDescription(workOrder, parsedFields) {
            const fullDescription = workOrder.job_description?.value || 'No job description provided';

            if (fullDescription === 'No job description provided') {
                return fullDescription;
            }

            const desc = fullDescription.toLowerCase();

            // Create intelligent summary based on the content
            if (desc.includes('asbestos') && desc.includes('roof')) {
                return 'Complete asbestos removal and roof replacement project including scaffolding, electrical antenna refit, builders cleaning, and waste disposal. Requires clearance certificates and lab testing for ACM materials.';
            } else if (desc.includes('storm damage') && desc.includes('assess')) {
                return 'Storm damage assessment of electrical appliances (chest freezer and dishwasher) damaged during electrical storm.';
            } else if (desc.includes('multi-trade') || (desc.includes('electrical') && desc.includes('carpentry'))) {
                return 'Multi-trade project involving electrical, carpentry, and general repair work including wall sheets, carpet cleaning, and downlights.';
            } else if (desc.includes('refreshments') && desc.includes('television')) {
                return 'Electrical repair work to investigate and fix non-operating television screen (refreshment screen number 3) located in refreshments area.';
            } else if (desc.includes('armoured cable') && desc.includes('shed')) {
                return 'Electrical installation work to supply and install heavy-duty armoured cable for shed power connection.';
            } else if (desc.includes('fire safety') && desc.includes('inspection')) {
                return 'Annual fire safety inspection and testing of building safety systems.';
            } else {
                // Generic summary for other descriptions
                const sentences = fullDescription.split(/[.!?]+/).filter(s => s.trim().length > 10);
                if (sentences.length > 0) {
                    const firstSentence = sentences[0].trim();
                    return firstSentence.length > 150 ? firstSentence.substring(0, 147) + '...' : firstSentence + '.';
                } else {
                    return fullDescription.length > 150 ? fullDescription.substring(0, 147) + '...' : fullDescription;
                }
            }
        }

        function generateJobSummary(workOrder, sourceCompany, parsedFields) {
            const docType = classifyDocumentType(workOrder);
            const orderNumber = workOrder.order_number?.value || 'No ID';
            const description = workOrder.job_description?.value || 'No description provided';
            const workType = workOrder.work_type?.value || '';

            // Get company from company tables
            const identifiedCompany = identifyCompany(parsedFields);
            const companyName = identifiedCompany ? identifiedCompany.name : (sourceCompany.company_name?.value || 'Unknown Company');

            // Generate work scope summary for decision-making
            const workScope = generateWorkScope(workOrder, parsedFields);

            // Create contextual, informative job summary
            const desc = description.toLowerCase();
            let jobSummary = '';

            // Commercial fire safety (like health centres)
            if (desc.includes('fire safety') && (desc.includes('health centre') || desc.includes('cessnock') || desc.includes('building safety systems'))) {
                jobSummary = 'Commercial fire safety inspection - Health facility';
            }
            // Multi-trade storm damage projects
            else if (desc.includes('storm damage') && (desc.includes('wall sheets') || desc.includes('carpet') || desc.includes('electrical'))) {
                jobSummary = 'Multi-trade storm damage repairs';
            }
            // Storm damage assessment
            else if (desc.includes('storm damage') && desc.includes('assess')) {
                jobSummary = 'Storm damage electrical assessment';
            }
            // Armoured cable installations
            else if (desc.includes('armoured cable') || (desc.includes('cable') && desc.includes('shed'))) {
                jobSummary = 'Heavy-duty electrical installation';
            }
            // Multi-trade construction/renovation
            else if ((desc.includes('carpentry') && desc.includes('electrical') && desc.includes('roof')) ||
                     (desc.includes('wall sheets') && desc.includes('carpet') && desc.includes('electrical'))) {
                jobSummary = 'Multi-trade construction project';
            }
            // Electrical repairs
            else if (desc.includes('electrical') && (desc.includes('repair') || desc.includes('not operating'))) {
                jobSummary = 'Electrical fault diagnosis & repair';
            }
            // Standard assessments
            else if (desc.includes('assess') && desc.includes('electrical')) {
                jobSummary = 'Electrical damage assessment';
            }
            // Fire safety general
            else if (desc.includes('fire safety') || desc.includes('fire')) {
                jobSummary = 'Fire safety inspection & testing';
            }
            // Fallback to extracted trades/scope
            else {
                const { trades, scope } = extractTradesAndScope(description);
                if (trades.length > 2) {
                    jobSummary = `Multi-trade project (${trades.length} trades)`;
                } else if (trades.length > 0) {
                    jobSummary = trades.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(' & ');
                    if (scope.length > 0) {
                        jobSummary += ` - ${scope.slice(0, 2).join(' & ')}`;
                    }
                } else {
                    jobSummary = workType || 'General trade work';
                }
            }

            const shortDescription = description.length > 120 ?
                description.substring(0, 120) + '...' : description;

            const generatedJobId = parsedFields['ServiceM8 API Fields']?.generated_job_id?.value || '';

            return {
                type: docType,
                title: `${docType}: ${companyName}`,
                reference: orderNumber,
                description: workScope,
                fullDescription: description,
                jobSummary: jobSummary,
                jobNumber: generatedJobId || null
            };
        }

        function generateTimeConstraints(workOrder, parsedFields) {
            const dateIssued = workOrder.date_issued?.value;
            const description = workOrder.job_description?.value || '';

            let constraints = [];

            if (dateIssued) {
                constraints.push(`Issued: ${dateIssued}`);
            }

            // Enhanced AI extraction of time-related information
            const timePatterns = [
                { pattern: /(?:within|by|before|deadline|due)\s+(\d+\s*(?:hours?|days?|weeks?))/gi, type: 'deadline' },
                { pattern: /(?:asap|urgent|emergency|immediately|same\s+day)/gi, type: 'urgent' },
                { pattern: /(?:next\s+(?:business\s+)?day|tomorrow)/gi, type: 'next_day' },
                { pattern: /(?:business\s+hours?|9\s*-?\s*5|working\s+hours?)/gi, type: 'business_hours' }
            ];

            let urgencyFactors = [];
            timePatterns.forEach(({pattern, type}) => {
                const matches = description.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        switch(type) {
                            case 'deadline':
                                constraints.push(`‚è∞ ${match}`);
                                break;
                            case 'urgent':
                                urgencyFactors.push(`üö® ${match.toUpperCase()}`);
                                break;
                            case 'next_day':
                                constraints.push(`üìÜ ${match}`);
                                break;
                            case 'business_hours':
                                constraints.push(`üïò ${match}`);
                                break;
                        }
                    });
                }
            });

            // Work type analysis
            const workType = workOrder.work_type?.value || '';
            if (workType.toLowerCase().includes('emergency')) {
                urgencyFactors.push('üö® Emergency response required');
            } else if (workType.toLowerCase().includes('assessment')) {
                constraints.push('üìã Assessment - flexible scheduling');
            }

            // Combine all factors
            const allConstraints = [...constraints, ...urgencyFactors];
            return allConstraints.length > 0 ? allConstraints.join('<br>') : 'üìã Standard scheduling - no urgent constraints';
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function calculateResponseTime(urgency, dateIssued, processedAt) {
            const now = new Date();
            const pdfReceived = processedAt instanceof Date ? processedAt : new Date(processedAt);

            // Check if pdfReceived is a valid date
            if (isNaN(pdfReceived.getTime())) {
                return {
                    display: 'Unknown',
                    subtitle: 'Invalid timestamp',
                    status: 'warning'
                };
            }

            const timeSinceReceived = now - pdfReceived;

            // Normalize urgency to uppercase
            const normalizedUrgency = urgency ? urgency.toUpperCase() : 'STANDARD';

            // Business rules for response times based on urgency
            const responseRules = {
                'CRITICAL': {
                    targetHours: 1,
                    maxHours: 2,
                    businessHours: false // 24/7 response
                },
                'URGENT': {
                    targetHours: 4,
                    maxHours: 8,
                    businessHours: false // Same day response
                },
                'STANDARD': {
                    targetHours: 24,
                    maxHours: 48,
                    businessHours: true // Next business day
                }
            };

            const rule = responseRules[normalizedUrgency] || responseRules['STANDARD'];
            const hoursElapsed = timeSinceReceived / (1000 * 60 * 60);

            // Calculate deadline based on when PDF was received
            let deadline = new Date(pdfReceived);
            if (rule.businessHours) {
                // For standard jobs, next business day by 5 PM
                deadline = getNextBusinessDay(pdfReceived);
                deadline.setHours(17, 0, 0, 0); // 5 PM
            } else {
                // For urgent/critical, add target hours directly
                deadline.setHours(deadline.getHours() + rule.targetHours);
            }

            const timeToDeadline = deadline - now;
            const hoursToDeadline = timeToDeadline / (1000 * 60 * 60);

            // Validate calculated values
            if (isNaN(hoursToDeadline) || isNaN(hoursElapsed) || isNaN(deadline.getTime())) {
                return {
                    display: 'Error',
                    subtitle: 'Calculation error',
                    status: 'warning'
                };
            }

            // Determine status and display
            let status, display, subtitle;

            if (hoursToDeadline <= 0) {
                status = 'overdue';
                display = 'OVERDUE';
                subtitle = `Due ${formatRelativeDate(deadline)}`;
            } else if (hoursElapsed > rule.targetHours) {
                status = 'warning';
                display = Math.ceil(hoursToDeadline) + 'h remaining';
                subtitle = 'Approaching deadline';
            } else {
                status = 'on-time';
                if (hoursToDeadline > 24) {
                    display = Math.ceil(hoursToDeadline / 24) + ' days';
                } else {
                    display = Math.ceil(hoursToDeadline) + 'h remaining';
                }
                subtitle = `Due ${formatDateTime(deadline)}`;
            }

            return {
                display: display,
                subtitle: subtitle,
                status: status,
                deadline: deadline,
                hoursElapsed: hoursElapsed
            };
        }

        function getNextBusinessDay(date) {
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);

            // If it's Saturday (6) or Sunday (0), move to Monday
            if (nextDay.getDay() === 6) {
                nextDay.setDate(nextDay.getDate() + 2);
            } else if (nextDay.getDay() === 0) {
                nextDay.setDate(nextDay.getDate() + 1);
            }

            return nextDay;
        }

        function formatDateTime(date) {
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Helper functions for tradesperson decision-making
        function extractExplicitHours(description) {
            const desc = description?.toLowerCase() || '';

            // Only extract hours if explicitly mentioned in the PDF
            const hourPatterns = [
                /(\d+(?:\.\d+)?)\s*(?:to\s+|[-‚Äì])\s*(\d+(?:\.\d+)?)\s*hours?/gi,
                /(\d+(?:\.\d+)?)\s*hours?\s*(?:to\s+|[-‚Äì])\s*(\d+(?:\.\d+)?)\s*hours?/gi,
                /estimated?\s*(\d+(?:\.\d+)?)\s*(?:to\s+|[-‚Äì])\s*(\d+(?:\.\d+)?)\s*hours?/gi,
                /approximately\s*(\d+(?:\.\d+)?)\s*hours?/gi,
                /about\s*(\d+(?:\.\d+)?)\s*hours?/gi,
                /(\d+(?:\.\d+)?)\s*hour\s*job/gi
            ];

            for (const pattern of hourPatterns) {
                const matches = desc.match(pattern);
                if (matches) {
                    const match = matches[0];
                    const rangeMatch = match.match(/(\d+(?:\.\d+)?)\s*(?:to\s+|[-‚Äì])\s*(\d+(?:\.\d+)?)/);
                    if (rangeMatch) {
                        return `${rangeMatch[1]}-${rangeMatch[2]}`;
                    } else {
                        const singleMatch = match.match(/(\d+(?:\.\d+)?)/);
                        if (singleMatch) {
                            return singleMatch[1];
                        }
                    }
                }
            }

            // Return null if no explicit hours found
            return null;
        }

        function assessJobValue(workOrder) {
            const totalAmount = workOrder.total_amount?.value;
            const workLimit = workOrder.work_limit?.value;
            const documentType = workOrder.document_type?.value;
            const workType = workOrder.work_type?.value;
            const description = workOrder.job_description?.value || '';

            // Check if there's an actual dollar value
            const dollarValue = totalAmount || workLimit;
            if (dollarValue && dollarValue !== '$0.00' && dollarValue !== '0') {
                const numericValue = parseFloat(dollarValue.replace(/[^0-9.]/g, ''));
                if (numericValue > 0) {
                    return {
                        display: dollarValue,
                        status: 'confirmed',
                        subtitle: 'Pre-approved amount'
                    };
                }
            }

            // For quotes/assessments - estimate potential value
            if (documentType?.includes('Quote') || documentType?.includes('Assessment')) {
                const estimatedValue = estimateJobValue(workType, description);
                return {
                    display: estimatedValue.range,
                    status: 'estimated',
                    subtitle: 'Quote needed'
                };
            }

            // For work orders without scope - determine next action
            const nextAction = determineNextAction(workOrder, description);
            return {
                display: 'TBD',
                status: 'unscoped',
                subtitle: nextAction
            };
        }

        function determineNextAction(workOrder, description) {
            const desc = description.toLowerCase();
            const workType = workOrder.work_type?.value?.toLowerCase() || '';
            const contact = workOrder.contact || {};

            // Assessment/inspection jobs usually need site visit
            if (workType.includes('assessment') || workType.includes('inspection')) {
                return 'Site visit required for quote';
            }

            // Storm damage often needs inspection first
            if (desc.includes('storm damage') || desc.includes('damage')) {
                return 'Damage assessment needed';
            }

            // Installation work can often be quoted remotely
            if (workType.includes('installation') || desc.includes('install')) {
                return 'Contact client for specifications';
            }

            // Repair work may need diagnosis
            if (workType.includes('repair') || desc.includes('repair') || desc.includes('not working')) {
                return 'Diagnostic visit required';
            }

            // Emergency work - price discussion after resolution
            if (desc.includes('emergency') || desc.includes('urgent')) {
                return 'Quote after emergency resolution';
            }

            // Check if specific contact mentioned
            if (desc.includes('contact') || desc.includes('call') || desc.includes('discuss')) {
                // Extract contact name if possible
                const contactMatch = desc.match(/contact\s+(\w+)/i);
                if (contactMatch) {
                    return `Contact ${contactMatch[1]} to discuss budget`;
                }
                return 'Contact client to discuss budget';
            }

            // Default action
            return 'Quote/scope discussion needed';
        }

        function estimateJobValue(workType, description) {
            const type = workType?.toLowerCase() || '';
            const desc = description?.toLowerCase() || '';

            // Only provide estimates when we have sufficient detail and confidence

            // Specific installations with clear scope
            if (desc.includes('supply and install 10m of 25mm¬≤ armoured cable')) {
                return { range: '$2000-3500', confidence: 'medium' };
            }

            // Simple electrical assessments with clear scope
            if (desc.includes('assess x1 chest freezer and dishwasher')) {
                return { range: '$400-800', confidence: 'medium' };
            }

            // TV repair with work limit specified
            if (desc.includes('tv screen not operating') && desc.includes('investigate and repair')) {
                return { range: '$200-300', confidence: 'medium' };
            }

            // For complex or vague descriptions, don't guess
            if (type.includes('multi-trade') ||
                desc.includes('general repairs') ||
                desc.includes('building safety systems') ||
                desc.includes('multiple') ||
                (desc.includes('electrical') && (desc.includes('carpet') || desc.includes('roof') || desc.includes('wall sheets')))) {
                return { range: 'Requires detailed scope', confidence: 'insufficient_detail' };
            }

            // Fire safety inspections - too variable without knowing facility size/complexity
            if (type.includes('safety') || type.includes('inspection') || desc.includes('fire safety')) {
                return { range: 'Scope-dependent', confidence: 'insufficient_detail' };
            }

            // Default for unclear scope
            return { range: 'Quote required', confidence: 'insufficient_detail' };
        }

        function calculateJobEfficiency(jobValueInfo, explicitHours) {
            if (jobValueInfo.status === 'confirmed') {
                const value = parseFloat(jobValueInfo.display.replace(/[^0-9.]/g, '')) || 0;

                // Only calculate efficiency if hours are explicitly mentioned in PDF
                if (explicitHours) {
                    const hours = explicitHours.toString().split('-');
                    const minHours = parseFloat(hours[0]) || 1;
                    const maxHours = parseFloat(hours[1] || hours[0]) || 1;

                    // For large jobs, show daily rate instead of hourly
                    if (value > 5000) {
                        const days = Math.ceil(maxHours / 8); // Assume 8hr work days
                        return `~${days} days work (${explicitHours} hrs specified)`;
                    } else if (value > 1000) {
                        return `${explicitHours} hours specified`;
                    } else {
                        // Only show hourly rate for smaller jobs
                        const hourlyRate = Math.round(value / maxHours);
                        return `$${hourlyRate}/hr (${explicitHours} hrs specified)`;
                    }
                } else {
                    // No hours specified in PDF
                    return `${jobValueInfo.display} - Time not specified`;
                }
            } else if (jobValueInfo.status === 'estimated') {
                return explicitHours ? `${explicitHours} hours specified` : 'Time & value TBD';
            } else {
                return explicitHours ? `${explicitHours} hours specified` : 'Time & value TBD';
            }
        }

        function calculateAverageFromRange(range) {
            const matches = range.match(/\$(\d+)-(\d+)/);
            if (matches) {
                const min = parseInt(matches[1]);
                const max = parseInt(matches[2]);
                return (min + max) / 2;
            }
            return 0;
        }

        function estimateTravelDistance(address) {
            if (!address) return 'Unknown';

            // Driving distance calculations from Byron Bay (Suite 10/130 Jonson St, Byron Bay NSW 2481)
            const addressLower = address.toLowerCase();

            // Local Byron Bay area
            if (addressLower.includes('byron bay') || addressLower.includes('2481')) return '2-8 km';

            // Nearby towns - actual driving distances
            if (addressLower.includes('bangalow') || addressLower.includes('2479')) return '16 km';
            if (addressLower.includes('mullumbimby') || addressLower.includes('2482')) return '20 km';
            if (addressLower.includes('lennox head') || addressLower.includes('2478')) return '22 km';
            if (addressLower.includes('ballina') || addressLower.includes('2478')) return '35 km';
            if (addressLower.includes('uki') || addressLower.includes('2484')) return '38 km';
            if (addressLower.includes('lismore') || addressLower.includes('2480')) return '45 km';
            if (addressLower.includes('nimbin') || addressLower.includes('2480')) return '55 km';

            // Further locations - driving via highways
            if (addressLower.includes('murwillumbah') || addressLower.includes('2484')) return '60 km';
            if (addressLower.includes('tweed heads') || addressLower.includes('2485')) return '75 km';
            if (addressLower.includes('gold coast') || addressLower.includes('4217') || addressLower.includes('4218')) return '85 km';
            if (addressLower.includes('casino') || addressLower.includes('2470')) return '95 km';
            if (addressLower.includes('grafton') || addressLower.includes('2460')) return '140 km';

            // Default estimate for unknown locations
            return '~50 km';
        }

        function rejectJob(orderNumber) {
            alert(`Job ${orderNumber} declined. Reason will be logged.`);
            // TODO: integrate decline flow
        }

        function requestInfo(orderNumber) {
            const reason = prompt(`Request additional info for ${orderNumber || 'this job'}:\nDescribe what is missing or unclear.`);
            if (!reason) {
                return;
            }
            const key = orderNumber || `pdf-${Math.random().toString(36).slice(2)}`;
            statusState[key] = {
                status: 'info-requested',
                timestamp: new Date().toISOString(),
                user: getCurrentUserName(),
                note: reason
            };
            saveStatusState();
            applyStoredStatusToAll();
            generatePdfHistory();
            alert(`Info requested for ${orderNumber || 'job'}:\n${reason}`);
        }

        function createJob(orderNumber) {
            const key = orderNumber || `pdf-${Math.random().toString(36).slice(2)}`;
            const newJobNumber = prompt('Enter the confirmed job number (optional):', statusState[key]?.jobNumber || '');
            statusState[key] = {
                status: 'created',
                timestamp: new Date().toISOString(),
                user: getCurrentUserName(),
                jobNumber: newJobNumber || undefined
            };
            saveStatusState();
            applyStoredStatusToAll();
            generatePdfHistory();
            alert(`Job ${orderNumber} created and queued for scheduling.`);
            // TODO: trigger job creation logic
        }

        function toggleFullDetails() {
            const detailsSections = document.querySelectorAll('.field-section');
            detailsSections.forEach(section => {
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
            });
        }

        function generateParsedFields(parsedFields, pdf) {
            const parsedFieldsContent = document.getElementById('parsedFieldsContent');
            parsedFieldsContent.innerHTML = '';

            // Generate Quick Review section first
            generateQuickReview(parsedFields, pdf);

            const sectionNames = Object.keys(parsedFields);
            let sectionIndex = 0;

            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                const section = document.createElement('div');
                section.className = 'field-section';

                // Auto-expand first 3 sections, but keep Company Details collapsed
                if (sectionIndex >= 3 || sectionName === "Company Details") {
                    section.classList.add('collapsed');
                }

                section.setAttribute('data-section', sectionName);

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'field-section-title';
                sectionTitle.textContent = sectionName;

                // Add click handler for collapsible functionality
                sectionTitle.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                });

                section.appendChild(sectionTitle);
                sectionIndex++;

                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';

                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    // Skip technical/system fields that shouldn't be visible to users
                    if (fieldName === 'parsing_rules_applied') {
                        continue;
                    }

                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'field-item';

                    const label = document.createElement('div');
                    label.className = 'field-label';
                    label.textContent = formatFieldLabel(fieldName);

                    let input;
                    if (fieldData.type === 'select') {
                        input = document.createElement('select');
                        input.className = 'field-input field-select';

                        fieldData.options.forEach(optionValue => {
                            const option = document.createElement('option');
                            option.value = optionValue;
                            option.textContent = optionValue;
                            option.selected = optionValue === fieldData.value;
                            input.appendChild(option);
                        });

                        // Make ServiceM8 API Fields read-only
                        if (sectionName === 'ServiceM8 API Fields') {
                            input.disabled = true;
                            input.style.backgroundColor = '#f8f9fa';
                            input.style.cursor = 'not-allowed';
                            input.title = 'This field is automatically derived from other fields above';
                        }
                    } else if (fieldData.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.className = 'field-input field-textarea';
                        input.value = fieldData.value;
                    } else {
                        input = document.createElement('input');
                        input.className = 'field-input';
                        input.type = 'text';
                        input.value = fieldData.value;
                    }

                    // Make ServiceM8 API Fields read-only as they are derived from other fields
                    if (sectionName === 'ServiceM8 API Fields') {
                        input.readOnly = true;
                        input.style.backgroundColor = '#f8f9fa';
                        input.style.cursor = 'not-allowed';
                        input.title = 'This field is automatically derived from other fields above';
                    }

                    input.setAttribute('data-section', sectionName);
                    input.setAttribute('data-field', fieldName);

                    const confidenceSpan = document.createElement('div');
                    confidenceSpan.className = `field-confidence ${getConfidenceClass(fieldData.confidence)}`;
                    confidenceSpan.innerHTML = `
                        <div class="confidence-scale">
                            ${generateConfidenceScale(fieldData.confidence)}
                        </div>
                    `;

                    input.addEventListener('input', (e) => handleFieldChange(e, fieldData.value));

                    fieldItem.appendChild(label);
                    fieldItem.appendChild(input);
                    fieldItem.appendChild(confidenceSpan);
                    fieldGroup.appendChild(fieldItem);
                }

                section.appendChild(fieldGroup);
                parsedFieldsContent.appendChild(section);
            }
        }

        function formatFieldLabel(fieldName) {
            return fieldName
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 85) return 'high';
            if (confidence >= 70) return 'medium';
            return 'low';
        }

        function generateConfidenceScale(confidence) {
            const totalDots = 5;
            const filledDots = Math.round((confidence / 100) * totalDots);

            let dots = '';
            for (let i = 0; i < totalDots; i++) {
                const isFilled = i < filledDots;
                dots += `<span class="confidence-dot ${isFilled ? 'filled' : 'empty'}"></span>`;
            }

            return dots;
        }

        function handleFieldChange(event, originalValue) {
            const input = event.target;
            const currentValue = input.value;

            if (currentValue !== originalValue) {
                input.classList.add('modified');
                hasUnsavedChanges = document.querySelectorAll('.field-input.modified').length > 0;
            } else {
                input.classList.remove('modified');
                hasUnsavedChanges = document.querySelectorAll('.field-input.modified').length > 0;
            }

            updateChangesIndicator();
        }

        function updateChangesIndicator() {
            const changesIndicator = document.getElementById('changesIndicator');
            if (changesIndicator) {
                if (hasUnsavedChanges) {
                    changesIndicator.classList.add('show');
                } else {
                    changesIndicator.classList.remove('show');
                }
            }
        }

        function storeOriginalValues(parsedFields) {
            originalFieldValues = {};
            for (const [sectionName, fields] of Object.entries(parsedFields)) {
                originalFieldValues[sectionName] = {};
                for (const [fieldName, fieldData] of Object.entries(fields)) {
                    // Skip technical/system fields
                    if (fieldName === 'parsing_rules_applied') {
                        continue;
                    }
                    originalFieldValues[sectionName][fieldName] = fieldData.value;
                }
            }
        }

        function resetFields() {
            if (!currentPdfData) return;

            const inputs = document.querySelectorAll('.field-input');
            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');
                const originalValue = originalFieldValues[section][field];

                input.value = originalValue;
                input.classList.remove('modified');
            });

            hasUnsavedChanges = false;
            updateChangesIndicator();
        }

        function saveFields() {
            if (!currentPdfData || !hasUnsavedChanges) return;

            const inputs = document.querySelectorAll('.field-input.modified');
            const updates = {};

            inputs.forEach(input => {
                const section = input.getAttribute('data-section');
                const field = input.getAttribute('data-field');

                if (!updates[section]) {
                    updates[section] = {};
                }
                updates[section][field] = input.value;

                currentPdfData.parsedFields[section][field].value = input.value;
                input.classList.remove('modified');
            });

            storeOriginalValues(currentPdfData.parsedFields);
            hasUnsavedChanges = false;
            updateChangesIndicator();

            const jobId = currentPdfData.parsedFields['ServiceM8 API Fields']?.generated_job_id?.value ||
                         currentPdfData.parsedFields['Work Order Details']?.order_number?.value || 'New Job';
            const jobType = currentPdfData.parsedFields['Work Order Details']?.document_type?.value || 'Work Order';

            alert(`üöÄ ${jobType} "${jobId}" ready for ServiceM8!\n\nFields updated and ready to submit to ServiceM8 API.`);

            console.log('ServiceM8 Job Fields Updated:', updates);
        }

        function closePdfViewer() {
            if (hasUnsavedChanges) {
                const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
                if (!confirmClose) {
                    return;
                }
            }

            pdfViewerModal.classList.remove('show');
            setTimeout(() => {
                pdfViewerModal.style.display = 'none';
                document.body.style.overflow = '';
                originalPdfFrame.src = '';

                currentPdfData = null;
                originalFieldValues = {};
                hasUnsavedChanges = false;
                const parsedFieldsContent = document.getElementById('parsedFieldsContent');
                parsedFieldsContent.innerHTML = '';
            }, 300);
        }

        // Event listeners
        fabButton.addEventListener('click', openModal);
        modalClose.addEventListener('click', closeModal);
        pdfViewerClose.addEventListener('click', closePdfViewer);
        document.getElementById('saveFieldsBtn').addEventListener('click', saveFields);

        // Close modals when clicking outside
        pdfModal.addEventListener('click', (e) => {
            if (e.target === pdfModal) {
                closeModal();
            }
        });

        pdfViewerModal.addEventListener('click', (e) => {
            if (e.target === pdfViewerModal) {
                closePdfViewer();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (pdfViewerModal.classList.contains('show')) {
                    closePdfViewer();
                } else if (pdfModal.classList.contains('show')) {
                    closeModal();
                }
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            renderFilterState();
            generatePdfHistory();
        });
    </script>
</body>
</html>
